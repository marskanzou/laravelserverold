<?php

namespace App\Http\Controllers;
use Illuminate\Validation\Rule;
use Illuminate\Support\Facades\Log;
use PhpOffice\PhpSpreadsheet\IOFactory;
//use Maatwebsite\Excel\Facades\Excel;
//use App\Models\CustomFieldTranslation;
use Illuminate\Support\Facades\Mail;
use Illuminate\Support\Facades\Hash;
use App\Models\Banner;
use App\Http\Resources\ItemCollection;
use App\Models\Area;
use App\Models\BlockUser;
use App\Models\Blog;
use App\Models\Category;
use App\Models\Chat;
use App\Models\City;
use App\Models\ContactUs;
use App\Models\Country;
use App\Models\CustomField;
use App\Models\Faq;
use App\Models\Favourite;
use App\Models\FeaturedItems;
use App\Models\FeatureSection;
use App\Models\Item;
use App\Models\ItemCustomFieldValue;
use App\Models\ItemImages;
use App\Models\ItemOffer;
use App\Models\JobApplication;
use App\Models\Language;
use App\Models\Notifications;
use App\Models\NumberOtp;
use App\Models\Package;
use App\Models\PaymentConfiguration;
use App\Models\PaymentTransaction;
use App\Models\ReportReason;
use App\Models\SellerRating;
use App\Models\SeoSetting;
use App\Models\Setting;
use App\Models\Slider;
use App\Models\SocialLogin;
use App\Models\State;
use App\Models\Tip;
use App\Models\User;
use App\Models\UserFcmToken;
use App\Models\UserPurchasedPackage;
use App\Models\UserReports;
use App\Models\VerificationField;
use App\Models\VerificationFieldRequest;
use App\Models\VerificationFieldValue;
use App\Models\VerificationRequest;
use App\Services\CachingService;
use App\Services\FileService;
use App\Services\HelperService;
use App\Services\NotificationService;
use App\Services\Payment\PaymentService;
use App\Services\ResponseService;
use Carbon\Carbon;
use Illuminate\Database\Eloquent\Relations\MorphTo;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Storage;
use Illuminate\Support\Facades\Validator;
use Illuminate\Validation\Rules\Unique;
use Stichoza\GoogleTranslate\GoogleTranslate;
use Twilio\Rest\Client as TwilioRestClient;
use Illuminate\Support\Str;
use Throwable;
use App\Events\MessageSent;
use App\Jobs\ProcessItemMediaJob;

class ApiController extends Controller {

    private string $uploadFolder;

    public function __construct() {
        $this->uploadFolder = 'item_images';
        if (array_key_exists('HTTP_AUTHORIZATION', $_SERVER) && !empty($_SERVER['HTTP_AUTHORIZATION'])) {
            $this->middleware('auth:sanctum');
        }
    }

    public function getSystemSettings(Request $request) {
        try {
            $settings = Setting::select(['name', 'value', 'type']);

            if (!empty($request->type)) {
                $settings->where('name', $request->type);
            }

            $settings = $settings->get();

            foreach ($settings as $row) {
                if (in_array($row->name, ['account_holder_name','bank_name','account_number', 'ifsc_swift_code', 'bank_transfer_status','place_api_key'])) {
                    continue;
                }
                    $tempRow[$row->name] = $row->value;
            }
            $language = CachingService::getLanguages();
            $tempRow['demo_mode'] = config('app.demo_mode');
            $tempRow['languages'] = $language;
            $tempRow['admin'] = User::role('Super Admin')->select(['name', 'profile'])->first();
            ResponseService::successResponse(__('Data Fetched Successfully'), $tempRow);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> getSystemSettings");
            ResponseService::errorResponse();
        }
    }

public function forgetPassword(Request $request)
{
    try {
        $validator = Validator::make($request->all(), [
            'identifier' => 'required|string', // Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù…
        ]);

        if ($validator->fails()) {
            return ResponseService::validationError($validator->errors()->first());
        }

        $identifier = $request->input('identifier');

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (preg_match('/^\+?\d+$/', $identifier)) {
            $user = User::where('mobile', ltrim($identifier, '+'))->first();
        } else {
            $user = User::where('email', $identifier)->first();
        }

        if (!$user) {
            return ResponseService::errorResponse('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.');
        }

        // ØªÙˆÙ„ÙŠØ¯ OTP Ø¬Ø¯ÙŠØ¯
        $otp = rand(100000, 999999);
        $user->otp = $otp;
        $user->otp_expires_at = now()->addMinutes(10);
        $user->otp_attempts = 0;
        $user->is_verified = 0; // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ø¶Ù…Ø§Ù† OTP Ø¬Ø¯ÙŠØ¯
        $user->save();

        // Ø¥Ø±Ø³Ø§Ù„ OTP
        if (!empty($user->email)) {
            try {
                Mail::raw("Ø±Ù…Ø² Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±: $otp", function ($message) use ($user) {
                    $message->to($user->email)
                            ->subject('Ø±Ù…Ø² Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±');
                });
            } catch (\Exception $e) {
                \Log::error("Mail error: " . $e->getMessage());
            }
        } elseif (!empty($user->mobile)) {
            try {
                $apiUrl   = env('WHATSAPP_API_URL');
                $apiToken = env('WHATSAPP_API_TOKEN');
                Http::withToken($apiToken)->post($apiUrl . '/send-otp', [
                    'phone' => $user->mobile,
                    'otp'   => $otp,
                ]);
            } catch (\Exception $e) {
                \Log::error("WhatsApp error: " . $e->getMessage());
            }
        }

        return ResponseService::successResponse('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚.', [
            'identifier' => $identifier
        ]);

    } catch (Throwable $th) {
        ResponseService::logErrorResponse($th, "Password Controller -> forgetPassword");
        return ResponseService::errorResponse();
    }
}

public function resetPassword(Request $request)
{
    try {
        $validator = Validator::make($request->all(), [
            'identifier' => 'required|string', // Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ø£Ùˆ Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„
            'password'   => 'required|min:6|confirmed', // password + password_confirmation
        ]);

        if ($validator->fails()) {
            return ResponseService::validationError($validator->errors()->first());
        }

        $identifier = $request->input('identifier');

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        if (preg_match('/^\+?\d+$/', $identifier)) {
            $user = User::where('mobile', ltrim($identifier, '+'))->first();
        } else {
            $user = User::where('email', $identifier)->first();
        }

        if (!$user) {
            return ResponseService::errorResponse('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯.');
        }

        // Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªØ­Ù‚Ù‚ Ù…Ù† OTP Ù…Ø³Ø¨Ù‚Ø§Ù‹
        if (!$user->is_verified) {
            return ResponseService::errorResponse('ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø±Ù…Ø² Ø£ÙˆÙ„Ø§Ù‹.');
        }

        // ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        $user->password = Hash::make($request->password);
        $user->save();

        return ResponseService::successResponse('ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­.');

    } catch (Throwable $th) {
        ResponseService::logErrorResponse($th, "Password Controller -> resetPassword");
        return ResponseService::errorResponse();
    }
}


public function userSignup(Request $request) {
    try {
        $validator = Validator::make($request->all(), [
            'email'         => 'required|email',
            'password'      => 'required|min:6',
            'name'          => 'nullable|string',
            'fcm_id'        => 'nullable|string',
            'platform_type' => 'nullable|in:android,ios'
        ]);

        if ($validator->fails()) {
            return ResponseService::validationError($validator->errors()->first());
        }

        DB::beginTransaction();

        $user = User::withTrashed()->where('email', $request->email)->first();

        if ($user) {
            // âœ… Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙƒØ§Ù† "Ù…Ø­Ø°ÙˆÙ" Ø£Ùˆ ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„
            if ($user->deleted_at || !$user->is_verified) {
                // Ù†Ø¹ÙŠØ¯ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆÙ†Ø±Ø³Ù„ OTP Ø¬Ø¯ÙŠØ¯
                $otp = rand(100000, 999999);
                $user->otp = $otp;
                $user->otp_expires_at = now()->addMinutes(10);
                $user->deleted_at = null; // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø­Ø°Ù Ø§Ù„Ù…Ø¤Ù‚Øª
                $user->is_verified = 0;   // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø§Ù„Ø© Ù„ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„
                $user->save();

                // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯
                try {
                    Mail::raw("Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ùˆ: $otp", function ($message) use ($user) {
                        $message->to($user->email)
                                ->subject('Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ OTP');
                    });
                } catch (\Exception $e) {
                    \Log::error("Mail error: " . $e->getMessage());
                }

                DB::commit();
                return ResponseService::successResponse('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ù„Ø¥Ø¹Ø§Ø¯Ø© ØªÙØ¹ÙŠÙ„ Ø­Ø³Ø§Ø¨Ùƒ.', [
                    'email' => $user->email
                ]);
            }

            // âœ… Ø¥Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…ÙØ¹Ù„ Ø£Ø³Ø§Ø³Ù‹Ø§ (ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø¹Ø§Ø¯ÙŠ)
            if (!Hash::check($request->password, $user->password)) {
                DB::rollBack();
                return ResponseService::errorResponse('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©', 401);
            }

            if (!$user->hasRole('User')) {
                $user->assignRole('User');
            }

            Auth::login($user);

            if (!empty($request->fcm_id)) {
                UserFcmToken::updateOrCreate(
                    ['fcm_token' => $request->fcm_id],
                    [
                        'user_id' => $user->id,
                        'platform_type' => $request->platform_type,
                        'created_at' => now(),
                        'updated_at' => now()
                    ]
                );
            }

            $token = $user->createToken('auth_token')->plainTextToken;
            $userData = $user->makeHidden(['password', 'remember_token'])->toArray();

            DB::commit();
            return ResponseService::successResponse('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­', [
                'data' => $userData,
                'token' => $token
            ]);
        }

        // âœ… Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯ ØªÙ…Ø§Ù…Ù‹Ø§
        $name = $request->input('name') ?? explode('@', $request->email)[0];
        $otp = rand(100000, 999999);

        $user = User::create([
            'email'          => $request->email,
            'name'           => $name,
            'password'       => Hash::make($request->password),
            'is_verified'    => 0,
            'otp'            => $otp,
            'otp_expires_at' => now()->addMinutes(10)
        ]);

        $user->assignRole('User');

        try {
            Mail::raw("Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù‡Ùˆ: $otp", function ($message) use ($user) {
                $message->to($user->email)
                        ->subject('Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ OTP');
            });
        } catch (\Exception $e) {
            \Log::error("Mail error: " . $e->getMessage());
        }

        if (!empty($request->fcm_id)) {
            UserFcmToken::updateOrCreate(
                ['fcm_token' => $request->fcm_id],
                [
                    'user_id' => $user->id,
                    'platform_type' => $request->platform_type,
                    'created_at' => now(),
                    'updated_at' => now()
                ]
            );
        }

        DB::commit();
        return ResponseService::successResponse('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ Ø¨Ø±ÙŠØ¯Ùƒ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ.', [
            'email' => $user->email
        ]);

    } catch (Throwable $th) {
        DB::rollBack();
        ResponseService::logErrorResponse($th, "API Controller -> Signup");
        return ResponseService::errorResponse();
    }
}


    public function userSignupold(Request $request) {
        try {
            $validator = Validator::make($request->all(), [
                'type'          => 'required|in:email,google,phone,apple',
                'firebase_id'   => 'required',
                'country_code'  => 'nullable|string',
                'flag'          => 'boolean',
                'platform_type' => 'nullable|in:android,ios'
            ]);

            if ($validator->fails()) {
                ResponseService::validationError($validator->errors()->first());
            }

            $type = $request->type;
            $firebase_id = $request->firebase_id;
            $socialLogin = SocialLogin::where('firebase_id', $firebase_id)->where('type', $type)->with('user', function ($q) {
                $q->withTrashed();
            })->whereHas('user', function ($q) {
                $q->role('User');
            })->first();
            if (!empty($socialLogin->user->deleted_at)) {
                ResponseService::errorResponse(__('User is deactivated. Please Contact the administrator'));
            }
            if (empty($socialLogin)) {
                DB::beginTransaction();
                if ($request->type == "phone") {
                    $unique['mobile'] = $request->mobile;
                } else {
                    $unique['email'] = $request->email;
                }
                $existingUser = User::withTrashed()->where($unique)->first();

                if ($existingUser && $existingUser->trashed()) {
                    // DB::rollBack();
                    ResponseService::errorResponse(__('Your account has been deactivated.'), null, config('constants.RESPONSE_CODE.DEACTIVATED_ACCOUNT'));
                }
                $user = User::updateOrCreate([...$unique], [
                    ...$request->all(),
                    'profile' => $request->hasFile('profile') ? $request->file('profile')->store('user_profile', 'public') : $request->profile,
                ]);
                SocialLogin::updateOrCreate([
                    'type'    => $request->type,
                    'user_id' => $user->id
                ], [
                    'firebase_id' => $request->firebase_id,
                ]);
                $user->assignRole('User');
                Auth::login($user);
                $auth = User::find($user->id);
                DB::commit();
            } else {
                Auth::login($socialLogin->user);
                $auth = Auth::user();
            }
            if (!$auth->hasRole('User')) {
                ResponseService::errorResponse(__('Invalid Login Credentials'), null, config('constants.RESPONSE_CODE.INVALID_LOGIN'));
            }

            if (!empty($request->fcm_id)) {
//                UserFcmToken::insertOrIgnore(['user_id' => $auth->id, 'fcm_token' => $request->fcm_id, 'created_at' => Carbon::now(), 'updated_at' => Carbon::now()]);
                UserFcmToken::updateOrCreate(['fcm_token' => $request->fcm_id], ['user_id' => $auth->id, 'platform_type' => $request->platform_type, 'created_at' => Carbon::now(), 'updated_at' => Carbon::now()]);
            }

            if (!empty($request->registration)) {
                //If registration is passed then don't create token
                $token = null;
            } else {
                $token = $auth->createToken($auth->name ?? '')->plainTextToken;
            }

            ResponseService::successResponse(__('User logged-in successfully'), $auth, ['token' => $token]);
        } catch (Throwable $th) {
            DB::rollBack();
            ResponseService::logErrorResponse($th, "API Controller -> Signup");
            ResponseService::errorResponse();
        }
    }


public function updateProfile(Request $request) {
    try {
        $app_user = Auth::user();

        // ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ù‚Ù… Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¥Ø²Ø§Ù„Ø© ØµÙØ± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
        $mobile = $request->filled('mobile') ? ltrim($request->mobile, '0') : null;

        // Validator Ù…Ø¹ Ø§Ù„Ø±Ù‚Ù… Ø¨Ø¹Ø¯ ØªÙ†Ø¸ÙŠÙÙ‡
        $validator = Validator::make(
            array_merge($request->all(), ['mobile' => $mobile]),
            [
                'name'                  => 'nullable|string',
                'profile'               => 'nullable|mimes:jpg,jpeg,png|max:7168',
                'email'                 => [
                    'nullable',
                    'email',
                    Rule::unique('users', 'email')->ignore($app_user->id),
                ],
                'password'              => 'nullable|string|min:6', 
                'new_password'          => 'nullable|string|min:6', 
                'mobile'                => [
                    'nullable',
                    'string',
                    Rule::unique('users', 'mobile')->ignore($app_user->id),
                ],
                'country_code'          => 'nullable|string',
                'fcm_id'                => 'nullable',
                'address'               => 'nullable',
                'show_personal_details' => 'boolean',
            ],
            [
                'email.unique'  => 'Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„.',
                'mobile.unique' => 'Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Ù‚Ø¨Ù„.',
            ]
        );

        if ($validator->fails()) {
            return ResponseService::validationError($validator->errors()->first());
        }

        $data = [];

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù…
        if ($request->has('name')) {
            $data['name'] = $request->name;
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø¹ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
        if ($request->has('email')) {
            if ($app_user->type !== 'google') {
                if (!empty($app_user->password)) {
                    if (!$request->filled('password') || !Hash::check($request->password, $app_user->password)) {
                        return ResponseService::validationError('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.');
                    }
                } else {
                    if (!$request->filled('password')) {
                        return ResponseService::validationError('ÙŠØ¬Ø¨ Ø¥Ø¶Ø§ÙØ© ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø¬Ø¯ÙŠØ¯Ø©.');
                    }
                }
            }
            $data['email'] = $request->email;

            if ($request->filled('password')) {
                $data['password'] = Hash::make($request->password);
            }
        }

        // ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
        if ($request->filled('password') && $request->filled('new_password')) {
            if (empty($app_user->password) || Hash::check($request->password, $app_user->password)) {
                $data['password'] = Hash::make($request->new_password);
            } else {
                return ResponseService::validationError('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©.');
            }
        }

        // Ø±Ù‚Ù… Ø§Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„ ÙˆÙƒÙˆØ¯ Ø§Ù„Ø¯ÙˆÙ„Ø© Ø¨Ø¹Ø¯ ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø±Ù‚Ù…
        if ($mobile) {
            $data['mobile'] = $mobile;
            if ($request->has('country_code')) {
                $data['country_code'] = $request->country_code;
            }
        }

        // Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
        if ($request->has('address')) {
            $data['address'] = $request->address;
        }

        // Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø®ØµÙŠ
        if ($request->has('show_personal_details')) {
            $data['show_personal_details'] = $request->show_personal_details;
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙˆØ±Ø©
        if ($request->hasFile('profile')) {
            $data['profile'] = FileService::compressAndReplace(
                $request->file('profile'),
                'profile',
                $app_user->getRawOriginal('profile')
            );
        }

        // Ø¥Ø¯Ø§Ø±Ø© FCM Token
        if ($request->has('fcm_id') && !empty($request->fcm_id)) {
            UserFcmToken::updateOrCreate(
                ['fcm_token' => $request->fcm_id],
                [
                    'user_id'    => $app_user->id,
                    'created_at' => now(),
                    'updated_at' => now()
                ]
            );
        }

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ Ù‡Ù†Ø§Ùƒ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©
        if (!empty($data)) {
            $app_user->update($data);
            $app_user->refresh();
        }

        return ResponseService::successResponse(__('Profile Updated Successfully'), $app_user);

    } catch (Throwable $th) {
        ResponseService::logErrorResponse($th, 'API Controller -> updateProfile');
        return ResponseService::errorResponse();
    }
}

  public function updateProfileold(Request $request) {
        try {
            $validator = Validator::make($request->all(), [
                'name'                  => 'nullable|string',
                'profile'               => 'nullable|mimes:jpg,jpeg,png|max:7168',
                'email'                 => 'nullable|email|unique:users,email,' . Auth::user()->id,
                'mobile'                => 'nullable|unique:users,mobile,' . Auth::user()->id,
                'fcm_id'                => 'nullable',
                'address'               => 'nullable',
                'show_personal_details' => 'boolean',
                'country_code'          => 'nullable|string'
            ]);

            if ($validator->fails()) {
                ResponseService::validationError($validator->errors()->first());
            }

            $app_user = Auth::user();
            //Email should not be updated when type is google.
            $data = $app_user->type == "google" ? $request->except('email') : $request->all();

            if ($request->hasFile('profile')) {
                $data['profile'] = FileService::compressAndReplace($request->file('profile'), 'profile', $app_user->getRawOriginal('profile'));
            }

            if (!empty($request->fcm_id)) {
                UserFcmToken::updateOrCreate(['fcm_token' => $request->fcm_id], ['user_id' => $app_user->id, 'created_at' => Carbon::now(), 'updated_at' => Carbon::now()]);
            }
            $data['show_personal_details'] = $request->show_personal_details;

            $app_user->update($data);
            ResponseService::successResponse(__('Profile Updated Successfully'), $app_user);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, 'API Controller -> updateProfile');
            ResponseService::errorResponse();
        }
    }


 public function getPackage(Request $request) {
        $validator = Validator::make($request->toArray(), [
            'platform' => 'nullable|in:android,ios',
            'type'     => 'nullable|in:advertisement,item_listing'
        ]);
        if ($validator->fails()) {
            ResponseService::validationError($validator->errors()->first());
        }
        try {
            $packages = Package::where('status', 1);

            if (Auth::check()) {
                $packages = $packages->with('user_purchased_packages', function ($q) {
                    $q->onlyActive();
                });
            }

            if (isset($request->platform) && $request->platform == "ios") {
                $packages->whereNotNull('ios_product_id');
            }

            if (!empty($request->type)) {
                $packages = $packages->where('type', $request->type);
            }
            $packages = $packages->orderBy('id', 'ASC')->get();

            $packages->map(function ($package) {
                if (Auth::check()) {
                    $package['is_active'] = count($package->user_purchased_packages) > 0;
                } else {
                    $package['is_active'] = false;
                }
                return $package;
            });
            ResponseService::successResponse(__('Data Fetched Successfully'), $packages);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> getPackage");
            ResponseService::errorResponse();
        }
    }
  public function assignFreePackage(Request $request) {
        try {
            $validator = Validator::make($request->all(), [
                'package_id' => 'required|exists:packages,id',
            ]);

            if ($validator->fails()) {
                ResponseService::validationError($validator->errors()->first());
            }

            $user = Auth::user();

            $package = Package::where(['final_price' => 0, 'id' => $request->package_id])->firstOrFail();
            $activePackage = UserPurchasedPackage::where(['package_id' => $request->package_id, 'user_id' => Auth::user()->id])->first();
            if (!empty($activePackage)) {
                ResponseService::errorResponse(__('You already have purchased this package'));
            }

            UserPurchasedPackage::create([
                'user_id'     => $user->id,
                'package_id'  => $request->package_id,
                'start_date'  => Carbon::now(),
                'total_limit' => $package->item_limit == "unlimited" ? null : $package->item_limit,
                'end_date'    => $package->duration == "unlimited" ? null : Carbon::now()->addDays($package->duration)
            ]);
            ResponseService::successResponse(__('Package Purchased Successfully'));
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> assignFreePackage");
            ResponseService::errorResponse();
        }
    }


 public function getLimits(Request $request) {
        try {
            $validator = Validator::make($request->all(), [
                'package_type' => 'required|in:item_listing,advertisement',
            ]);
            if ($validator->fails()) {
                ResponseService::validationError($validator->errors()->first());
            }
            $setting = Setting::where('name', "free_ad_listing")->first()['value'];
            if ($setting == 1) {
                return ResponseService::successResponse(__('User is allowed to create Advertisement'));
            }
            $user_package = UserPurchasedPackage::onlyActive()->whereHas('package', function ($q) use ($request) {
                $q->where('type', $request->package_type);
            })->count();
            if ($user_package > 0) {
                ResponseService::successResponse(__('User is allowed to create Advertisement'));
            }
            ResponseService::errorResponse(__('User is not allowed to create Advertisement'), $user_package);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> getLimits");
            ResponseService::errorResponse();
        }
    }

public function upload(Request $request)
{
    $validator = Validator::make($request->all(), [
        'excel_file' => 'required|file|mimes:xlsx,xls',
        'images.*'   => 'nullable|file|mimes:jpg,jpeg,png,webp|max:7168',
        'selected_user_email' => 'required|email' // Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø°ÙŠ Ø­Ø¯Ø¯Ù‡ Ø§Ù„Ø£Ø¯Ù…ÙŠÙ†
    ]);

    if ($validator->fails()) {
        return ResponseService::validationError($validator->errors()->first());
    }

    $excel  = $request->file('excel_file');
    $images = $request->file('images', []);
    $selectedEmail = $request->input('selected_user_email');

    $user = User::where('email', $selectedEmail)->first();
    if (!$user) {
        return ResponseService::errorResponse("User not found with email: {$selectedEmail}");
    }

    try {
        $spreadsheet = \PhpOffice\PhpSpreadsheet\IOFactory::load($excel->getRealPath());
        $rows = $spreadsheet->getActiveSheet()->toArray();

        if (empty($rows) || count($rows) < 2) {
            return ResponseService::validationError('Excel file is empty or missing data rows.');
        }

        $header = array_map('trim', array_shift($rows));
        $success = 0;
        $fail = 0;
        $errors = [];

        DB::beginTransaction();

        foreach ($rows as $index => $row) {
            if (empty(array_filter($row))) continue;

            $data = array_combine($header, array_pad($row, count($header), null));

            try {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„ÙƒÙ„ ØµÙ
                $validator = Validator::make($data, [
                    'name'        => 'required',
                    'category_id' => 'required|integer',
                    'description' => 'required',
                    'latitude'    => 'required',
                    'longitude'   => 'required',
                    'address'     => 'required',
                    'contact'     => 'numeric|nullable',
                    'country'     => 'required',
                    'state'       => 'nullable',
                    'city'        => 'required',
                    'slug'        => 'nullable|regex:/^[a-z0-9-]+$/',
                ]);

                if ($validator->fails()) {
                    $fail++;
                    $errors[$index + 2] = $validator->errors()->first();
                    continue;
                }

                // Ø§Ù„ÙØ¦Ø©
                $category = Category::find($data['category_id']);
                if (!$category) {
                    $fail++;
                    $errors[$index + 2] = "Category not found: {$data['category_id']}";
                    continue;
                }

                $isJobCategory   = (bool) $category->is_job_category;
                $isPriceOptional = (bool) $category->price_optional;

                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø³Ø¹Ø± Ø£Ùˆ Ø§Ù„Ø±Ø§ØªØ¨
                if ($isJobCategory || $isPriceOptional) {
                    $priceValidator = Validator::make($data, [
                        'min_salary' => 'nullable|numeric|min:0',
                        'max_salary' => 'nullable|numeric|gte:min_salary',
                    ]);
                } else {
                    $priceValidator = Validator::make($data, [
                        'price' => 'required|numeric|min:0',
                    ]);
                }

                if ($priceValidator->fails()) {
                    $fail++;
                    $errors[$index + 2] = $priceValidator->errors()->first();
                    continue;
                }

                // Ø§Ù„Ø­Ø§Ù„Ø© Ùˆ slug
                $status = Setting::where('name','auto_approve_item')->value('value') == 1 ? 'approved' : 'review';
                $slug = $data['slug'] ?? Str::slug($data['name']);
                $uniqueSlug = HelperService::generateUniqueSlug(new Item(), $slug);

                // ØªØ­Ø¶ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
                $itemData = [
                    'name'        => $data['name'],
                    'category_id' => $data['category_id'],
                    'description' => $data['description'],
                    'latitude'    => $data['latitude'],
                    'longitude'   => $data['longitude'],
                    'address'     => $data['address'],
                    'country'     => $data['country'],
                    'state'       => $data['state'] ?? '',
                    'city'        => $data['city'],
                    'slug'        => $uniqueSlug,
                    'status'      => $status,
                    'active'      => 'deactive',
                    'user_id'     => $user->id, // ÙŠØ£ØªÙŠ Ù…Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø°ÙŠ Ø§Ø®ØªØ§Ø±Ù‡ Ø§Ù„Ø£Ø¯Ù…ÙŠÙ†
                    'contact'     => $data['contact'] ?? null,
                    'show_only_to_premium' => $data['show_only_to_premium'] ?? 0,
                ];

                if ($isJobCategory || $isPriceOptional) {
                    $itemData['min_salary'] = $data['min_salary'] ?? null;
                    $itemData['max_salary'] = $data['max_salary'] ?? null;
                } else {
                    $itemData['price'] = $data['price'] ?? null;
                }

                // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
                $item = Item::create($itemData);

                // Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
                if (!empty($data['image'])) {
                    $imageFile = collect($images)->first(function ($file) use ($data) {
                        return strtolower($file->getClientOriginalName()) === strtolower(trim($data['image']));
                    });

                    if ($imageFile) {
                        $item->update(['image' => FileService::compressAndUpload($imageFile, 'item_images')]);
                    }
                }

                // Ù…Ø¹Ø±Ø¶ Ø§Ù„ØµÙˆØ±
                if (!empty($data['gallery_images'])) {
                    $galleryFiles = json_decode($data['gallery_images'], true);
                    $galleryImages = [];

                    if (is_array($galleryFiles)) {
                        foreach ($galleryFiles as $imageName) {
                            $file = collect($images)->first(function ($img) use ($imageName) {
                                return strtolower($img->getClientOriginalName()) === strtolower(trim($imageName));
                            });

                            if ($file) {
                                $galleryImages[] = [
                                    'image'      => FileService::compressAndUpload($file, 'item_images'),
                                    'item_id'    => $item->id,
                                    'created_at' => now(),
                                    'updated_at' => now(),
                                ];
                            }
                        }
                    }

                    if (!empty($galleryImages)) {
                        ItemImages::insert($galleryImages);
                    }
                }

                // Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµØ© Ù…Ø¹ Ø¯Ø¹Ù… Ù„ØºØ© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø­Ø§Ù„ÙŠØ©
                if (!empty($data['custom_fields'])) {
                    $customFields = json_decode($data['custom_fields'], true);
                    $itemCustomFieldValues = [];
                    $currentLocale = app()->getLocale();

                    if (is_array($customFields)) {
                        foreach ($customFields as $key => $value) {
                            $customField = \App\Models\CustomField::with('translations.language')->find($key);
                            $translatedName = $customField?->translations
                                ->firstWhere(fn($t) => $t->language->code === $currentLocale)?->name
                                ?? $customField?->name
                                ?? 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';

                            $itemCustomFieldValues[] = [
                                'item_id'         => $item->id,
                                'custom_field_id' => $key,
                                'value'           => json_encode($value, JSON_THROW_ON_ERROR),
                                'created_at'      => now(),
                                'updated_at'      => now(),
                            ];
                        }
                    }

                    if (!empty($itemCustomFieldValues)) {
                        ItemCustomFieldValue::insert($itemCustomFieldValues);
                    }
                }

                $success++;
            } catch (\Throwable $th) {
                $fail++;
                $errors[$index + 2] = $th->getMessage();
            }
        }

        DB::commit();

        return ResponseService::successResponse('Excel uploaded successfully.', [
            'success' => $success,
            'fail'    => $fail,
            'errors'  => $errors,
        ]);
    } catch (\Throwable $th) {
        DB::rollBack();
        return ResponseService::errorResponse('Excel processing failed: ' . $th->getMessage());
    }
}


//public function addItem(Request $request)
//{
  //  try {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
    //    $validator = Validator::make($request->all(), [
      //      'name'                 => 'required',
        //    'category_id'          => 'required|integer',
          //  'description'          => 'required',
    //        'latitude'             => 'required',
      //      'longitude'            => 'required',
        //    'address'              => 'required',
          //  'contact'              => 'numeric',
            //'show_only_to_premium' => 'nullable|boolean',
  //          'gallery_images'       => 'nullable|array|min:1',
    //        'gallery_images.*'     => 'nullable|mimes:jpeg,png,jpg|max:7168',
      ///      'image'                => 'required|mimes:jpeg,png,jpg|max:7168',
         //   'country'              => 'required',
           // 'state'                => 'nullable',
  //          'city'                 => 'required',
        //    'custom_field_files'   => 'nullable|array',
      //      'custom_field_files.*' => 'nullable|mimes:jpeg,png,jpg,pdf,doc|max:7168',
    //        'slug'                 => 'nullable|regex:/^[a-z0-9-]+$/',
     //   ]);

       // if ($validator->fails()) {
    //        return ResponseService::validationError($validator->errors()->first());
      //  }

    //    $category = Category::findOrFail($request->category_id);
      //  $isJobCategory   = $category->is_job_category;
      //  $isPriceOptional = $category->price_optional;

        // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø±Ø§ØªØ¨ Ø£Ùˆ Ø§Ù„Ø³Ø¹Ø±
       // if ($isJobCategory || $isPriceOptional) {
        //    $validator = Validator::make($request->all(), [
             //   'min_salary' => 'nullable|numeric|min:0',
           //     'max_salary' => 'nullable|numeric|gte:min_salary',
         //   ]);
       // } else {
            //$validator = Validator::make($request->all(), [
          //      'price' => 'required|numeric|min:0',
        //    ]);
        //}

        //if ($validator->fails()) {
          //  return ResponseService::validationError($validator->errors()->first());
        //}

       // DB::beginTransaction();

        //$user = Auth::user();
        //$auto_approve_item = Setting::where('name', "auto_approve_item")->value('value') ?? 0;
        //$status = $auto_approve_item == 1 ? "approved" : "review";

        // slug
        //$slug = $request->input('slug') ?: HelperService::generateRandomSlug();
        //$uniqueSlug = HelperService::generateUniqueSlug(new Item(), $slug);

        // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
       // $data = [
            //'name'                 => $request->name,
           // 'category_id'          => $request->category_id,
            //'description'          => $request->description,
         //   'latitude'             => $request->latitude,
          //  'longitude'            => $request->longitude,
           // 'address'              => $request->address,
           // 'contact'              => $request->contact,
            //'show_only_to_premium' => $request->show_only_to_premium ?? 0,
            //'country'              => $request->country,
           // 'state'                => $request->state,
          //  'city'                 => $request->city,
         //   'slug'                 => $uniqueSlug,
         //   'status'               => $status,
          //  'active'               => "deactive",
          //  'user_id'              => $user->id,
        

        // Ø§Ù„Ø³Ø¹Ø± Ø£Ùˆ Ø§Ù„Ø±ÙˆØ§ØªØ¨
      //  if ($isJobCategory || $isPriceOptional) {
        //    $data['min_salary'] = $request->min_salary;
         //   $data['max_salary'] = $request->max_salary;
       // } else {
       //     $data['price'] = $request->price;
        //}

        // Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        //if ($request->hasFile('image')) {
          //  $data['image'] = FileService::compressAndUpload($request->file('image'), $this->uploadFolder);
        //}

        // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†
        //$item = Item::create($data);

        // ØµÙˆØ± Ø§Ù„Ù…Ø¹Ø±Ø¶
       // if ($request->hasFile('gallery_images')) {
         //   $galleryImages = [];
           // foreach ($request->file('gallery_images') as $file) {
             //   $galleryImages[] = [
               //     'image'      => FileService::compressAndUpload($file, $this->uploadFolder),
                 //   'item_id'    => $item->id,
                   // 'created_at' => now(),
                    //'updated_at' => now(),
               // ];
            //}
            //if (!empty($galleryImages)) {
              //  ItemImages::insert($galleryImages);
            //}
        //}

        // Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµØ©
        //if ($request->custom_fields) {
            //$itemCustomFieldValues = [];
            //foreach (json_decode($request->custom_fields, true, 512, JSON_THROW_ON_ERROR) as $key => $custom_field) {
                //$itemCustomFieldValues[] = [
                  //  'item_id'         => $item->id,
                //    'custom_field_id' => $key,
              //      'value'           => json_encode($custom_field, JSON_THROW_ON_ERROR),
            //        'created_at'      => now(),
          //          'updated_at'      => now()
            //    ];
          //  }
            //if (!empty($itemCustomFieldValues)) {
              //  ItemCustomFieldValue::insert($itemCustomFieldValues);
         //   }
        //}

        // Ù…Ù„ÙØ§Øª Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµØ©
        //if ($request->custom_field_files) {
            //$itemCustomFieldValues = [];
          //  foreach ($request->custom_field_files as $key => $file) {
                //$itemCustomFieldValues[] = [
                    //'item_id'         => $item->id,
                    //'custom_field_id' => $key,
                  //  'value'           => !empty($file) ? FileService::upload($file, 'custom_fields') : null,
                //    'created_at'      => now(),
              //      'updated_at'      => now()
            //    ];
          //  }
          //  if (!empty($itemCustomFieldValues)) {
            //    ItemCustomFieldValue::insert($itemCustomFieldValues);
            //}
        //}


        // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù…Ø¹ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª
     //   $result = Item::with(
            //'user:id,name,email,mobile,profile,country_code',
           // 'category:id,name,image,is_job_category,price_optional',
         //   'gallery_images:id,image,item_id',
          //  'featured_items',
          //  'favourites',
           // 'item_custom_field_values.custom_field',
          //  'area'
        //)->where('id', $item->id)->get();

        //$result = new ItemCollection($result);

  //      DB::commit();
    //    return ResponseService::successResponse("Advertisement Added Successfully (media is processing in background)", $result);

    //} catch (Throwable $th) {
      //  DB::rollBack();
        //ResponseService::logErrorResponse($th, "API Controller -> addItem");
        //return ResponseService::errorResponse();
  //  }
//}

  public function addItem(Request $request)
{
    try {
        $validator = Validator::make($request->all(), [
            'name'                 => 'required',
            'category_id'          => 'required|integer',
            'description'          => 'required',
            'latitude'             => 'required',
            'longitude'            => 'required',
            'address'              => 'required',
            'contact'              => 'numeric',
            'show_only_to_premium' => 'nullable|boolean',
            'gallery_images'       => 'nullable|array|min:1',
            'gallery_images.*'     => 'nullable|mimes:jpeg,png,jpg|max:7168',
            'image'                => 'required|mimes:jpeg,png,jpg|max:7168',
            'country'              => 'required',
            'state'                => 'nullable',
            'city'                 => 'required',
            // âœ… ØªØ¹Ø¯ÙŠÙ„: Ø§Ø³ØªØ¨Ø¯Ù„ country/state/city Ø¨Ù€ IDs
            //'country_id'           => 'required|integer|exists:countries,id',
            //'state_id'             => 'nullable|integer|exists:states,id',
            //'city_id'              => 'required|integer|exists:cities,id',
            'custom_field_files'   => 'nullable|array',
            'custom_field_files.*' => 'nullable|mimes:jpeg,png,jpg,pdf,doc|max:7168',
            'slug'                 => 'nullable|regex:/^[a-z0-9-]+$/',
        ]);

        if ($validator->fails()) {
            return ResponseService::validationError($validator->errors()->first());
        }

        $category = Category::findOrFail($request->category_id);
        $isJobCategory   = $category->is_job_category;
        $isPriceOptional = $category->price_optional;

        if ($isJobCategory || $isPriceOptional) {
            $validator = Validator::make($request->all(), [
                'min_salary' => 'nullable|numeric|min:0',
                'max_salary' => 'nullable|numeric|gte:min_salary',
            ]);
        } else {
            $validator = Validator::make($request->all(), [
                'price' => 'required|numeric|min:0',
            ]);
        }

        if ($validator->fails()) {
            return ResponseService::validationError($validator->errors()->first());
        }

        DB::beginTransaction();

        $user = Auth::user();
        $auto_approve_item = Setting::where('name', "auto_approve_item")->value('value') ?? 0;
        $status = $auto_approve_item == 1 ? "approved" : "review";

        $slug = $request->input('slug') ?: HelperService::generateRandomSlug();
        $uniqueSlug = HelperService::generateUniqueSlug(new Item(), $slug);
  
        // âœ… ØªØ¹Ø¯ÙŠÙ„: ØªØ¬Ù‡ÙŠØ² Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (ID Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù†Øµ)
        //$country = Country::find($request->country_id);
        //$state   = $request->state_id ? State::find($request->state_id) : null;
        //$city    = City::find($request->city_id);
      
        $data = [
            'name'        => $request->name,
            'category_id' => $request->category_id,
            'description' => $request->description,
            'latitude'    => $request->latitude,
            'longitude'   => $request->longitude,
            'address'     => $request->address,
            'contact'     => $request->contact,
            'show_only_to_premium' => $request->show_only_to_premium ?? 0,
            'country'     => $request->country,
            'state'       => $request->state,
            'city'        => $request->city,
            // âœ… ØªØ¹Ø¯ÙŠÙ„: Ù†Ø®Ø²Ù† Ø§Ù„Ù€ IDs Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
            // âœ… Ù†Ø­Ø§ÙØ¸ Ù…Ø¤Ù‚ØªÙ‹Ø§ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØµÙˆØµ Ù„Ø¹Ø¯Ù… ÙƒØ³Ø± Ø£ÙŠ ÙƒÙˆØ¯ Ø¢Ø®Ø± (Ù‚Ø¯ ÙŠØ³ØªØ®Ø¯Ù…Ù‡Ø§)
            //'country'     => $country ? ($country->name ?? $country->name ?? '') : '',
            //'state'       => $state ? ($state->name ?? $state->name ?? '') : '',
            //'city'        => $city ? ($city->name ?? $city->name ?? '') : '',
            //'country_id'  => $country ? $country->id : null,
            //'state_id'    => $state ? $state->id : null,
            //'city_id'     => $city ? $city->id : null,
            'slug'        => $uniqueSlug,
            'status'      => $status,
            'active'      => "deactive", // Ø³ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ Ø¨Ø¹Ø¯ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
            'user_id'     => $user->id,
        ];

        if ($isJobCategory || $isPriceOptional) {
            $data['min_salary'] = $request->min_salary;
            $data['max_salary'] = $request->max_salary;
        } else {
            $data['price'] = $request->price;
        }

       $allCategoryIds = $request->input('all_category_ids', null);

        if ($allCategoryIds) {
        // âœ… Ù„Ùˆ Ø£Ø±Ø³Ù„Ù‡Ø§ ÙƒÙ†Øµ "104,318" Ù†Ø­ÙˆÙ„Ù‡Ø§ Ù„Ù…ØµÙÙˆÙØ©
        if (is_string($allCategoryIds)) {
        // Ù†Ø­Ø§ÙˆÙ„ Ù†ÙØµÙ„Ù‡Ø§ Ø¨ÙÙˆØ§ØµÙ„
        $idsArray = array_filter(array_map('trim', explode(',', $allCategoryIds)));
        } elseif (is_array($allCategoryIds)) {
        $idsArray = $allCategoryIds;
        } else {
        $idsArray = [];
        }

        // âœ… Ù†Ø®Ø²Ù†Ù‡Ø§ ÙƒÙ†Øµ JSON
       $data['all_category_ids'] = json_encode($idsArray, JSON_UNESCAPED_UNICODE);
        }


        $item = Item::create($data);

        // ðŸ”¹ ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© (Ù†ÙØ³ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ÙƒÙ…Ø§ ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ)
        $payload = [
            'image' => null,
            'gallery_images' => [],
            'custom_field_files' => [],
        ];

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
        if ($request->hasFile('image')) {
            // Ø­ÙØ¸ Ø¹Ù„Ù‰ disk 'public' (shared symlink ÙŠØ¤Ø´Ø± Ù‡Ù†Ø§)
            $relative = $request->file('image')->store('temp_uploads', 'public');
            $payload['image'] = $relative;

            // ØªØ³Ø¬ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ØªØ­Ù‚Ù‚ (ØªØ¹Ø¯ÙŠÙ„: Ù„ÙˆÙ‚ ØªØ­Ù‚Ù‚ Ø§Ù„Ù…Ø³Ø§Ø± ÙˆØ§Ù„ÙˆØ¬ÙˆØ¯)
            \Log::info('âœ… Main image stored temporarily', [
                'relative' => $relative,
                'absolute' => Storage::disk('public')->path($relative),
                'exists'   => Storage::disk('public')->exists($relative),
            ]);
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© ØµÙˆØ± Ø§Ù„Ù…Ø¹Ø±Ø¶
        if ($request->hasFile('gallery_images')) {
            foreach ($request->file('gallery_images') as $file) {
                $relative = $file->store('temp_uploads', 'public');
                $payload['gallery_images'][] = $relative;

                \Log::info('âœ… Gallery image stored temporarily', [
                    'relative' => $relative,
                    'absolute' => Storage::disk('public')->path($relative),
                    'exists'   => Storage::disk('public')->exists($relative),
                ]);
            }
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„ÙØ§Øª Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµØ© (ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‡Ù…: Ø§Ø³ØªØ®Ø¯Ù…Ù†Ø§ hasFile)
        if ($request->hasFile('custom_field_files')) {
            foreach ($request->file('custom_field_files') as $key => $file) {
                if ($file) {
                    $relative = $file->store('temp_uploads', 'public');
                    // Ù†Ø­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙØªØ§Ø­ ÙƒÙ…Ø§ Ø£Ø±Ø³Ù„Ù‡ Ø§Ù„ÙÙˆØ±Ù… (ÙŠÙØ¶Ù‘Ù„ Ø£Ù† ÙŠÙƒÙˆÙ† ID Ø§Ù„Ø­Ù‚Ù„)
                    $payload['custom_field_files'][$key] = $relative;

                    \Log::info('âœ… Custom field file stored temporarily', [
                        'key' => $key,
                        'relative' => $relative,
                        'absolute' => Storage::disk('public')->path($relative),
                        'exists'   => Storage::disk('public')->exists($relative),
                    ]);
                }
            }
        }

        \Log::info('ðŸš€ Prepared payload for ProcessItemMediaJob', [
            'item_id' => $item->id,
            'has_image' => !is_null($payload['image']),
            'gallery_count' => count($payload['gallery_images']),
            'custom_fields_count' => count($payload['custom_field_files']),
        ]);

       // ==================== ðŸ”¹ Ø­ÙØ¸ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµØ© (custom_fields) Ø§Ù„Ù†ØµÙŠØ© ðŸ”¹ ====================
       try {
        $rawCustom = $request->input('custom_fields', null);
        $customFields = [];

       // âœ… Ø¯Ø¹Ù… Ù†ÙˆØ¹ÙŠÙ†: JSON string Ø£Ùˆ array Ù…Ø¨Ø§Ø´Ø±Ø© (Ù…Ù† form-data)
       if (!is_null($rawCustom)) {
           if (is_string($rawCustom)) {
               $decoded = json_decode($rawCustom, true);
              if (json_last_error() === JSON_ERROR_NONE && is_array($decoded)) {
                $customFields = $decoded;
           } else {
                \Log::warning('addItem: custom_fields JSON decode failed', [
                    'raw' => $rawCustom,
                    'error' => json_last_error_msg()
                 ]);
              }
           } elseif (is_array($rawCustom)) {
                $customFields = $rawCustom;
          }
       }

       if (!empty($customFields)) {
           $insertData = [];
           foreach ($customFields as $fieldId => $value) {
              $insertData[] = [
                'item_id'         => $item->id,
                'custom_field_id' => $fieldId,
                'value'           => json_encode($value, JSON_UNESCAPED_UNICODE),
                'created_at'      => now(),
                'updated_at'      => now(),
            ];
        }

        ItemCustomFieldValue::insert($insertData);
        \Log::info('âœ… addItem: custom_fields saved', [
            'item_id' => $item->id,
            'count' => count($insertData)
        ]);
      } else {
         \Log::info('â„¹ï¸ addItem: no custom_fields provided');
      }
      } catch (Throwable $e) {
       \Log::error('âŒ addItem: failed to save custom_fields', [
        'error' => $e->getMessage(),
        'trace' => $e->getTraceAsString()
         ]);
          }

        // ====== ØªØ¹Ø¯ÙŠÙ„ Ù…Ù‡Ù…: Ù†Ø¤ÙƒÙ‘Ø¯ Ø¹Ù„Ù‰ Ø­ÙØ¸ Ø§Ù„Ù€ item ÙÙŠ DB Ù‚Ø¨Ù„ dispatch
        DB::commit();

        // âœ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù€ Job Ø¨Ø¹Ø¯ commit (ØªØ¹Ø¯ÙŠÙ„ Ù„Ù…Ù†Ø¹ race conditions)
        ProcessItemMediaJob::dispatch($item->id, $payload)->onQueue('media');

        //return ResponseService::successResponse("Advertisement Added Successfully - Media queued for processing", [
          // 'item_id' => $item->id,
            //'status'  => $item->status
        //]);
       // âœ… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø±ÙŠØ³Ø¨ÙˆÙ†Ø³ Ø¨Ù†ÙØ³ Ø§Ù„Ø´ÙƒÙ„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„ÙŠØ³ØªÙ…Ø± Ø§Ù„ÙØ±ÙˆÙ†Øª Ø¨Ø§Ù„Ø¹Ù…Ù„ ÙƒÙ…Ø§ ÙƒØ§Ù†
       $result = Item::with(
          'user:id,name,email,mobile,profile,country_code',
          'category:id,name,image,is_job_category,price_optional',
          'gallery_images:id,image,item_id',
          'featured_items',
          'favourites',
          'item_custom_field_values.custom_field',
          'area'
        )->where('id', $item->id)->get();

       $result = new ItemCollection($result);

     return ResponseService::successResponse("Advertisement Added Successfully (media is processing in background)", $result);
    } catch (Throwable $th) {
        DB::rollBack();
        ResponseService::logErrorResponse($th, "API Controller -> addItem");
        return ResponseService::errorResponse();
    }
}



   public function getBanners(Request $request)
{
    $categoryId = $request->input('category_id');

    $banners = Banner::whereNotNull('image')
        ->when($categoryId, function ($query) use ($categoryId) {
            $query->where('category_id', $categoryId);
        })
        ->get();

    return $banners;
}

public function getItemsWithBanners(Request $request)
{
    try {
        // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
        $itemResponse = $this->getItem($request);
        $items = collect($itemResponse->original['data']);

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨Ù†Ø±Ø§Øª
        $categoryId = $request->input('category_id');

        $banners = Banner::whereNotNull('image')
            ->when($categoryId, function ($query) use ($categoryId) {
                // Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø±Ø± category_id Ù†Ø±Ø¬Ø¹ Ø¨Ø³ Ø§Ù„Ø¨Ù†Ø±Ø§Øª Ø§Ù„Ù„ÙŠ Ù„Ù‡Ø§ Ù†ÙØ³ Ø§Ù„ÙƒØ§ØªÙŠØ¬ÙˆØ±ÙŠ
                $query->where('category_id', $categoryId);
            })
            ->get();

        $finalList = [];
        $bannerIndex = 0;

        foreach ($items as $index => $item) {
            $finalList[] = [
                'type' => 'item',
                'data' => $item
            ];

            // Ø¥Ø¯Ø±Ø§Ø¬ Ø¨Ø§Ù†Ø± Ø¨Ø¹Ø¯ ÙƒÙ„ 6 Ø¥Ø¹Ù„Ø§Ù†Ø§Øª
            if (($index + 1) % 6 == 0 && isset($banners[$bannerIndex])) {
                $finalList[] = [
                    'type' => 'banner',
                    'data' => $banners[$bannerIndex]
                ];

                $bannerIndex++;
                if ($bannerIndex >= count($banners)) {
                    $bannerIndex = 0; // Ù†Ø±Ø¬Ø¹ Ù„Ø£ÙˆÙ„ Ø¨Ø§Ù†Ø± Ù„Ùˆ Ø®Ù„ØµÙˆØ§
                }
            }
        }

        return ResponseService::successResponse(
            'Items with banners fetched successfully',
            $finalList
        );

    } catch (Throwable $th) {
        ResponseService::logErrorResponse($th, "API Controller -> getItemsWithBanners");
        return ResponseService::errorResponse();
    }
}


protected function mergeItemsWithBanners($items, $banners)
{
    $finalList = [];
    $bannerIndex = 0;
    $bannerCount = $banners->count();

    foreach ($items as $index => $item) {
        $finalList[] = [
            'type' => 'item',
            'data' => $item
        ];

        // Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù†Ø± Ø¨Ø¹Ø¯ ÙƒÙ„ 6 Ø¹Ù†Ø§ØµØ±
        if (($index + 1) % 6 == 0 && $bannerCount > 0 && isset($banners[$bannerIndex])) {
            $finalList[] = [
                'type' => 'banner',
                'data' => $banners[$bannerIndex]
            ];

            $bannerIndex++;
            // Ù„Ø§ Ù†ÙƒØ³Ø± Ø§Ù„Ø­Ù„Ù‚Ø©ØŒ Ù†Ø³ØªÙ…Ø± Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø¹Ù†Ø§ØµØ±
        }
    }

    return $finalList;
}

 /*public function getItem(Request $request) {
        $validator = Validator::make($request->all(), [
            'limit'         => 'nullable|integer',
            'offset'        => 'nullable|integer',
            'id'            => 'nullable',
            'custom_fields' => 'nullable',
            'category_id'   => 'nullable',
            'user_id'       => 'nullable',
            'min_price'     => 'nullable',
            'max_price'     => 'nullable',
            'sort_by'       => 'nullable|in:new-to-old,old-to-new,price-high-to-low,price-low-to-high,popular_items',
            'posted_since'  => 'nullable|in:all-time,today,within-1-week,within-2-week,within-1-month,within-3-month'
        ]);

        if ($validator->fails()) {
            ResponseService::validationError($validator->errors()->first());
        }
        try {
            //TODO : need to simplify this whole module
            $sql = Item::with('user:id,name,email,mobile,profile,created_at,is_verified,show_personal_details,country_code', 'category:id,name,image,is_job_category,price_optional', 'gallery_images:id,image,item_id', 'featured_items', 'favourites', 'item_custom_field_values.custom_field', 'area:id,name','job_applications')
                ->withCount('featured_items')
                ->withCount('job_applications')
                ->select('items.*')
                ->when($request->id, function ($sql) use ($request) {
                    $sql->where('id', $request->id);
                })->when(($request->category_id), function ($sql) use ($request) {
                    $category = Category::where('id', $request->category_id)->with('children')->get();
                    $categoryIDS = HelperService::findAllCategoryIds($category);
                    return $sql->whereIn('category_id', $categoryIDS);
                })->when(($request->category_slug), function ($sql) use ($request) {
                    $category = Category::where('slug', $request->category_slug)->with('children')->get();
                    $categoryIDS = HelperService::findAllCategoryIds($category);
                    return $sql->whereIn('category_id', $categoryIDS);
                })->when((isset($request->min_price) || isset($request->max_price)), function ($sql) use ($request) {
                    $min_price = $request->min_price ?? 0;
                    $max_price = $request->max_price ?? Item::max('price');
                    return $sql->whereBetween('price', [$min_price, $max_price]);
                })->when($request->posted_since, function ($sql) use ($request) {
                    return match ($request->posted_since) {
                        "today" => $sql->whereDate('created_at', '>=', now()),
                        "within-1-week" => $sql->whereDate('created_at', '>=', now()->subDays(7)),
                        "within-2-week" => $sql->whereDate('created_at', '>=', now()->subDays(14)),
                        "within-1-month" => $sql->whereDate('created_at', '>=', now()->subMonths()),
                        "within-3-month" => $sql->whereDate('created_at', '>=', now()->subMonths(3)),
                        default => $sql
                    };
                })->when($request->country, function ($sql) use ($request) {
                    return $sql->where('country', $request->country);
                })->when($request->state, function ($sql) use ($request) {
                    return $sql->where('state', $request->state);
                })->when($request->city, function ($sql) use ($request) {
                    return $sql->where('city', $request->city);
                })->when($request->area_id, function ($sql) use ($request) {
                    return $sql->where('area_id', $request->area_id);
                })->when($request->user_id, function ($sql) use ($request) {
                    return $sql->where('user_id', $request->user_id);
                })->when($request->slug, function ($sql) use ($request) {
                    return $sql->where('slug', $request->slug);
                })->when($request->latitude && $request->longitude && $request->radius, function ($sql) use ($request) {
                    $latitude = $request->latitude;
                    $longitude = $request->longitude;
                    $radius = $request->radius;

                    // Calculate distance using Haversine formula
                    $haversine = "(6371 * acos(cos(radians($latitude))
                                    * cos(radians(latitude))
                                    * cos(radians(longitude)
                                    - radians($longitude))
                                    + sin(radians($latitude))
                                    * sin(radians(latitude))))";

                    $sql->select('items.*')
                        ->selectRaw("{$haversine} AS distance")
                        ->where('latitude', '!=', 0)
                        ->where('longitude', '!=', 0)
                        ->having('distance', '<', $radius)
                        ->orderBy('distance', 'asc');
                });

            //            // Other users should only get approved items
            //            if (!Auth::check()) {
            //                $sql->where('status', 'approved');
            //            }

            // Sort By

            if ($request->sort_by == "new-to-old") {
                $sql->orderBy('id', 'DESC');
            } elseif ($request->sort_by == "old-to-new") {
                $sql->orderBy('id', 'ASC');
            } elseif ($request->sort_by == "price-high-to-low") {
                $sql->orderBy('price', 'DESC');
            } elseif ($request->sort_by == "price-low-to-high") {
                $sql->orderBy('price', 'ASC');
            } elseif ($request->sort_by == "popular_items") {
                $sql->orderBy('clicks', 'DESC');
            } else {
                $sql->orderBy('id', 'DESC');
            }

            // Status
            if (!empty($request->status)) {
                if (in_array($request->status, array('review', 'approved', 'rejected', 'sold out', 'soft rejected', 'permanent rejected', 'resubmitted'))) {
                    $sql->where('status', $request->status)->getNonExpiredItems()->whereNull('deleted_at');
                } elseif ($request->status == 'inactive') {
                    //If status is inactive then display only trashed items
                    $sql->onlyTrashed()->getNonExpiredItems();
                } elseif ($request->status == 'featured') {
                    //If status is featured then display only featured items
                    $sql->where('status', 'approved')->has('featured_items')->getNonExpiredItems();
                } elseif ($request->status == 'expired') {
                    $sql->whereNotNull('expiry_date')
                          ->where('expiry_date', '<', Carbon::now())->whereNull('deleted_at');
                }
            }

            // Feature Section Filtration
            if (!empty($request->featured_section_id) || !empty($request->featured_section_slug)) {
                if (!empty($request->featured_section_id)) {
                    $featuredSection = FeatureSection::findOrFail($request->featured_section_id);
                } else {
                    $featuredSection = FeatureSection::where('slug', $request->featured_section_slug)->firstOrFail();
                }
                $sql = match ($featuredSection->filter) {
                    //Note : Reorder function is used to clear out the previously applied order by statement
                    "price_criteria" => $sql->whereBetween('price', [$featuredSection->min_price, $featuredSection->max_price]),
                    "most_viewed" => $sql->reorder()->orderBy('clicks', 'DESC'),
                    "category_criteria" => (static function () use ($featuredSection, $sql) {
                        $category = Category::whereIn('id', explode(',', $featuredSection->value))->with('children')->get();
                        $categoryIDS = HelperService::findAllCategoryIds($category);
                        return $sql->whereIn('category_id', $categoryIDS);
                    })(),

                    //Added withCount here 2nd time because of some wierd issue
                    "most_liked" => $sql->reorder()->withCount('favourites')->orderBy('favourites_count', 'DESC'),
                };
            }


            if (!empty($request->search)) {
                $sql->search($request->search);
            }
            function removeBackslashesRecursive($data)
            {
                $cleaned = [];
                foreach ($data as $key => $value) {
                    $cleanKey = stripslashes($key);
                    if (is_array($value)) {
                        $cleaned[$cleanKey] = removeBackslashesRecursive($value);
                    } else {
                        $cleaned[$cleanKey] = stripslashes($value);
                    }
                }
                return $cleaned;
            }
            $cleanedParameters = removeBackslashesRecursive($request->all());
            if (!empty($cleanedParameters['custom_fields'])) {
                $customFields = $cleanedParameters['custom_fields'];
                foreach ($customFields as $customFieldId => $value) {
                    if (is_array($value)) {
                        foreach ($value as $arrayValue) {
                            $sql->join('item_custom_field_values as cf' . $customFieldId, function ($join) use ($customFieldId) {
                                    $join->on('items.id', '=', 'cf' . $customFieldId . '.item_id');
                                })
                                ->where('cf' . $customFieldId . '.custom_field_id', $customFieldId)
                                ->where('cf' . $customFieldId . '.value', 'LIKE', '%' . trim($arrayValue) . '%');
                        }
                    } else {
                        $sql->join('item_custom_field_values as cf' . $customFieldId, function ($join) use ($customFieldId) {
                                $join->on('items.id', '=', 'cf' . $customFieldId . '.item_id');
                            })
                            ->where('cf' . $customFieldId . '.custom_field_id', $customFieldId)
                            ->where('cf' . $customFieldId . '.value', 'LIKE', '%' . trim($value) . '%');
                    }
                }
                $sql->whereHas('item_custom_field_values', function ($query) use ($customFields) {
                    $query->whereIn('custom_field_id', array_keys($customFields));
                }, '=', count($customFields));
            }


            if (Auth::check()) {
                $sql->with(['item_offers' => function ($q) {
                    $q->where('buyer_id', Auth::user()->id);
                }, 'user_reports'         => function ($q) {
                    $q->where('user_id', Auth::user()->id);
                }]);

                $currentURI = explode('?', $request->getRequestUri(), 2);

                if ($currentURI[0] == "/api/my-items") { //TODO: This if condition is temporary fix. Need something better
                    $sql->where(['user_id' => Auth::user()->id])->withTrashed();
                } else {
                    $sql->where('status', 'approved')->has('user')->onlyNonBlockedUsers()->getNonExpiredItems();
                }
            } else {
                //  Other users should only get approved items
                $sql->where('status', 'approved')->getNonExpiredItems();
            }
            if (!empty($request->id)) {
                
                 //* Collection does not support first OR find method's result as of now. It's a part of R&D
                 //* So currently using this shortcut method get() to fetch the first data
                 
                $result = $sql->get();
                if (count($result) == 0) {
                    ResponseService::errorResponse("No item Found");
                }
            } else {
                if (!empty($request->limit)) {
                    $result = $sql->paginate($request->limit);
                } else {
                    $result = $sql->paginate();
                }

            }
            //                // Add three regular items
            //                for ($i = 0; $i < 3 && $regularIndex < $regularItemCount; $i++) {
            //                    $items->push($regularItems[$regularIndex]);
            //                    $regularIndex++;
            //                }
            //
            //                // Add one featured item if available
            //                if ($featuredIndex < $featuredItemCount) {
            //                    $items->push($featuredItems[$featuredIndex]);
            //                    $featuredIndex++;
            //                }
            //            }
            // Return success response with the fetched items
            // ðŸŸ¢ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ØºØ© Ù…Ù† Ø§Ù„Ù‡ÙŠØ¯Ø± (ar Ø£Ùˆ en)
//$lang = $request->header('Content-Language', 'en');

// ðŸ§  ØªØ­ÙˆÙŠÙ„ Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©
//$result->transform(function ($item) use ($lang) {
    //try {
        // Ø¬Ù„Ø¨ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        //$countryName = $item->country_id ? Country::find($item->country_id)?->{"name_{$lang}"} : null;
        //$stateName   = $item->state_id   ? State::find($item->state_id)?->{"name_{$lang}"}   : null;
        //$cityName    = $item->city_id    ? City::find($item->city_id)?->{"name_{$lang}"}    : null;

        // ðŸ”„ fallback ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙØ§Ø±Øº
        //if ($lang === 'ar') {
            //$countryName = $countryName ?: Country::find($item->country_id)?->name_en;
            //$stateName   = $stateName   ?: State::find($item->state_id)?->name_en;
            //$cityName    = $cityName    ?: City::find($item->city_id)?->name_en;
        //} else {
            //$countryName = $countryName ?: Country::find($item->country_id)?->name_ar;
            //$stateName   = $stateName   ?: State::find($item->state_id)?->name_ar;
            //$cityName    = $cityName    ?: City::find($item->city_id)?->name_ar;
        //}

        // ðŸ“¦ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù†ØµÙŠØ© Ù„Ù„Ø±ÙŠØ³Ø¨ÙˆÙ†Ø³ ÙÙ‚Ø·
        //$item->country = $countryName;
        //$item->state   = $stateName;
        //$item->city    = $cityName;

    //} catch (Throwable $e) {
        //\Log::warning('ðŸŒ Translation failed for item ID '.$item->id, ['error' => $e->getMessage()]);
    //}

    //return $item;
//});
            ResponseService::successResponse("Advertisement Fetched Successfully", new ItemCollection($result));
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> getItem");
            ResponseService::errorResponse();
        }
    }*/


public function getItem2(Request $request)
    {
        // ... (Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª) ...
        $validator = Validator::make($request->all(), [
            'limit' => 'nullable|integer',
            'offset' => 'nullable|integer',
            'id' => 'nullable|integer',
            // ... Ø¨Ù‚ÙŠØ© Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ ...
            'custom_fields' => 'nullable|array',
            'category_id' => 'nullable',
            'category_slug' => 'nullable|string',
            'user_id' => 'nullable',
            'min_price' => 'nullable|numeric',
            'max_price' => 'nullable|numeric',
            'sort_by' => 'nullable|in:new-to-old,old-to-new,price-high-to-low,price-low-to-high,popular_items',
            'posted_since' => 'nullable|in:all-time,today,within-1-week,within-2-week,within-1-month,within-3-month',
            'area_id' => 'nullable',
            'city' => 'nullable|string',
            'state' => 'nullable|string',
            'country' => 'nullable|string',
            'latitude' => 'nullable|numeric',
            'longitude' => 'nullable|numeric',
            'radius' => 'nullable|numeric',
            'search' => 'nullable|string',
            'featured_section_id' => 'nullable',
            'featured_section_slug' => 'nullable|string',
            'status' => 'nullable|string',
            'slug' => 'nullable|string',
        ]);

        if ($validator->fails()) {
            return ResponseService::validationError($validator->errors()->first());
        }

        try {
            // Ø­Ø§Ù„Ø© Ø®Ø§ØµØ©: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ø±ÙŠÙ‚ ID (ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„ØªÙ‚Ù„ÙŠÙ„ TTFB)
            if ($request->filled('id')) {
                $itemId = $request->id;
                
                // ØªØ­Ø¯ÙŠØ¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ Ù‡Ùˆ 'My Items' (ÙŠØ¤Ø«Ø± Ø¹Ù„Ù‰ Ù…ÙØªØ§Ø­ Ø§Ù„ÙƒØ§Ø´)
                $isMyItemRequest = str($request->getRequestUri())->contains('/api/my-items');
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø§Ù„Ù…Ù†Ø§Ø³Ø¨ (Ø¹Ø§Ù… Ø£Ùˆ Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…)
                $cacheKey = $this->generateSpecificItemCacheKey($itemId, $request);
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø£ÙˆÙ„Ø§Ù‹
                $cachedResponse = Cache::get($cacheKey);
                
                if ($cachedResponse) {
                    // Ø¥Ø°Ø§ ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙÙŠ Ø§Ù„ÙƒØ§Ø´ØŒ Ù‚Ù… Ø¨Ø¥Ø±Ø¬Ø§Ø¹Ù‡Ø§ Ù…Ø¨Ø§Ø´Ø±Ø© Ù„ØªÙ‚Ù„ÙŠÙ„ TTFB
                    \Log::info("Item {$itemId} served from cache using key: {$cacheKey}");
                    return $cachedResponse;
                }

                //
                // ØªØ­Ø³ÙŠÙ†: ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙŠ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (select)
                //
                $query = Item::select([
                    'id', 'name', 'slug', 'description', 'price', 'max_salary',
                    'image', 'latitude', 'longitude', 'address', 'contact',
                    'show_only_to_premium', 'status', 'rejected_reason', 
                    'video_link', 'city', 'state', 'country', 'state_id', 
                    'country_id', 'area_id', 'user_id', 'category_id', 'created_at', 'updated_at' // Ø£Ø¶Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
                ])
                ->with([
                    // ØªØ­Ø¯ÙŠØ¯ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ø¯Ø§Ø¡ (Lazy Eager Loading)
                    'user:id,name,email,mobile,profile,created_at,is_verified,show_personal_details,country_code',
                    'category:id,name,image,is_job_category,price_optional',
                    'item_custom_field_values.custom_field:id,name,type,slug', // ØªØ­Ø¯ÙŠØ¯ Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø®ØµØµØ©
                    'gallery_images:id,image,item_id',
                    'area', 'featured_items', 'favourites',
                ])
                    ->withCount(['featured_items', 'job_applications'])
                    ->where('id', $itemId);

                // Ù…Ù†Ø·Ù‚ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ø·Ø§Ù‚ (Scoping): ÙŠØ­Ø¯Ø¯ Ù…Ø§ Ø¥Ø°Ø§ ÙƒÙ†Ø§ Ø³Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¥Ø¹Ù„Ø§Ù† Ø¨ÙˆØ¶Ø¹Ù‡ Ø§Ù„Ø­Ø§Ù„ÙŠ (My Item) Ø£Ùˆ ÙˆØ¶Ø¹ Ø§Ù„Ù…ÙˆØ§ÙÙ‚ Ø¹Ù„ÙŠÙ‡ (Public)
                
                if ($isMyItemRequest && Auth::check()) {
                    // Ù…Ø³Ø§Ø± 'My Items': Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ù„Ù„Ù…Ø§Ù„Ùƒ Ø¨Ø¬Ù…ÙŠØ¹ Ø­Ø§Ù„Ø§ØªÙ‡ (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„Ù…Ø­Ø°ÙˆÙØ© ÙˆØ§Ù„Ù…Ø±ÙÙˆØ¶Ø©)
                    $query->where('user_id', Auth::id())->withTrashed();
                } else {
                    // Ù…Ø³Ø§Ø± Ø¹Ø§Ù…: Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© ÙˆØºÙŠØ± Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
                    $query->where('status', 'approved')->getNonExpiredItems()->has('user')->onlyNonBlockedUsers();
                }
                
                $item = $query->first();

                if (!$item) {
                    return ResponseService::errorResponse("No item Found");
                }

                // Ø§Ø³ØªØ®Ø¯Ø§Ù… ResponseService::successResponse Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© ItemCollection ØºÙŠØ± Ø§Ù„Ù…Ø¹Ø±Ù‘ÙŽÙ
                $response = ResponseService::successResponse("Advertisement FetchÃ©d Successfully", ['data' => $item]);

                
                // âš ï¸ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª ÙŠØªÙ… ÙÙ‚Ø· Ù„Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙØ±Ø¯ÙŠ Ø§Ù„Ø°ÙŠ ØªÙ… Ø¬Ù„Ø¨Ù‡ Ø¨Ù†Ø¬Ø§Ø­.
                // ÙŠØªÙ… Ø§Ù„ØªØ®Ø²ÙŠÙ† Ù„Ù…Ø¯Ø© 10 Ø¯Ù‚Ø§Ø¦Ù‚ (Ø£Ùˆ Ø­Ø³Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ).
                Cache::put($cacheKey, $response, now()->addMinutes(10));
                \Log::info("Item {$itemId} saved to cache using key: {$cacheKey}");


                return $response;
            }
            
            // ----------------------------------------------------------------
            // Ø¨Ù‚ÙŠØ© Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØµÙÙŠØ© ÙˆØ§Ù„ÙØ±Ø² Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ID (Ù„Ø§ ÙŠØªÙ… ØªØ®Ø²ÙŠÙ†Ù‡Ø§ Ù…Ø¤Ù‚ØªØ§Ù‹ Ù‡Ù†Ø§)
            // ----------------------------------------------------------------
            
            $query = Item::with([
                'user:id,name,email,mobile,profile,created_at,is_verified,show_personal_details,country_code',
                'category:id,name,image,is_job_category,price_optional',
                'item_custom_field_values.custom_field',
                'gallery_images:id,image,item_id',
                'area', 'featured_items', 'favourites',
            ])
                ->withCount(['featured_items', 'job_applications'])
                ->select('items.*');

            // ðŸŒ Ø§Ù„ØªØµÙÙŠØ© Ø¹Ù„Ù‰ Ø£Ø³Ø§Ø³ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ (Haversine + Bounding Box)
            if ($request->filled('latitude') && $request->filled('longitude') && $request->filled('radius')) {
                $lat = (float) $request->latitude;
                $lon = (float) $request->longitude;
                $radius = (float) $request->radius;

                // 1. ØªØ·Ø¨ÙŠÙ‚ Bounding Box Ù„ØªØ¶ÙŠÙŠÙ‚ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ
                $latDelta = $radius / 111.0;
                $lonDelta = $radius / (111.0 * max(0.1, cos(deg2rad($lat))));

                $query->whereBetween('latitude', [$lat - $latDelta, $lat + $latDelta])
                      ->whereBetween('longitude', [$lon - $lonDelta, $lon + $lonDelta]);
                      
                // 2. ØªØ·Ø¨ÙŠÙ‚ Haversine ÙˆØ¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„Ù„ÙØ±Ø²
                $query->selectRaw("items.*,
                     (6371 * acos(
                         cos(radians(?)) *
                         cos(radians(latitude)) *
                         cos(radians(longitude) - radians(?)) +
                         sin(radians(?)) *
                         sin(radians(latitude))
                     )) AS distance", [$lat, $lon, $lat]);

                // 3. Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
                $query->having('distance', '<=', $radius)
                    ->orderBy('distance');
            }


            // âš¡ï¸ Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø­Ø§Ø³Ù…: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª ÙØ±Ø¹ÙŠØ© Ù…ÙØ¯Ù…Ø¬Ø© Ù„Ù€ custom_fields
            if ($request->filled('custom_fields') && is_array($request->custom_fields)) {
                
                // ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø´Ø±Ø· whereIn Ù„ÙƒÙ„ Ø­Ù‚Ù„ Ù…Ø®ØµØµØŒ Ù…Ù…Ø§ ÙŠÙØ±Ø¶ Ù…Ù†Ø·Ù‚ AND (Ø§Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø´ØªØ±Ùƒ)
                foreach ($request->custom_fields as $fieldId => $value) {
                    $values = is_array($value) ? $value : [$value];
                    
                    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø¥Ù„Ù‰ ØµÙŠØºØ© Ø¨Ø­Ø« Ø§Ù„Ù†Øµ Ø§Ù„ÙƒØ§Ù…Ù„ (Boolean Mode)
                    $matchQuery = implode(' ', array_map(function($v) {
                        $v = trim($v);
                        // Ø¥Ø¶Ø§ÙØ© + Ùˆ * Ù„ØªÙƒÙˆÙ† Ø¥Ù„Ø²Ø§Ù…ÙŠØ© ÙˆÙ…Ø¬Ø²Ø£Ø© - Ù‡Ø°Ø§ ÙŠØªØ·Ù„Ø¨ ØªÙ‡ÙŠØ¦Ø© Full-Text Index Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ value
                        return $v ? "+" . $v . "*" : ""; 
                    }, $values));

                    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… whereIn Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ±Ø¹ÙŠØ©
                    $query->whereIn('items.id', function ($subQuery) use ($fieldId, $matchQuery) {
                        $subQuery->select('icfv.item_id')
                            ->from('item_custom_field_values as icfv')
                            ->where('icfv.custom_field_id', $fieldId)
                            // Ø§Ø³ØªØ®Ø¯Ø§Ù… MATCH AGAINST Ø§Ù„Ù…ÙÙÙ‡Ø±Ø³ (Full-Text Search)
                            ->whereRaw("MATCH(icfv.value) AGAINST (? IN BOOLEAN MODE)", [$matchQuery]);
                    });
                }
            }
            
            // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Area/City/State/Country)
            $query->where(function ($q) use ($request) {
                $hasArea = $request->filled('area_id');
                $hasCity = $request->filled('city');
                $hasState = $request->filled('state');
                $hasCountry = $request->filled('country');

                $q->when($hasArea, fn($sq) => $sq->where('area_id', $request->area_id))
                    ->orWhere(fn($sq) => $sq->when(!$hasArea && $hasCity, fn($ssq) => $ssq->where('city', $request->city)))
                    ->orWhere(fn($sq) => $sq->when(!$hasArea && !$hasCity && $hasState, fn($ssq) => $ssq->where('state', $request->state)))
                    ->orWhere(fn($sq) => $sq->when(!$hasArea && !$hasCity && !$hasState && $hasCountry, fn($ssq) => $ssq->where('country', $request->country)));
            });

            // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ù€ Slug
            $query->when($request->filled('user_id'), fn($q) => $q->where('user_id', $request->user_id));
            $query->when($request->filled('slug'), fn($q) => $q->where('slug', $request->slug));

            // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø© (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Cache)
            $query->when($request->filled('category_id'), fn($q) => $q->whereIn('category_id', cache()->remember(
                "category_children_{$request->category_id}", now()->addHours(12),
                fn() => HelperService::findAllCategoryIds(Category::where('id', $request->category_id)->with('children')->first() ?? collect())
            )));

            $query->when($request->filled('category_slug'), fn($q) => $q->whereIn('category_id', cache()->remember(
                "category_slug_{$request->category_slug}", now()->addHours(12),
                fn() => HelperService::findAllCategoryIds(Category::where('slug', $request->category_slug)->with('children')->first() ?? collect())
            )));

            // Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø± (Price Range)
            $query->when($request->min_price || $request->max_price, fn($q) => $q->whereBetween('price', [
                $request->min_price ?? 0,
                $request->max_price ?? 999999999
            ]));

            // ÙØªØ±Ø© Ø§Ù„Ù†Ø´Ø± (Posted Since)
            $query->when($request->filled('posted_since'), function ($q) use ($request) {
                $date = match ($request->posted_since) {
                    'today'             => now()->startOfDay(),
                    'within-1-week'     => now()->subDays(7),
                    'within-2-week'     => now()->subDays(14),
                    'within-1-month'    => now()->subMonthNoOverflow(),
                    'within-3-month'    => now()->subMonthsNoOverflow(3),
                    default             => now()->subYears(100),
                };
                $q->where('created_at', '>=', $date);
            });

            // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ Ø§Ù„Ø¹Ø§Ù… (General Search)
            if ($request->has('search') && strlen(trim($request->search ?? '')) >= 2) {
                // ÙŠÙØªØ±Ø¶ Ø£Ù† Ø¯Ø§Ù„Ø© search() Ù‡ÙŠ Ø¯Ø§Ù„Ø© Scope ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Item ÙˆØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ Ø§Ù„ÙƒØ§Ù…Ù„
                $query->search(trim($request->search));
            }

            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙØ±Ø² ÙˆØ§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„ØªØµÙÙŠØ© Ø§Ù„Ø®Ø§ØµØ© (Featured) - ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…ÙŠØ«ÙˆØ¯ Ù…Ù† Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ø£Ø¨
            // ÙŠØ¬Ø¨ ØªÙˆÙØ± applyCommonModifiers ÙÙŠ Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ø£Ø¨
            $query = $this->applyCommonModifiers($query, $request);

            // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„Ù†Ø·Ø§Ù‚ (Auth & Scoping)
            if (Auth::check()) {
                $query->with([
                    // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙƒ Ø¹Ù„Ø§Ù‚Ø© item_offers Ùˆ user_reports Ù…Ø¹Ø±ÙØ© ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Item
                    'item_offers' => fn($q) => $q->where('buyer_id', Auth::id()),
                    'user_reports' => fn($q) => $q->where('user_id', Auth::id())
                ]);

                if (str($request->getRequestUri())->contains('/api/my-items')) {
                    $query->where('user_id', Auth::id())->withTrashed();
                } else {
                    $query->where('status', 'approved')
                        ->has('user')
                        ->onlyNonBlockedUsers()
                        ->getNonExpiredItems();
                }
            } else {
                $query->where('status', 'approved')->getNonExpiredItems();
            }

            // ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… ÙˆØ¬Ù„Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            $result = $query->paginate($request->limit ?? 15);

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… ResponseService::successResponse Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© ItemCollection ØºÙŠØ± Ø§Ù„Ù…Ø¹Ø±Ù‘ÙŽÙ
            return ResponseService::successResponse("Advertisement Fetched Successfully", $result);


        } catch (Throwable $th) {
            \Log::error('getItem Error: ' . $th->getMessage(), ['trace' => $th->getTraceAsString()]);
            return ResponseService::logErrorResponse($th, "API Controller -> getItem");
        }
    }
    
    // ----------------------------------------------------------------------------------
    // Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© (Caching Management)
    // ----------------------------------------------------------------------------------

    /**
     * ÙŠØ­Ø³Ø¨ Ù…ÙØªØ§Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© (Cache Key) Ù„Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ID ÙˆÙ…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø·Ù„Ø¨Ù‹Ø§ Ø®Ø§ØµÙ‹Ø§.
     * (ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¹Ø§Ø±Ø¶ Ù…Ø¹ Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ø£Ø¨)
     *
     * @param int $itemId
     * @param Request $request
     * @return string
     */
    private function generateSpecificItemCacheKey(int $itemId, Request $request): string
    {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ Ù…ÙˆØ¬Ù‡Ø§Ù‹ Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø± 'my-items'
        $isMyItemRequest = str($request->getRequestUri())->contains('/api/my-items');
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø·Ù„Ø¨Ù‹Ø§ Ø®Ø§ØµÙ‹Ø§ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (My Items) ÙˆÙ…Ø±ØªØ¨Ø·Ù‹Ø§ Ø¨Ù…Ø³ØªØ®Ø¯Ù… Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡
        // Ù†Ø³ØªØ®Ø¯Ù… Auth::check() Ù„Ø¶Ù…Ø§Ù† Ø£Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø®Ø§Øµ Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ø³ØªØ®Ø¯Ù…
        $isUserSpecific = $isMyItemRequest && Auth::check();
        
        $modifier = $isUserSpecific ? '_my_item_' . Auth::id() : '_public';
        
        // ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ ID ÙÙŠ Ù…ÙØªØ§Ø­ Ø§Ù„ÙƒØ§Ø´ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„ÙƒÙ„ Ø¥Ø¹Ù„Ø§Ù† Ø¹Ù„Ù‰ Ø­Ø¯Ø©
        return 'item_details_' . $itemId . $modifier;
    }

    /**
     * ÙŠÙ…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø¥Ø¹Ù„Ø§Ù† Ù…Ø¹ÙŠÙ† Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„Ù‡.
     * (ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„ØªØ¶Ø§Ø±Ø¨ Ù…Ø¹ Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ø£Ø¨)
     * ÙŠØ¬Ø¨ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙŠ Ø¯ÙˆØ§Ù„ Ù…Ø«Ù„ updateItemData, deleteItemRecord, changeItemStatus.
     *
     * @param int $itemId
     * @return void
     */
    public function purgeItemCache(int $itemId): void
    {
        // Ù…Ø³Ø­ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¹Ø§Ù… (Public Key)
        $publicKey = 'item_details_' . $itemId . '_public';
        Cache::forget($publicKey);

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…Ø³ØªØ®Ø¯Ù… Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡ (ØºØ§Ù„Ø¨Ø§Ù‹ Ø³ÙŠÙƒÙˆÙ† Ù…Ø§Ù„Ùƒ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†)ØŒ Ù†Ù…Ø³Ø­ Ù…ÙØªØ§Ø­Ù‡ Ø§Ù„Ø®Ø§Øµ
        if (Auth::check()) {
            // Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø®Ø§Øµ ÙŠØªØ¶Ù…Ù† ID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠÙƒÙˆÙ† ÙØ±ÙŠØ¯Ø§Ù‹
            $privateKey = 'item_details_' . $itemId . '_my_item_' . Auth::id();
            Cache::forget($privateKey);
        }
        
        \Log::info("ØªÙ… Ù…Ø³Ø­ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ø¥Ø¹Ù„Ø§Ù† ID: {$itemId}.");
    }
    
    // ----------------------------------------------------------------------------------
    // Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¶Ø§Ø±Ø¨ Ù…Ø¹ ApiController)
    // ----------------------------------------------------------------------------------

    /**
     * Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Update Item)
     * (ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¶Ø§Ø±Ø¨ Ù…Ø¹ Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ø£Ø¨)
     *
     * @param Request $request
     * @param int $itemId
     * @return \Illuminate\Http\JsonResponse
     */
    public function updateItemData(Request $request, int $itemId)
    {
        // 1. Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«
        $item = Item::findOrFail($itemId);
        // $item->update($request->validated()); 
        // ... (Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ¹Ù„ÙŠ) ...

        // 2. Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
        $this->purgeItemCache($itemId); // ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¯Ø§Ù„Ø©

        return ResponseService::successResponse("Advertisement Updated Successfully");
    }

    /**
     * Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Change Status)
     * (ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¶Ø§Ø±Ø¨ Ù…Ø¹ Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ø£Ø¨)
     *
     * @param Request $request
     * @param int $itemId
     * @return \Illuminate\Http\JsonResponse
     */
    public function changeItemStatus(Request $request, int $itemId)
    {
        // 1. Ù…Ù†Ø·Ù‚ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©
        $item = Item::findOrFail($itemId);
        // $item->update(['status' => $request->new_status]);
        // ... (Ù…Ù†Ø·Ù‚ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙØ¹Ù„ÙŠ) ...

        // 2. Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¨Ø¹Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©
        $this->purgeItemCache($itemId); // ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¯Ø§Ù„Ø©

        return ResponseService::successResponse("Advertisement Status Changed Successfully");
    }

    /**
     * Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Delete Item)
     * (ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¶Ø§Ø±Ø¨ Ù…Ø¹ Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ø£Ø¨)
     *
     * @param int $itemId
     * @return \Illuminate\Http\JsonResponse
     */
    public function deleteItemRecord(int $itemId)
    {
        // 1. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø°Ù (Soft Delete Ø£Ùˆ Force Delete)
        $item = Item::findOrFail($itemId);
        // $item->delete(); 
        // ... (Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø°Ù Ø§Ù„ÙØ¹Ù„ÙŠ) ...

        // 2. Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù
        $this->purgeItemCache($itemId); // ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ø³Ù… Ø§Ù„Ø¯Ø§Ù„Ø©

        return ResponseService::successResponse("Advertisement Deleted Successfully");
    }

  public function getItem333(Request $request)
    {
        // ... (Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª) ...
        $validator = Validator::make($request->all(), [
            'limit' => 'nullable|integer',
            'offset' => 'nullable|integer',
            'id' => 'nullable|integer',
            // ... Ø¨Ù‚ÙŠØ© Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ ...
            'custom_fields' => 'nullable|array',
            'category_id' => 'nullable',
            'category_slug' => 'nullable|string',
            'user_id' => 'nullable',
            'min_price' => 'nullable|numeric',
            'max_price' => 'nullable|numeric',
            'sort_by' => 'nullable|in:new-to-old,old-to-new,price-high-to-low,price-low-to-high,popular_items',
            'posted_since' => 'nullable|in:all-time,today,within-1-week,within-2-week,within-1-month,within-3-month',
            'area_id' => 'nullable',
            'city' => 'nullable|string',
            'state' => 'nullable|string',
            'country' => 'nullable|string',
            'latitude' => 'nullable|numeric',
            'longitude' => 'nullable|numeric',
            'radius' => 'nullable|numeric',
            'search' => 'nullable|string',
            'featured_section_id' => 'nullable',
            'featured_section_slug' => 'nullable|string',
            'status' => 'nullable|string',
            'slug' => 'nullable|string',
        ]);

        if ($validator->fails()) {
            return ResponseService::validationError($validator->errors()->first());
        }

        try {
            // Ø­Ø§Ù„Ø© Ø®Ø§ØµØ©: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ø±ÙŠÙ‚ ID (ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„ØªÙ‚Ù„ÙŠÙ„ TTFB)
            if ($request->filled('id')) {
                $itemId = $request->id;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… getItemCacheKeyForRequest() Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† calculateItemCacheKey()
                $cacheKey = $this->getItemCacheKeyForRequest($itemId, $request);
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø£ÙˆÙ„Ø§Ù‹
                $cachedResponse = Cache::get($cacheKey);
                
                if ($cachedResponse) {
                    return $cachedResponse;
                }

                $query = Item::with([
                    'user:id,name,email,mobile,profile,created_at,is_verified,show_personal_details,country_code',
                    'category:id,name,image,is_job_category,price_optional',
                    'item_custom_field_values.custom_field',
                    'gallery_images:id,image,item_id',
                    'area', 'featured_items', 'favourites',
                ])
                    ->withCount(['featured_items', 'job_applications'])
                    ->where('id', $itemId);

                // Ù…Ù†Ø·Ù‚ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ø·Ø§Ù‚ (Scoping)
                $isMyItemRequest = str($request->getRequestUri())->contains('/api/my-items');
                
                if ($isMyItemRequest && Auth::check()) {
                    $query->where('user_id', Auth::id())->withTrashed();
                } else {
                    $query->where('status', 'approved')->getNonExpiredItems()->has('user')->onlyNonBlockedUsers();
                }
                
                $item = $query->first();

                if (!$item) return ResponseService::errorResponse("No item Found");

                // Ø§Ø³ØªØ®Ø¯Ø§Ù… ResponseService::successResponse Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© ItemCollection ØºÙŠØ± Ø§Ù„Ù…Ø¹Ø±Ù‘ÙŽÙ
                $response = ResponseService::successResponse("Advertisement Fetched Successfully", ['data' => $item]);

                
                // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù„Ù…Ø¯Ø© 10 Ø¯Ù‚Ø§Ø¦Ù‚
                Cache::put($cacheKey, $response, now()->addMinutes(10));

                return $response;
            }
            
            // ----------------------------------------------------------------
            // Ø¨Ù‚ÙŠØ© Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØµÙÙŠØ© ÙˆØ§Ù„ÙØ±Ø² Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ID
            // ----------------------------------------------------------------
            
            $query = Item::with([
                'user:id,name,email,mobile,profile,created_at,is_verified,show_personal_details,country_code',
                'category:id,name,image,is_job_category,price_optional',
                'item_custom_field_values.custom_field',
                'gallery_images:id,image,item_id',
                'area', 'featured_items', 'favourites',
            ])
                ->withCount(['featured_items', 'job_applications'])
                ->select('items.*');

            // ðŸŒ Ø§Ù„ØªØµÙÙŠØ© Ø¹Ù„Ù‰ Ø£Ø³Ø§Ø³ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ (Haversine + Bounding Box)
            if ($request->filled('latitude') && $request->filled('longitude') && $request->filled('radius')) {
                $lat = (float) $request->latitude;
                $lon = (float) $request->longitude;
                $radius = (float) $request->radius;

                // 1. ØªØ·Ø¨ÙŠÙ‚ Bounding Box Ù„ØªØ¶ÙŠÙŠÙ‚ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ
                $latDelta = $radius / 111.0;
                $lonDelta = $radius / (111.0 * max(0.1, cos(deg2rad($lat))));

                $query->whereBetween('latitude', [$lat - $latDelta, $lat + $latDelta])
                      ->whereBetween('longitude', [$lon - $lonDelta, $lon + $lonDelta]);
                      
                // 2. ØªØ·Ø¨ÙŠÙ‚ Haversine ÙˆØ¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„Ù„ÙØ±Ø²
                $query->selectRaw("items.*,
                     (6371 * acos(
                         cos(radians(?)) *
                         cos(radians(latitude)) *
                         cos(radians(longitude) - radians(?)) +
                         sin(radians(?)) *
                         sin(radians(latitude))
                     )) AS distance", [$lat, $lon, $lat]);

                // 3. Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
                $query->having('distance', '<=', $radius)
                    ->orderBy('distance');
            }


            // âš¡ï¸ Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø­Ø§Ø³Ù…: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª ÙØ±Ø¹ÙŠØ© Ù…ÙØ¯Ù…Ø¬Ø© Ù„Ù€ custom_fields
            if ($request->filled('custom_fields') && is_array($request->custom_fields)) {
                
                // ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø´Ø±Ø· whereIn Ù„ÙƒÙ„ Ø­Ù‚Ù„ Ù…Ø®ØµØµØŒ Ù…Ù…Ø§ ÙŠÙØ±Ø¶ Ù…Ù†Ø·Ù‚ AND (Ø§Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø´ØªØ±Ùƒ)
                foreach ($request->custom_fields as $fieldId => $value) {
                    $values = is_array($value) ? $value : [$value];
                    
                    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø¥Ù„Ù‰ ØµÙŠØºØ© Ø¨Ø­Ø« Ø§Ù„Ù†Øµ Ø§Ù„ÙƒØ§Ù…Ù„ (Boolean Mode)
                    $matchQuery = implode(' ', array_map(function($v) {
                        $v = trim($v);
                        // Ø¥Ø¶Ø§ÙØ© + Ùˆ * Ù„ØªÙƒÙˆÙ† Ø¥Ù„Ø²Ø§Ù…ÙŠØ© ÙˆÙ…Ø¬Ø²Ø£Ø© - Ù‡Ø°Ø§ ÙŠØªØ·Ù„Ø¨ ØªÙ‡ÙŠØ¦Ø© Full-Text Index Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ value
                        return $v ? "+" . $v . "*" : ""; 
                    }, $values));

                    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… whereIn Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ±Ø¹ÙŠØ©
                    $query->whereIn('items.id', function ($subQuery) use ($fieldId, $matchQuery) {
                        $subQuery->select('icfv.item_id')
                            ->from('item_custom_field_values as icfv')
                            ->where('icfv.custom_field_id', $fieldId)
                            // Ø§Ø³ØªØ®Ø¯Ø§Ù… MATCH AGAINST Ø§Ù„Ù…ÙÙÙ‡Ø±Ø³ (Full-Text Search)
                            ->whereRaw("MATCH(icfv.value) AGAINST (? IN BOOLEAN MODE)", [$matchQuery]);
                    });
                }
            }
            
            // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Area/City/State/Country)
            $query->where(function ($q) use ($request) {
                $hasArea = $request->filled('area_id');
                $hasCity = $request->filled('city');
                $hasState = $request->filled('state');
                $hasCountry = $request->filled('country');

                $q->when($hasArea, fn($sq) => $sq->where('area_id', $request->area_id))
                    ->orWhere(fn($sq) => $sq->when(!$hasArea && $hasCity, fn($ssq) => $ssq->where('city', $request->city)))
                    ->orWhere(fn($sq) => $sq->when(!$hasArea && !$hasCity && $hasState, fn($ssq) => $ssq->where('state', $request->state)))
                    ->orWhere(fn($sq) => $sq->when(!$hasArea && !$hasCity && !$hasState && $hasCountry, fn($ssq) => $ssq->where('country', $request->country)));
            });

            // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ù€ Slug
            $query->when($request->filled('user_id'), fn($q) => $q->where('user_id', $request->user_id));
            $query->when($request->filled('slug'), fn($q) => $q->where('slug', $request->slug));

            // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø© (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Cache)
            $query->when($request->filled('category_id'), fn($q) => $q->whereIn('category_id', cache()->remember(
                "category_children_{$request->category_id}", now()->addHours(12),
                fn() => HelperService::findAllCategoryIds(Category::where('id', $request->category_id)->with('children')->first() ?? collect())
            )));

            $query->when($request->filled('category_slug'), fn($q) => $q->whereIn('category_id', cache()->remember(
                "category_slug_{$request->category_slug}", now()->addHours(12),
                fn() => HelperService::findAllCategoryIds(Category::where('slug', $request->category_slug)->with('children')->first() ?? collect())
            )));

            // Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø± (Price Range)
            $query->when($request->min_price || $request->max_price, fn($q) => $q->whereBetween('price', [
                $request->min_price ?? 0,
                $request->max_price ?? 999999999
            ]));

            // ÙØªØ±Ø© Ø§Ù„Ù†Ø´Ø± (Posted Since)
            $query->when($request->filled('posted_since'), function ($q) use ($request) {
                $date = match ($request->posted_since) {
                    'today'             => now()->startOfDay(),
                    'within-1-week'     => now()->subDays(7),
                    'within-2-week'     => now()->subDays(14),
                    'within-1-month'    => now()->subMonthNoOverflow(),
                    'within-3-month'    => now()->subMonthsNoOverflow(3),
                    default             => now()->subYears(100),
                };
                $q->where('created_at', '>=', $date);
            });

            // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ Ø§Ù„Ø¹Ø§Ù… (General Search)
            if ($request->has('search') && strlen(trim($request->search ?? '')) >= 2) {
                // ÙŠÙØªØ±Ø¶ Ø£Ù† Ø¯Ø§Ù„Ø© search() Ù‡ÙŠ Ø¯Ø§Ù„Ø© Scope ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Item ÙˆØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ Ø§Ù„ÙƒØ§Ù…Ù„
                $query->search(trim($request->search));
            }

            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙØ±Ø² ÙˆØ§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„ØªØµÙÙŠØ© Ø§Ù„Ø®Ø§ØµØ© (Featured) - ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…ÙŠØ«ÙˆØ¯ Ù…Ù† Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ø£Ø¨
            // ÙŠØ¬Ø¨ ØªÙˆÙØ± applyCommonModifiers ÙÙŠ Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ø£Ø¨
            $query = $this->applyCommonModifiers($query, $request);

            // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„Ù†Ø·Ø§Ù‚ (Auth & Scoping)
            if (Auth::check()) {
                $query->with([
                    // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙƒ Ø¹Ù„Ø§Ù‚Ø© item_offers Ùˆ user_reports Ù…Ø¹Ø±ÙØ© ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Item
                    'item_offers' => fn($q) => $q->where('buyer_id', Auth::id()),
                    'user_reports' => fn($q) => $q->where('user_id', Auth::id())
                ]);

                if (str($request->getRequestUri())->contains('/api/my-items')) {
                    $query->where('user_id', Auth::id())->withTrashed();
                } else {
                    $query->where('status', 'approved')
                        ->has('user')
                        ->onlyNonBlockedUsers()
                        ->getNonExpiredItems();
                }
            } else {
                $query->where('status', 'approved')->getNonExpiredItems();
            }

            // ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… ÙˆØ¬Ù„Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            $result = $query->paginate($request->limit ?? 15);

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… ResponseService::successResponse Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© ItemCollection ØºÙŠØ± Ø§Ù„Ù…Ø¹Ø±Ù‘ÙŽÙ
            return ResponseService::successResponse("Advertisement Fetched Successfully", $result);


        } catch (Throwable $th) {
            \Log::error('getItem Error: ' . $th->getMessage(), ['trace' => $th->getTraceAsString()]);
            return ResponseService::logErrorResponse($th, "API Controller -> getItem");
        }
    }
    
    // ----------------------------------------------------------------------------------
    // Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© (Caching Management)
    // ----------------------------------------------------------------------------------

    /**
     * ÙŠØ­Ø³Ø¨ Ù…ÙØªØ§Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© (Cache Key) Ù„Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ID ÙˆÙ…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø·Ù„Ø¨Ù‹Ø§ Ø®Ø§ØµÙ‹Ø§.
     * (ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„ØªØ¶Ø§Ø±Ø¨ Ù…Ø¹ Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ø£Ø¨)
     *
     * @param int $itemId
     * @param Request $request
     * @return string
     */
    protected function getItemCacheKeyForRequest(int $itemId, Request $request): string
    {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ Ù…ÙˆØ¬Ù‡Ø§Ù‹ Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø± 'my-items'
        $isMyItemRequest = str($request->getRequestUri())->contains('/api/my-items');
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø·Ù„Ø¨Ù‹Ø§ Ø®Ø§ØµÙ‹Ø§ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (My Items) ÙˆÙ…Ø±ØªØ¨Ø·Ù‹Ø§ Ø¨Ù…Ø³ØªØ®Ø¯Ù… Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡
        // Ù†Ø³ØªØ®Ø¯Ù… Auth::check() Ù„Ø¶Ù…Ø§Ù† Ø£Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø®Ø§Øµ Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ø³ØªØ®Ø¯Ù…
        $isUserSpecific = $isMyItemRequest && Auth::check();
        
        $modifier = $isUserSpecific ? '_my_item_' . Auth::id() : '_public';
        
        return 'item_details_' . $itemId . $modifier;
    }

    /**
     * ÙŠÙ…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø¥Ø¹Ù„Ø§Ù† Ù…Ø¹ÙŠÙ† Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„Ù‡.
     * (ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù… Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„ØªØ¶Ø§Ø±Ø¨ Ù…Ø¹ Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ø£Ø¨)
     * ÙŠØ¬Ø¨ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙŠ Ø¯ÙˆØ§Ù„ Ù…Ø«Ù„ handleUpdateItem, handleDeleteItem, handleChangeStatus.
     *
     * @param int $itemId
     * @return void
     */
    public function clearSpecificItemCache(int $itemId): void
    {
        // Ù…Ø³Ø­ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¹Ø§Ù… (Public Key)
        $publicKey = 'item_details_' . $itemId . '_public';
        Cache::forget($publicKey);

        // Ù…Ø³Ø­ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³Ø¬Ù„Ø§Ù‹ Ù„Ù„Ø¯Ø®ÙˆÙ„ (Ø¹Ø§Ø¯Ø©Ù‹ ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ø°ÙŠ ÙŠØ­Ø±Ø±)
        if (Auth::check()) {
            // Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø®Ø§Øµ ÙŠØªØ¶Ù…Ù† ID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠÙƒÙˆÙ† ÙØ±ÙŠØ¯Ø§Ù‹
            $privateKey = 'item_details_' . $itemId . '_my_item_' . Auth::id();
            Cache::forget($privateKey);
        }
        
        \Log::info("ØªÙ… Ù…Ø³Ø­ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ø¥Ø¹Ù„Ø§Ù† ID: {$itemId}.");
    }
    
    // ----------------------------------------------------------------------------------
    // Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ù…ÙŠØ© Ù„ØªØ¬Ù†Ø¨ Ø§Ù„ØªØ¶Ø§Ø±Ø¨ Ù…Ø¹ ApiController)
    // ----------------------------------------------------------------------------------

    /**
     * Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Update Item)
     *
     * @param Request $request
     * @param int $itemId
     * @return \Illuminate\Http\JsonResponse
     */
    public function handleItemUpdate(Request $request, int $itemId) // ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…
    {
        // 1. Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«
        $item = Item::findOrFail($itemId);
        // $item->update($request->validated()); 
        // ... (Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ¹Ù„ÙŠ) ...

        // 2. Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
        $this->clearSpecificItemCache($itemId);

        return ResponseService::successResponse("Advertisement Updated Successfully");
    }

    /**
     * Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Change Status)
     *
     * @param Request $request
     * @param int $itemId
     * @return \Illuminate\Http\JsonResponse
     */
    public function handleItemStatusChange(Request $request, int $itemId) // ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…
    {
        // 1. Ù…Ù†Ø·Ù‚ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©
        $item = Item::findOrFail($itemId);
        // $item->update(['status' => $request->new_status]);
        // ... (Ù…Ù†Ø·Ù‚ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙØ¹Ù„ÙŠ) ...

        // 2. Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¨Ø¹Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©
        $this->clearSpecificItemCache($itemId);

        return ResponseService::successResponse("Advertisement Status Changed Successfully");
    }

    /**
     * Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Delete Item)
     *
     * @param int $itemId
     * @return \Illuminate\Http\JsonResponse
     */
    public function handleItemDeletion(int $itemId) // ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø§Ø³Ù…
    {
        // 1. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø°Ù (Soft Delete Ø£Ùˆ Force Delete)
        $item = Item::findOrFail($itemId);
        // $item->delete(); 
        // ... (Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø°Ù Ø§Ù„ÙØ¹Ù„ÙŠ) ...

        // 2. Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù
        $this->clearSpecificItemCache($itemId);

        return ResponseService::successResponse("Advertisement Deleted Successfully");
    }

 public function getItemfin(Request $request)
    {
        // ... (Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª) ...
        $validator = Validator::make($request->all(), [
            'limit' => 'nullable|integer',
            'offset' => 'nullable|integer',
            'id' => 'nullable|integer',
            // ... Ø¨Ù‚ÙŠØ© Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ ...
            'custom_fields' => 'nullable|array',
            'category_id' => 'nullable',
            'category_slug' => 'nullable|string',
            'user_id' => 'nullable',
            'min_price' => 'nullable|numeric',
            'max_price' => 'nullable|numeric',
            'sort_by' => 'nullable|in:new-to-old,old-to-new,price-high-to-low,price-low-to-high,popular_items',
            'posted_since' => 'nullable|in:all-time,today,within-1-week,within-2-week,within-1-month,within-3-month',
            'area_id' => 'nullable',
            'city' => 'nullable|string',
            'state' => 'nullable|string',
            'country' => 'nullable|string',
            'latitude' => 'nullable|numeric',
            'longitude' => 'nullable|numeric',
            'radius' => 'nullable|numeric',
            'search' => 'nullable|string',
            'featured_section_id' => 'nullable',
            'featured_section_slug' => 'nullable|string',
            'status' => 'nullable|string',
            'slug' => 'nullable|string',
        ]);

        if ($validator->fails()) {
            return ResponseService::validationError($validator->errors()->first());
        }

        try {
            // Ø­Ø§Ù„Ø© Ø®Ø§ØµØ©: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ø±ÙŠÙ‚ ID (ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„ØªÙ‚Ù„ÙŠÙ„ TTFB)
            if ($request->filled('id')) {
                $itemId = $request->id;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… calculateItemCacheKey()
                $cacheKey = $this->calculateItemCacheKey($itemId, $request);
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø£ÙˆÙ„Ø§Ù‹
                $cachedResponse = Cache::get($cacheKey);
                
                if ($cachedResponse) {
                    return $cachedResponse;
                }

                $query = Item::with([
                    'user:id,name,email,mobile,profile,created_at,is_verified,show_personal_details,country_code',
                    'category:id,name,image,is_job_category,price_optional',
                    'item_custom_field_values.custom_field',
                    'gallery_images:id,image,item_id',
                    'area', 'featured_items', 'favourites',
                ])
                    ->withCount(['featured_items', 'job_applications'])
                    ->where('id', $itemId);

                // Ù…Ù†Ø·Ù‚ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ø·Ø§Ù‚ (Scoping)
                $isMyItemRequest = str($request->getRequestUri())->contains('/api/my-items');
                
                if ($isMyItemRequest && Auth::check()) {
                    $query->where('user_id', Auth::id())->withTrashed();
                } else {
                    $query->where('status', 'approved')->getNonExpiredItems()->has('user')->onlyNonBlockedUsers();
                }
                
                $item = $query->first();

                if (!$item) return ResponseService::errorResponse("No item Found");

                // ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ItemCollection Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ù€ Resource Collection Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
                // Ø¨Ù…Ø§ Ø£Ù† ItemCollection ØºÙŠØ± Ù…Ø¹Ø±Ù‘ÙŽÙØŒ Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Resource Ø¹Ø§Ø¯ÙŠ Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„ØªØ¬Ù†Ø¨ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
                // **ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ù‡Ø°Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ Ø¨Ø§Ù„Ù€ Resource Collection Ø§Ù„ØµØ­ÙŠØ­**
                // $response = ResponseService::successResponse("Advertisement Fetched Successfully", new ItemCollection(collect([$item])));
                
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… ResponseService::successResponse Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© ItemCollection ØºÙŠØ± Ø§Ù„Ù…Ø¹Ø±Ù‘ÙŽÙ
                $response = ResponseService::successResponse("Advertisement Fetched Successfully", ['data' => $item]);

                
                // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù„Ù…Ø¯Ø© 10 Ø¯Ù‚Ø§Ø¦Ù‚
                Cache::put($cacheKey, $response, now()->addMinutes(10));

                return $response;
            }
            
            // ----------------------------------------------------------------
            // Ø¨Ù‚ÙŠØ© Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØµÙÙŠØ© ÙˆØ§Ù„ÙØ±Ø² Ù„Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ID
            // ----------------------------------------------------------------
            
            $query = Item::with([
                'user:id,name,email,mobile,profile,created_at,is_verified,show_personal_details,country_code',
                'category:id,name,image,is_job_category,price_optional',
                'item_custom_field_values.custom_field',
                'gallery_images:id,image,item_id',
                'area', 'featured_items', 'favourites',
            ])
                ->withCount(['featured_items', 'job_applications'])
                ->select('items.*');

            // ðŸŒ Ø§Ù„ØªØµÙÙŠØ© Ø¹Ù„Ù‰ Ø£Ø³Ø§Ø³ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ (Haversine + Bounding Box)
            if ($request->filled('latitude') && $request->filled('longitude') && $request->filled('radius')) {
                $lat = (float) $request->latitude;
                $lon = (float) $request->longitude;
                $radius = (float) $request->radius;

                // 1. ØªØ·Ø¨ÙŠÙ‚ Bounding Box Ù„ØªØ¶ÙŠÙŠÙ‚ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ
                $latDelta = $radius / 111.0;
                $lonDelta = $radius / (111.0 * max(0.1, cos(deg2rad($lat))));

                $query->whereBetween('latitude', [$lat - $latDelta, $lat + $latDelta])
                      ->whereBetween('longitude', [$lon - $lonDelta, $lon + $lonDelta]);
                      
                // 2. ØªØ·Ø¨ÙŠÙ‚ Haversine ÙˆØ¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„Ù„ÙØ±Ø²
                $query->selectRaw("items.*,
                     (6371 * acos(
                         cos(radians(?)) *
                         cos(radians(latitude)) *
                         cos(radians(longitude) - radians(?)) +
                         sin(radians(?)) *
                         sin(radians(latitude))
                     )) AS distance", [$lat, $lon, $lat]);

                // 3. Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
                $query->having('distance', '<=', $radius)
                    ->orderBy('distance');
            }


            // âš¡ï¸ Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø­Ø§Ø³Ù…: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª ÙØ±Ø¹ÙŠØ© Ù…ÙØ¯Ù…Ø¬Ø© Ù„Ù€ custom_fields
            if ($request->filled('custom_fields') && is_array($request->custom_fields)) {
                
                // ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø´Ø±Ø· whereIn Ù„ÙƒÙ„ Ø­Ù‚Ù„ Ù…Ø®ØµØµØŒ Ù…Ù…Ø§ ÙŠÙØ±Ø¶ Ù…Ù†Ø·Ù‚ AND (Ø§Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø´ØªØ±Ùƒ)
                foreach ($request->custom_fields as $fieldId => $value) {
                    $values = is_array($value) ? $value : [$value];
                    
                    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø¥Ù„Ù‰ ØµÙŠØºØ© Ø¨Ø­Ø« Ø§Ù„Ù†Øµ Ø§Ù„ÙƒØ§Ù…Ù„ (Boolean Mode)
                    $matchQuery = implode(' ', array_map(function($v) {
                        $v = trim($v);
                        // Ø¥Ø¶Ø§ÙØ© + Ùˆ * Ù„ØªÙƒÙˆÙ† Ø¥Ù„Ø²Ø§Ù…ÙŠØ© ÙˆÙ…Ø¬Ø²Ø£Ø© - Ù‡Ø°Ø§ ÙŠØªØ·Ù„Ø¨ ØªÙ‡ÙŠØ¦Ø© Full-Text Index Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ value
                        return $v ? "+" . $v . "*" : ""; 
                    }, $values));

                    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… whereIn Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ±Ø¹ÙŠØ©
                    $query->whereIn('items.id', function ($subQuery) use ($fieldId, $matchQuery) {
                        $subQuery->select('icfv.item_id')
                            ->from('item_custom_field_values as icfv')
                            ->where('icfv.custom_field_id', $fieldId)
                            // Ø§Ø³ØªØ®Ø¯Ø§Ù… MATCH AGAINST Ø§Ù„Ù…ÙÙÙ‡Ø±Ø³ (Full-Text Search)
                            ->whereRaw("MATCH(icfv.value) AGAINST (? IN BOOLEAN MODE)", [$matchQuery]);
                    });
                }
            }
            
            // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Area/City/State/Country)
            $query->where(function ($q) use ($request) {
                $hasArea = $request->filled('area_id');
                $hasCity = $request->filled('city');
                $hasState = $request->filled('state');
                $hasCountry = $request->filled('country');

                $q->when($hasArea, fn($sq) => $sq->where('area_id', $request->area_id))
                    ->orWhere(fn($sq) => $sq->when(!$hasArea && $hasCity, fn($ssq) => $ssq->where('city', $request->city)))
                    ->orWhere(fn($sq) => $sq->when(!$hasArea && !$hasCity && $hasState, fn($ssq) => $ssq->where('state', $request->state)))
                    ->orWhere(fn($sq) => $sq->when(!$hasArea && !$hasCity && !$hasState && $hasCountry, fn($ssq) => $ssq->where('country', $request->country)));
            });

            // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ù€ Slug
            $query->when($request->filled('user_id'), fn($q) => $q->where('user_id', $request->user_id));
            $query->when($request->filled('slug'), fn($q) => $q->where('slug', $request->slug));

            // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø© (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Cache)
            $query->when($request->filled('category_id'), fn($q) => $q->whereIn('category_id', cache()->remember(
                "category_children_{$request->category_id}", now()->addHours(12),
                fn() => HelperService::findAllCategoryIds(Category::where('id', $request->category_id)->with('children')->first() ?? collect())
            )));

            $query->when($request->filled('category_slug'), fn($q) => $q->whereIn('category_id', cache()->remember(
                "category_slug_{$request->category_slug}", now()->addHours(12),
                fn() => HelperService::findAllCategoryIds(Category::where('slug', $request->category_slug)->with('children')->first() ?? collect())
            )));

            // Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø± (Price Range)
            $query->when($request->min_price || $request->max_price, fn($q) => $q->whereBetween('price', [
                $request->min_price ?? 0,
                $request->max_price ?? 999999999
            ]));

            // ÙØªØ±Ø© Ø§Ù„Ù†Ø´Ø± (Posted Since)
            $query->when($request->filled('posted_since'), function ($q) use ($request) {
                $date = match ($request->posted_since) {
                    'today'             => now()->startOfDay(),
                    'within-1-week'     => now()->subDays(7),
                    'within-2-week'     => now()->subDays(14),
                    'within-1-month'    => now()->subMonthNoOverflow(),
                    'within-3-month'    => now()->subMonthsNoOverflow(3),
                    default             => now()->subYears(100),
                };
                $q->where('created_at', '>=', $date);
            });

            // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ Ø§Ù„Ø¹Ø§Ù… (General Search)
            if ($request->has('search') && strlen(trim($request->search ?? '')) >= 2) {
                // ÙŠÙØªØ±Ø¶ Ø£Ù† Ø¯Ø§Ù„Ø© search() Ù‡ÙŠ Ø¯Ø§Ù„Ø© Scope ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Item ÙˆØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ Ø§Ù„ÙƒØ§Ù…Ù„
                $query->search(trim($request->search));
            }

            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙØ±Ø² ÙˆØ§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„ØªØµÙÙŠØ© Ø§Ù„Ø®Ø§ØµØ© (Featured) - ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…ÙŠØ«ÙˆØ¯ Ù…Ù† Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ø£Ø¨
            // ÙŠØ¬Ø¨ ØªÙˆÙØ± applyCommonModifiers ÙÙŠ Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ø£Ø¨
            $query = $this->applyCommonModifiers($query, $request);

            // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„Ù†Ø·Ø§Ù‚ (Auth & Scoping)
            if (Auth::check()) {
                $query->with([
                    // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙƒ Ø¹Ù„Ø§Ù‚Ø© item_offers Ùˆ user_reports Ù…Ø¹Ø±ÙØ© ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Item
                    'item_offers' => fn($q) => $q->where('buyer_id', Auth::id()),
                    'user_reports' => fn($q) => $q->where('user_id', Auth::id())
                ]);

                if (str($request->getRequestUri())->contains('/api/my-items')) {
                    $query->where('user_id', Auth::id())->withTrashed();
                } else {
                    $query->where('status', 'approved')
                        ->has('user')
                        ->onlyNonBlockedUsers()
                        ->getNonExpiredItems();
                }
            } else {
                $query->where('status', 'approved')->getNonExpiredItems();
            }

            // ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… ÙˆØ¬Ù„Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            $result = $query->paginate($request->limit ?? 15);

            // ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ItemCollection Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ù€ Resource Collection Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
            // (Ø³Ø£Ø³ØªØ®Ø¯Ù… Ø§Ø³Ù… ItemCollection Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹)
            // Ø¨Ù…Ø§ Ø£Ù† ItemCollection ØºÙŠØ± Ù…Ø¹Ø±Ù‘ÙŽÙØŒ Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Resource Ø¹Ø§Ø¯ÙŠ Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„ØªØ¬Ù†Ø¨ Ø£Ø®Ø·Ø§Ø¡ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯
            // $response = ResponseService::successResponse("Advertisement Fetched Successfully", new ItemCollection($result));

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… ResponseService::successResponse Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø­Ù„ Ù…Ø´ÙƒÙ„Ø© ItemCollection ØºÙŠØ± Ø§Ù„Ù…Ø¹Ø±Ù‘ÙŽÙ
            return ResponseService::successResponse("Advertisement Fetched Successfully", $result);


        } catch (Throwable $th) {
            \Log::error('getItem Error: ' . $th->getMessage(), ['trace' => $th->getTraceAsString()]);
            return ResponseService::logErrorResponse($th, "API Controller -> getItem");
        }
    }
    
    // ----------------------------------------------------------------------------------
    // Ø¯ÙˆØ§Ù„ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© (Caching Management)
    // ----------------------------------------------------------------------------------

    /**
     * ÙŠØ­Ø³Ø¨ Ù…ÙØªØ§Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© (Cache Key) Ù„Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ID ÙˆÙ…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø·Ù„Ø¨Ù‹Ø§ Ø®Ø§ØµÙ‹Ø§.
     *
     * @param int $itemId
     * @param Request $request
     * @return string
     */
    protected function calculateItemCacheKey(int $itemId, Request $request): string
    {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ Ù…ÙˆØ¬Ù‡Ø§Ù‹ Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø± 'my-items'
        $isMyItemRequest = str($request->getRequestUri())->contains('/api/my-items');
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø·Ù„Ø¨Ù‹Ø§ Ø®Ø§ØµÙ‹Ø§ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (My Items) ÙˆÙ…Ø±ØªØ¨Ø·Ù‹Ø§ Ø¨Ù…Ø³ØªØ®Ø¯Ù… Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡
        // Ù†Ø³ØªØ®Ø¯Ù… Auth::check() Ù„Ø¶Ù…Ø§Ù† Ø£Ù† Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø®Ø§Øµ Ù…Ø±ØªØ¨Ø· Ø¨Ù…Ø³ØªØ®Ø¯Ù…
        $isUserSpecific = $isMyItemRequest && Auth::check();
        
        $modifier = $isUserSpecific ? '_my_item_' . Auth::id() : '_public';
        
        return 'item_details_' . $itemId . $modifier;
    }

    /**
     * ÙŠÙ…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø¥Ø¹Ù„Ø§Ù† Ù…Ø¹ÙŠÙ† Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„Ù‡.
     * (ØªÙ…Øª Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ù…ÙŠØªÙ‡Ø§ Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„ØªØ¶Ø§Ø±Ø¨ Ù…Ø¹ Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ø£Ø¨)
     * ÙŠØ¬Ø¨ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙŠ Ø¯ÙˆØ§Ù„ Ù…Ø«Ù„ handleUpdateItem, handleDeleteItem, handleChangeStatus.
     *
     * @param int $itemId
     * @return void
     */
    public function clearItemCache(int $itemId): void
    {
        // Ù…Ø³Ø­ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¹Ø§Ù… (Public Key)
        $publicKey = 'item_details_' . $itemId . '_public';
        Cache::forget($publicKey);

        // Ù…Ø³Ø­ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³Ø¬Ù„Ø§Ù‹ Ù„Ù„Ø¯Ø®ÙˆÙ„ (Ø¹Ø§Ø¯Ø©Ù‹ ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ø°ÙŠ ÙŠØ­Ø±Ø±)
        if (Auth::check()) {
            // Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø®Ø§Øµ ÙŠØªØ¶Ù…Ù† ID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ÙŠÙƒÙˆÙ† ÙØ±ÙŠØ¯Ø§Ù‹
            $privateKey = 'item_details_' . $itemId . '_my_item_' . Auth::id();
            Cache::forget($privateKey);
        }
        
        \Log::info("ØªÙ… Ù…Ø³Ø­ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ø¥Ø¹Ù„Ø§Ù† ID: {$itemId}.");
    }
    
    // ----------------------------------------------------------------------------------
    // Ø£Ù…Ø«Ù„Ø© (Ø§ÙØªØ±Ø§Ø¶ÙŠØ©) Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØªÙŠ ÙŠØ¬Ø¨ Ø£Ù† ØªØ³ØªØ¯Ø¹ÙŠ clearItemCache
    // ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ù„ØªÙØ§Ø¯ÙŠ ØªØ¶Ø§Ø±Ø¨ 'Cannot redeclare'
    // ----------------------------------------------------------------------------------

    /**
     * Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Update Item)
     *
     * @param Request $request
     * @param int $itemId
     * @return \Illuminate\Http\JsonResponse
     */
    public function handleUpdateItem(Request $request, int $itemId)
    {
        // 1. Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ù‚Ù‚ ÙˆØ§Ù„ØªØ­Ø¯ÙŠØ«
        $item = Item::findOrFail($itemId);
        // $item->update($request->validated()); 
        // ... (Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙØ¹Ù„ÙŠ) ...

        // 2. Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
        $this->clearItemCache($itemId);

        return ResponseService::successResponse("Advertisement Updated Successfully");
    }

    /**
     * Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Change Status)
     *
     * @param Request $request
     * @param int $itemId
     * @return \Illuminate\Http\JsonResponse
     */
    public function handleChangeStatus(Request $request, int $itemId)
    {
        // 1. Ù…Ù†Ø·Ù‚ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©
        $item = Item::findOrFail($itemId);
        // $item->update(['status' => $request->new_status]);
        // ... (Ù…Ù†Ø·Ù‚ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„ÙØ¹Ù„ÙŠ) ...

        // 2. Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¨Ø¹Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©
        $this->clearItemCache($itemId);

        return ResponseService::successResponse("Advertisement Status Changed Successfully");
    }

    /**
     * Ù…Ø«Ø§Ù„ Ø¹Ù„Ù‰ Ø­Ø°Ù Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† (Delete Item)
     *
     * @param int $itemId
     * @return \Illuminate\Http\JsonResponse
     */
    public function handleDeleteItem(int $itemId)
    {
        // 1. Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø°Ù (Soft Delete Ø£Ùˆ Force Delete)
        $item = Item::findOrFail($itemId);
        // $item->delete(); 
        // ... (Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø°Ù Ø§Ù„ÙØ¹Ù„ÙŠ) ...

        // 2. Ù…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø¨Ø¹Ø¯ Ø§Ù„Ø­Ø°Ù
        $this->clearItemCache($itemId);

        return ResponseService::successResponse("Advertisement Deleted Successfully");
    }


 public function getItemnewnew(Request $request)
    {
        // ... (Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª) ...
        $validator = Validator::make($request->all(), [
            'limit' => 'nullable|integer',
            'offset' => 'nullable|integer',
            'id' => 'nullable|integer',
            // ... Ø¨Ù‚ÙŠØ© Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ ...
            'custom_fields' => 'nullable|array',
            'category_id' => 'nullable',
            'category_slug' => 'nullable|string',
            'user_id' => 'nullable',
            'min_price' => 'nullable|numeric',
            'max_price' => 'nullable|numeric',
            'sort_by' => 'nullable|in:new-to-old,old-to-new,price-high-to-low,price-low-to-high,popular_items',
            'posted_since' => 'nullable|in:all-time,today,within-1-week,within-2-week,within-1-month,within-3-month',
            'area_id' => 'nullable',
            'city' => 'nullable|string',
            'state' => 'nullable|string',
            'country' => 'nullable|string',
            'latitude' => 'nullable|numeric',
            'longitude' => 'nullable|numeric',
            'radius' => 'nullable|numeric',
            'search' => 'nullable|string',
            'featured_section_id' => 'nullable',
            'featured_section_slug' => 'nullable|string',
            'status' => 'nullable|string',
            'slug' => 'nullable|string',
        ]);

        if ($validator->fails()) {
            return ResponseService::validationError($validator->errors()->first());
        }

        try {
            // Ø­Ø§Ù„Ø© Ø®Ø§ØµØ©: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ø±ÙŠÙ‚ ID (ØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„ØªÙ‚Ù„ÙŠÙ„ TTFB)
            if ($request->filled('id')) {
                $itemId = $request->id;
                
                // Ø¥Ù†Ø´Ø§Ø¡ Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
                $cacheKey = $this->getItemCacheKey($itemId, $request);
                
                // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ù…Ù† Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø£ÙˆÙ„Ø§Ù‹
                $cachedResponse = Cache::get($cacheKey);
                
                if ($cachedResponse) {
                    return $cachedResponse;
                }

                $query = Item::with([
                    'user:id,name,email,mobile,profile,created_at,is_verified,show_personal_details,country_code',
                    'category:id,name,image,is_job_category,price_optional',
                    'item_custom_field_values.custom_field',
                    'gallery_images:id,image,item_id',
                    'area', 'featured_items', 'favourites',
                ])
                    ->withCount(['featured_items', 'job_applications'])
                    ->where('id', $itemId);

                // Ù…Ù†Ø·Ù‚ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù†Ø·Ø§Ù‚ (Scoping)
                $isMyItemRequest = str($request->getRequestUri())->contains('/api/my-items');
                
                if ($isMyItemRequest && Auth::check()) {
                    $query->where('user_id', Auth::id())->withTrashed();
                } else {
                    $query->where('status', 'approved')->getNonExpiredItems()->has('user')->onlyNonBlockedUsers();
                }
                
                $item = $query->first();

                if (!$item) return ResponseService::errorResponse("No item Found");

                // ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ItemCollection Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ù€ Resource Collection Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
                $response = ResponseService::successResponse("Advertisement Fetched Successfully", new ItemCollection(collect([$item])));
                
                // ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù„Ù…Ø¯Ø© 10 Ø¯Ù‚Ø§Ø¦Ù‚
                Cache::put($cacheKey, $response, now()->addMinutes(10));

                return $response;
            }
            
            // Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØµÙÙŠØ©
            $query = Item::with([
                'user:id,name,email,mobile,profile,created_at,is_verified,show_personal_details,country_code',
                'category:id,name,image,is_job_category,price_optional',
                'item_custom_field_values.custom_field',
                'gallery_images:id,image,item_id',
                'area', 'featured_items', 'favourites',
            ])
                ->withCount(['featured_items', 'job_applications'])
                ->select('items.*');

            // ðŸŒ Ø§Ù„ØªØµÙÙŠØ© Ø¹Ù„Ù‰ Ø£Ø³Ø§Ø³ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ (Haversine + Bounding Box)
            if ($request->filled('latitude') && $request->filled('longitude') && $request->filled('radius')) {
                $lat = (float) $request->latitude;
                $lon = (float) $request->longitude;
                $radius = (float) $request->radius;

                // 1. ØªØ·Ø¨ÙŠÙ‚ Bounding Box Ù„ØªØ¶ÙŠÙŠÙ‚ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ
                $latDelta = $radius / 111.0;
                $lonDelta = $radius / (111.0 * max(0.1, cos(deg2rad($lat))));

                $query->whereBetween('latitude', [$lat - $latDelta, $lat + $latDelta])
                      ->whereBetween('longitude', [$lon - $lonDelta, $lon + $lonDelta]);
                      
                // 2. ØªØ·Ø¨ÙŠÙ‚ Haversine ÙˆØ¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„Ù„ÙØ±Ø²
                $query->selectRaw("items.*,
                     (6371 * acos(
                         cos(radians(?)) *
                         cos(radians(latitude)) *
                         cos(radians(longitude) - radians(?)) +
                         sin(radians(?)) *
                         sin(radians(latitude))
                     )) AS distance", [$lat, $lon, $lat]);

                // 3. Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
                $query->having('distance', '<=', $radius)
                    ->orderBy('distance');
            }


            // âš¡ï¸ Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø­Ø§Ø³Ù…: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª ÙØ±Ø¹ÙŠØ© Ù…ÙØ¯Ù…Ø¬Ø© Ù„Ù€ custom_fields
            if ($request->filled('custom_fields') && is_array($request->custom_fields)) {
                
                // ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø´Ø±Ø· whereIn Ù„ÙƒÙ„ Ø­Ù‚Ù„ Ù…Ø®ØµØµØŒ Ù…Ù…Ø§ ÙŠÙØ±Ø¶ Ù…Ù†Ø·Ù‚ AND (Ø§Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø´ØªØ±Ùƒ)
                foreach ($request->custom_fields as $fieldId => $value) {
                    $values = is_array($value) ? $value : [$value];
                    
                    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø¥Ù„Ù‰ ØµÙŠØºØ© Ø¨Ø­Ø« Ø§Ù„Ù†Øµ Ø§Ù„ÙƒØ§Ù…Ù„ (Boolean Mode)
                    $matchQuery = implode(' ', array_map(function($v) {
                        $v = trim($v);
                        // Ø¥Ø¶Ø§ÙØ© + Ùˆ * Ù„ØªÙƒÙˆÙ† Ø¥Ù„Ø²Ø§Ù…ÙŠØ© ÙˆÙ…Ø¬Ø²Ø£Ø© - Ù‡Ø°Ø§ ÙŠØªØ·Ù„Ø¨ ØªÙ‡ÙŠØ¦Ø© Full-Text Index Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ value
                        return $v ? "+" . $v . "*" : ""; 
                    }, $values));

                    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… whereIn Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ±Ø¹ÙŠØ©
                    $query->whereIn('items.id', function ($subQuery) use ($fieldId, $matchQuery) {
                        $subQuery->select('icfv.item_id')
                            ->from('item_custom_field_values as icfv')
                            ->where('icfv.custom_field_id', $fieldId)
                            // Ø§Ø³ØªØ®Ø¯Ø§Ù… MATCH AGAINST Ø§Ù„Ù…ÙÙÙ‡Ø±Ø³ (Full-Text Search)
                            ->whereRaw("MATCH(icfv.value) AGAINST (? IN BOOLEAN MODE)", [$matchQuery]);
                    });
                }
            }
            
            // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Area/City/State/Country)
            $query->where(function ($q) use ($request) {
                $hasArea = $request->filled('area_id');
                $hasCity = $request->filled('city');
                $hasState = $request->filled('state');
                $hasCountry = $request->filled('country');

                $q->when($hasArea, fn($sq) => $sq->where('area_id', $request->area_id))
                    ->orWhere(fn($sq) => $sq->when(!$hasArea && $hasCity, fn($ssq) => $ssq->where('city', $request->city)))
                    ->orWhere(fn($sq) => $sq->when(!$hasArea && !$hasCity && $hasState, fn($ssq) => $ssq->where('state', $request->state)))
                    ->orWhere(fn($sq) => $sq->when(!$hasArea && !$hasCity && !$hasState && $hasCountry, fn($ssq) => $ssq->where('country', $request->country)));
            });

            // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ù€ Slug
            $query->when($request->filled('user_id'), fn($q) => $q->where('user_id', $request->user_id));
            $query->when($request->filled('slug'), fn($q) => $q->where('slug', $request->slug));

            // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø© (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Cache)
            $query->when($request->filled('category_id'), fn($q) => $q->whereIn('category_id', cache()->remember(
                "category_children_{$request->category_id}", now()->addHours(12),
                fn() => HelperService::findAllCategoryIds(Category::where('id', $request->category_id)->with('children')->first() ?? collect())
            )));

            $query->when($request->filled('category_slug'), fn($q) => $q->whereIn('category_id', cache()->remember(
                "category_slug_{$request->category_slug}", now()->addHours(12),
                fn() => HelperService::findAllCategoryIds(Category::where('slug', $request->category_slug)->with('children')->first() ?? collect())
            )));

            // Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø± (Price Range)
            $query->when($request->min_price || $request->max_price, fn($q) => $q->whereBetween('price', [
                $request->min_price ?? 0,
                $request->max_price ?? 999999999
            ]));

            // ÙØªØ±Ø© Ø§Ù„Ù†Ø´Ø± (Posted Since)
            $query->when($request->filled('posted_since'), function ($q) use ($request) {
                $date = match ($request->posted_since) {
                    'today'             => now()->startOfDay(),
                    'within-1-week'     => now()->subDays(7),
                    'within-2-week'     => now()->subDays(14),
                    'within-1-month'    => now()->subMonthNoOverflow(),
                    'within-3-month'    => now()->subMonthsNoOverflow(3),
                    default             => now()->subYears(100),
                };
                $q->where('created_at', '>=', $date);
            });

            // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ Ø§Ù„Ø¹Ø§Ù… (General Search)
            if ($request->has('search') && strlen(trim($request->search ?? '')) >= 2) {
                // ÙŠÙØªØ±Ø¶ Ø£Ù† Ø¯Ø§Ù„Ø© search() Ù‡ÙŠ Ø¯Ø§Ù„Ø© Scope ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Item ÙˆØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ Ø§Ù„ÙƒØ§Ù…Ù„
                $query->search(trim($request->search));
            }

            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙØ±Ø² ÙˆØ§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„ØªØµÙÙŠØ© Ø§Ù„Ø®Ø§ØµØ© (Featured) - ÙŠØªÙ… Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ø§Ù„Ù…ÙŠØ«ÙˆØ¯ Ù…Ù† Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ø£Ø¨
            $query = $this->applyCommonModifiers($query, $request);

            // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„Ù†Ø·Ø§Ù‚ (Auth & Scoping)
            if (Auth::check()) {
                $query->with([
                    // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙƒ Ø¹Ù„Ø§Ù‚Ø© item_offers Ùˆ user_reports Ù…Ø¹Ø±ÙØ© ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Item
                    'item_offers' => fn($q) => $q->where('buyer_id', Auth::id()),
                    'user_reports' => fn($q) => $q->where('user_id', Auth::id())
                ]);

                if (str($request->getRequestUri())->contains('/api/my-items')) {
                    $query->where('user_id', Auth::id())->withTrashed();
                } else {
                    $query->where('status', 'approved')
                        ->has('user')
                        ->onlyNonBlockedUsers()
                        ->getNonExpiredItems();
                }
            } else {
                $query->where('status', 'approved')->getNonExpiredItems();
            }

            // ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… ÙˆØ¬Ù„Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            $result = $query->paginate($request->limit ?? 15);

            // ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ItemCollection Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ù€ Resource Collection Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
            // (Ø³Ø£Ø³ØªØ®Ø¯Ù… Ø§Ø³Ù… ItemCollection Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹)
            return ResponseService::successResponse("Advertisement Fetched Successfully", new ItemCollection($result));

        } catch (Throwable $th) {
            \Log::error('getItem Error: ' . $th->getMessage(), ['trace' => $th->getTraceAsString()]);
            return ResponseService::logErrorResponse($th, "API Controller -> getItem");
        }
    }
    
    // ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ÙŠØ«ÙˆØ¯ applyCommonModifiers Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„ØªØ¹Ø§Ø±Ø¶ Ù…Ø¹ Ø§Ù„ÙƒÙ„Ø§Ø³ Ø§Ù„Ø£Ø¨ (ApiController)
    // -------------------------------------------------------------------------
    
    /**
     * ÙŠØ­Ø³Ø¨ Ù…ÙØªØ§Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© (Cache Key) Ù„Ù„Ø¥Ø¹Ù„Ø§Ù† Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ ID ÙˆÙ…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø·Ù„Ø¨Ù‹Ø§ Ø®Ø§ØµÙ‹Ø§.
     *
     * @param int $itemId
     * @param Request $request
     * @return string
     */
    protected function getItemCacheKey(int $itemId, Request $request): string
    {
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù…Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø·Ù„Ø¨ Ù…ÙˆØ¬Ù‡Ø§Ù‹ Ø¥Ù„Ù‰ Ù…Ø³Ø§Ø± 'my-items'
        $isMyItemRequest = str($request->getRequestUri())->contains('/api/my-items');
        
        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø·Ù„Ø¨Ù‹Ø§ Ø®Ø§ØµÙ‹Ø§ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (My Items) ÙˆÙ…Ø±ØªØ¨Ø·Ù‹Ø§ Ø¨Ù…Ø³ØªØ®Ø¯Ù… Ù…ØµØ§Ø¯Ù‚ Ø¹Ù„ÙŠÙ‡
        $isUserSpecific = $isMyItemRequest && Auth::check();
        
        $modifier = $isUserSpecific ? '_my_item_' . Auth::id() : '_public';
        
        return 'item_details_' . $itemId . $modifier;
    }

    /**
     * ÙŠÙ…Ø³Ø­ Ø§Ù„Ø°Ø§ÙƒØ±Ø© Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø¥Ø¹Ù„Ø§Ù† Ù…Ø¹ÙŠÙ† Ø¹Ù†Ø¯ ØªØ¹Ø¯ÙŠÙ„Ù‡.
     * ÙŠØ¬Ø¨ Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ù„Ø© ÙÙŠ Ø¯ÙˆØ§Ù„ Ù…Ø«Ù„ updateItem, deleteItem, changeStatus.
     *
     * @param int $itemId
     * @return void
     */
    public function bustItemCache(int $itemId): void
    {
        // Ù…Ø³Ø­ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø¹Ø§Ù… (Public Key)
        $publicKey = 'item_details_' . $itemId . '_public';
        Cache::forget($publicKey);

        // Ù…Ø³Ø­ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…Ø³Ø¬Ù„Ø§Ù‹ Ù„Ù„Ø¯Ø®ÙˆÙ„ (Ø¹Ø§Ø¯Ø©Ù‹ ÙŠÙƒÙˆÙ† Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ø°ÙŠ ÙŠØ­Ø±Ø±)
        if (Auth::check()) {
            $privateKey = 'item_details_' . $itemId . '_my_item_' . Auth::id();
            Cache::forget($privateKey);
        }
        
        \Log::info("ØªÙ… Ù…Ø³Ø­ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª Ù„Ù„Ø¥Ø¹Ù„Ø§Ù† ID: {$itemId}.");
    }

public function getItemnew(Request $request) {
        // ... (Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ù…Ø¯Ø®Ù„Ø§Øª) ...
        $validator = Validator::make($request->all(), [
            'limit' => 'nullable|integer',
            'offset' => 'nullable|integer',
            'id' => 'nullable|integer',
            // ... Ø¨Ù‚ÙŠØ© Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚ ...
            'custom_fields' => 'nullable|array',
            'category_id' => 'nullable',
            'category_slug' => 'nullable|string',
            'user_id' => 'nullable',
            'min_price' => 'nullable|numeric',
            'max_price' => 'nullable|numeric',
            'sort_by' => 'nullable|in:new-to-old,old-to-new,price-high-to-low,price-low-to-high,popular_items',
            'posted_since' => 'nullable|in:all-time,today,within-1-week,within-2-week,within-1-month,within-3-month',
            'area_id' => 'nullable',
            'city' => 'nullable|string',
            'state' => 'nullable|string',
            'country' => 'nullable|string',
            'latitude' => 'nullable|numeric',
            'longitude' => 'nullable|numeric',
            'radius' => 'nullable|numeric',
            'search' => 'nullable|string',
            'featured_section_id' => 'nullable',
            'featured_section_slug' => 'nullable|string',
            'status' => 'nullable|string',
            'slug' => 'nullable|string',
        ]);

        if ($validator->fails()) {
            return ResponseService::validationError($validator->errors()->first());
        }

        try {
            // Ø­Ø§Ù„Ø© Ø®Ø§ØµØ©: Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø·Ø±ÙŠÙ‚ ID (Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¨Ø¯ÙˆÙ† Cache)
            if ($request->filled('id')) {
                $itemId = $request->id;

                $query = Item::with([
                    // ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙŠ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ù‚Ø¯Ø± Ø§Ù„Ø¥Ù…ÙƒØ§Ù†
                    'user:id,name,email,mobile,profile,created_at,is_verified,show_personal_details,country_code',
                    'category:id,name,image,is_job_category,price_optional',
                    // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© item_custom_field_values Ù…Ø­Ø¯Ø¯Ø© Ø¬ÙŠØ¯Ø§Ù‹
                    'item_custom_field_values.custom_field',
                    'gallery_images:id,image,item_id',
                    // Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªÙ‚Ù„ÙŠÙ„ Ø£Ø¹Ù…Ø¯Ø© area, featured_items, favourites ÙƒØ«ÙŠØ±Ø§Ù‹
                    'area', 'featured_items', 'favourites',
                ])
                    ->withCount(['featured_items', 'job_applications'])
                    ->where('id', $itemId);

                // ÙØµÙ„ Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„Ù€ Scope Ù„ÙŠÙƒÙˆÙ† Ø£ÙƒØ«Ø± ÙˆØ¶ÙˆØ­Ø§Ù‹
                $isMyItemRequest = str($request->getRequestUri())->contains('/api/my-items');
                
                if ($isMyItemRequest && Auth::check()) {
                    $query->where('user_id', Auth::id())->withTrashed();
                } else {
                    $query->where('status', 'approved')->getNonExpiredItems()->has('user')->onlyNonBlockedUsers();
                }
                
                $item = $query->first();

                if (!$item) return ResponseService::errorResponse("No item Found");

                // ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ItemCollection Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ù€ Resource Collection Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
                return ResponseService::successResponse("Advertisement Fetched Successfully", new ItemCollection(collect([$item])));
            }
            
            // Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù„Ø¨Ø¯Ø¡ Ø§Ù„ØªØµÙÙŠØ©
            $query = Item::with([
                'user:id,name,email,mobile,profile,created_at,is_verified,show_personal_details,country_code',
                'category:id,name,image,is_job_category,price_optional',
                'item_custom_field_values.custom_field',
                'gallery_images:id,image,item_id',
                'area', 'featured_items', 'favourites',
            ])
                ->withCount(['featured_items', 'job_applications'])
                ->select('items.*');

            // ðŸŒ Ø§Ù„ØªØµÙÙŠØ© Ø¹Ù„Ù‰ Ø£Ø³Ø§Ø³ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ (Haversine + Bounding Box)
            if ($request->filled('latitude') && $request->filled('longitude') && $request->filled('radius')) {
                $lat = (float) $request->latitude;
                $lon = (float) $request->longitude;
                $radius = (float) $request->radius;

                // 1. ØªØ·Ø¨ÙŠÙ‚ Bounding Box Ù„ØªØ¶ÙŠÙŠÙ‚ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø¨Ø¯Ø¦ÙŠ
                $latDelta = $radius / 111.0;
                $lonDelta = $radius / (111.0 * max(0.1, cos(deg2rad($lat))));

                $query->whereBetween('latitude', [$lat - $latDelta, $lat + $latDelta])
                      ->whereBetween('longitude', [$lon - $lonDelta, $lon + $lonDelta]);
                      
                // 2. ØªØ·Ø¨ÙŠÙ‚ Haversine ÙˆØ¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„Ù„ÙØ±Ø²
                $query->selectRaw("items.*,
                     (6371 * acos(
                         cos(radians(?)) *
                         cos(radians(latitude)) *
                         cos(radians(longitude) - radians(?)) +
                         sin(radians(?)) *
                         sin(radians(latitude))
                     )) AS distance", [$lat, $lon, $lat]);

                // 3. Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
                $query->having('distance', '<=', $radius)
                    ->orderBy('distance');
            }


            // âš¡ï¸ Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø­Ø§Ø³Ù…: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª ÙØ±Ø¹ÙŠØ© Ù…ÙØ¯Ù…Ø¬Ø© Ù„Ù€ custom_fields
            if ($request->filled('custom_fields') && is_array($request->custom_fields)) {
                
                // ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚ Ø´Ø±Ø· whereIn Ù„ÙƒÙ„ Ø­Ù‚Ù„ Ù…Ø®ØµØµØŒ Ù…Ù…Ø§ ÙŠÙØ±Ø¶ Ù…Ù†Ø·Ù‚ AND (Ø§Ù„ØªØ·Ø§Ø¨Ù‚ Ø§Ù„Ù…Ø´ØªØ±Ùƒ)
                foreach ($request->custom_fields as $fieldId => $value) {
                    $values = is_array($value) ? $value : [$value];
                    
                    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù‚ÙŠÙ… Ø¥Ù„Ù‰ ØµÙŠØºØ© Ø¨Ø­Ø« Ø§Ù„Ù†Øµ Ø§Ù„ÙƒØ§Ù…Ù„ (Boolean Mode)
                    $matchQuery = implode(' ', array_map(function($v) {
                        $v = trim($v);
                        // Ø¥Ø¶Ø§ÙØ© + Ùˆ * Ù„ØªÙƒÙˆÙ† Ø¥Ù„Ø²Ø§Ù…ÙŠØ© ÙˆÙ…Ø¬Ø²Ø£Ø© - Ù‡Ø°Ø§ ÙŠØªØ·Ù„Ø¨ ØªÙ‡ÙŠØ¦Ø© Full-Text Index Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ value
                        return $v ? "+" . $v . "*" : ""; 
                    }, $values));

                    // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØµÙÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… whereIn Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„ÙØ±Ø¹ÙŠØ©
                    $query->whereIn('items.id', function ($subQuery) use ($fieldId, $matchQuery) {
                        $subQuery->select('icfv.item_id')
                            ->from('item_custom_field_values as icfv')
                            ->where('icfv.custom_field_id', $fieldId)
                            // Ø§Ø³ØªØ®Ø¯Ø§Ù… MATCH AGAINST Ø§Ù„Ù…ÙÙÙ‡Ø±Ø³ (Full-Text Search)
                            ->whereRaw("MATCH(icfv.value) AGAINST (? IN BOOLEAN MODE)", [$matchQuery]);
                    });
                }
            }
            
            // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Area/City/State/Country)
            $query->where(function ($q) use ($request) {
                $hasArea = $request->filled('area_id');
                $hasCity = $request->filled('city');
                $hasState = $request->filled('state');
                $hasCountry = $request->filled('country');

                $q->when($hasArea, fn($sq) => $sq->where('area_id', $request->area_id))
                    ->orWhere(fn($sq) => $sq->when(!$hasArea && $hasCity, fn($ssq) => $ssq->where('city', $request->city)))
                    ->orWhere(fn($sq) => $sq->when(!$hasArea && !$hasCity && $hasState, fn($ssq) => $ssq->where('state', $request->state)))
                    ->orWhere(fn($sq) => $sq->when(!$hasArea && !$hasCity && !$hasState && $hasCountry, fn($ssq) => $ssq->where('country', $request->country)));
            });

            // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙˆØ§Ù„Ù€ Slug
            $query->when($request->filled('user_id'), fn($q) => $q->where('user_id', $request->user_id));
            $query->when($request->filled('slug'), fn($q) => $q->where('slug', $request->slug));

            // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø© (Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Cache)
            $query->when($request->filled('category_id'), fn($q) => $q->whereIn('category_id', cache()->remember(
                "category_children_{$request->category_id}", now()->addHours(12),
                fn() => HelperService::findAllCategoryIds(Category::where('id', $request->category_id)->with('children')->first() ?? collect())
            )));

            $query->when($request->filled('category_slug'), fn($q) => $q->whereIn('category_id', cache()->remember(
                "category_slug_{$request->category_slug}", now()->addHours(12),
                fn() => HelperService::findAllCategoryIds(Category::where('slug', $request->category_slug)->with('children')->first() ?? collect())
            )));

            // Ù†Ø·Ø§Ù‚ Ø§Ù„Ø³Ø¹Ø± (Price Range)
            $query->when($request->min_price || $request->max_price, fn($q) => $q->whereBetween('price', [
                $request->min_price ?? 0,
                $request->max_price ?? 999999999
            ]));

            // ÙØªØ±Ø© Ø§Ù„Ù†Ø´Ø± (Posted Since)
            $query->when($request->filled('posted_since'), function ($q) use ($request) {
                $date = match ($request->posted_since) {
                    'today'             => now()->startOfDay(),
                    'within-1-week'     => now()->subDays(7),
                    'within-2-week'     => now()->subDays(14),
                    'within-1-month'    => now()->subMonthNoOverflow(),
                    'within-3-month'    => now()->subMonthsNoOverflow(3),
                    default             => now()->subYears(100),
                };
                $q->where('created_at', '>=', $date);
            });

            // Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ Ø§Ù„Ø¹Ø§Ù… (General Search)
            if ($request->has('search') && strlen(trim($request->search ?? '')) >= 2) {
                // ÙŠÙØªØ±Ø¶ Ø£Ù† Ø¯Ø§Ù„Ø© search() Ù‡ÙŠ Ø¯Ø§Ù„Ø© Scope ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Item ÙˆØªØ³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù†ØµÙŠ Ø§Ù„ÙƒØ§Ù…Ù„
                $query->search(trim($request->search));
            }

            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙØ±Ø² ÙˆØ§Ù„Ø­Ø§Ù„Ø© ÙˆØ§Ù„ØªØµÙÙŠØ© Ø§Ù„Ø®Ø§ØµØ© (Featured)
            $query = $this->applyCommonModifiers($query, $request);

            // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ÙˆØ§Ù„Ù†Ø·Ø§Ù‚ (Auth & Scoping)
            if (Auth::check()) {
                $query->with([
                    // ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† Ù„Ø¯ÙŠÙƒ Ø¹Ù„Ø§Ù‚Ø© item_offers Ùˆ user_reports Ù…Ø¹Ø±ÙØ© ÙÙŠ Ù†Ù…ÙˆØ°Ø¬ Item
                    'item_offers' => fn($q) => $q->where('buyer_id', Auth::id()),
                    'user_reports' => fn($q) => $q->where('user_id', Auth::id())
                ]);

                if (str($request->getRequestUri())->contains('/api/my-items')) {
                    $query->where('user_id', Auth::id())->withTrashed();
                } else {
                    $query->where('status', 'approved')
                        ->has('user')
                        ->onlyNonBlockedUsers()
                        ->getNonExpiredItems();
                }
            } else {
                $query->where('status', 'approved')->getNonExpiredItems();
            }

            // ØªÙ†ÙÙŠØ° Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… ÙˆØ¬Ù„Ø¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬
            $result = $query->paginate($request->limit ?? 15);

            // ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ItemCollection Ø¨Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ù€ Resource Collection Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ
            // (Ø³Ø£Ø³ØªØ®Ø¯Ù… Ø§Ø³Ù… ItemCollection Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹)
            return ResponseService::successResponse("Advertisement Fetched Successfully", new ItemCollection($result));

        } catch (Throwable $th) {
            \Log::error('getItem Error: ' . $th->getMessage(), ['trace' => $th->getTraceAsString()]);
            return ResponseService::logErrorResponse($th, "API Controller -> wgetItem");
        }
    }
    
    /**
     * @param $sql
     * @param $request
     * @return mixed
     */
    private function applyCommonModifiers($sql, $request)
    {
        // ... (Ù…Ù†Ø·Ù‚ Ø§Ù„ÙØ±Ø² ÙˆØ§Ù„ØªØµÙÙŠØ© ÙƒÙ…Ø§ Ù‡Ùˆ) ...
        
        // Ù…Ù†Ø·Ù‚ Ø§Ù„ÙØ±Ø² (Sorting)
        if ($request->sort_by == "new-to-old") {
            $sql->orderBy('id', 'DESC');
        } elseif ($request->sort_by == "old-to-new") {
            $sql->orderBy('id', 'ASC');
        } elseif ($request->sort_by == "price-high-to-low") {
            $sql->orderBy('price', 'DESC');
        } elseif ($request->sort_by == "price-low-to-high") {
            $sql->orderBy('price', 'ASC');
        } elseif ($request->sort_by == "popular_items") {
            // Ø§Ù„ÙØ±Ø² Ø­Ø³Ø¨ Ø§Ù„Ø£ÙƒØ«Ø± Ø´Ø¹Ø¨ÙŠØ© (ÙŠØªØ·Ù„Ø¨ ÙÙ‡Ø±Ø³Ù‹Ø§ Ø¹Ù„Ù‰ Ø¹Ù…ÙˆØ¯ 'clicks')
            $sql->orderBy('clicks', 'DESC');
        } else {
            $sql->orderBy('id', 'DESC');
        }

        // ØªØµÙÙŠØ© Ø§Ù„Ø­Ø§Ù„Ø© (Status Filtering)
        if (!empty($request->status)) {
            if (in_array($request->status, ['review', 'approved', 'rejected', 'sold out', 'soft rejected', 'permanent rejected'])) {
                $sql->where('status', $request->status)->getNonExpiredItems()->whereNull('deleted_at');
            } elseif ($request->status == 'inactive') {
                $sql->onlyTrashed()->getNonExpiredItems();
            } elseif ($request->status == 'featured') {
                $sql->where('status', 'approved')->has('featured_items')->getNonExpiredItems();
            } elseif ($request->status == 'expired') {
                $sql->whereNotNull('expiry_date')
                    ->where('expiry_date', '<', now())
                    ->where('deleted_at', null);
            }
        }

        // ØªØµÙÙŠØ© Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ù…Ù…ÙŠØ²Ø© (Featured Sections)
        if (!empty($request->featured_section_id) || !empty($request->featured_section_slug)) {
            $featuredSection = $request->featured_section_id
                ? FeatureSection::findOrFail($request->featured_section_id)
                : FeatureSection::where('slug', $request->featured_section_slug)->firstOrFail();

            match ($featuredSection->filter) {
                "price_criteria" => $sql->whereBetween('price', [$featuredSection->min_price, $featuredSection->max_price]),
                "most_viewed" => $sql->reorder()->orderBy('clicks', 'DESC'),
                "category_criteria" => $sql->whereIn('category_id', HelperService::findAllCategoryIds(
                    Category::whereIn('id', explode(',', $featuredSection->value))->with('children')->get()
                )),
                "most_liked" => $sql->reorder()->withCount('favourites')->orderBy('favourites_count', 'DESC'),
                default => null,
            };
        }

        return $sql;
    }

public function getItemspeed1(Request $request)
{
    $validator = Validator::make($request->all(), [
        'limit'                 => 'nullable|integer',
        'id'                    => 'nullable|integer',
        'custom_fields'         => 'nullable',
        'category_id'           => 'nullable',
        'category_slug'         => 'nullable|string',
        'user_id'               => 'nullable',
        'min_price'             => 'nullable|numeric',
        'max_price'             => 'nullable|numeric',
        'sort_by'               => 'nullable|in:new-to-old,old-to-new,price-high-to-low,price-low-to-high,popular_items',
        'posted_since'          => 'nullable|in:all-time,today,within-1-week,within-2-week,within-1-month,within-3-month',
        'area_id'               => 'nullable',
        'city'                  => 'nullable|string',
        'state'                 => 'nullable|string',
        'country'               => 'nullable|string',
        'latitude'              => 'nullable|numeric',
        'longitude'             => 'nullable|numeric',
        'radius'                => 'nullable|numeric',
        'search'                => 'nullable|string',
        'featured_section_id'   => 'nullable',
        'featured_section_slug' => 'nullable|string',
        'status'                => 'nullable|string',
        'slug'                  => 'nullable|string',
    ]);

    if ($validator->fails()) {
        return ResponseService::validationError($validator->errors()->first());
    }

    try {
        // === 1. Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ù€ ID ===
        if ($request->filled('id')) {
            $query = Item::with([
                'user:id,name,email,mobile,profile,created_at,is_verified,show_personal_details,country_code',
                'category:id,name,image,is_job_category,price_optional',
                'item_custom_field_values.custom_field',
                'gallery_images:id,image,item_id',
                'area', 'featured_items', 'favourites',
            ])->withCount(['featured_items', 'job_applications'])->where('id', $request->id);

            if (Auth::check() && strpos($request->path(), 'my-items') !== false) {
                $query->where('user_id', Auth::id())->withTrashed();
            } else {
                $query->where('status', 'approved')->getNonExpiredItems();
            }

            $item = $query->first();
            if (!$item) return ResponseService::errorResponse("No item Found");
            return ResponseService::successResponse("Advertisement Fetched Successfully", new ItemCollection(collect([$item])));
        }

        // === 2. Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ===
        $query = Item::with([
            'user:id,name,email,mobile,profile,created_at,is_verified,show_personal_details,country_code',
            'category:id,name,image,is_job_category,price_optional',
            'item_custom_field_values.custom_field',
            'gallery_images:id,image,item_id',
            'area', 'featured_items', 'favourites',
        ])->withCount(['featured_items', 'job_applications'])->select('items.*');

        // === 3. Radius ===
        if ($request->latitude && $request->longitude && $request->radius) {
            $lat = $request->latitude;
            $lon = $request->longitude;
            $radius = $request->radius;
            $query->selectRaw("items.*, (6371 * acos(cos(radians($lat)) * cos(radians(latitude)) * cos(radians(longitude) - radians($lon)) + sin(radians($lat)) * sin(radians(latitude)))) AS distance")
                  ->havingRaw("distance <= ?", [$radius])
                  ->orderBy('distance');
        }

        // === 4. Location fallback ===
        if ($request->filled('area_id')) {
            $query->where('area_id', $request->area_id);
        } elseif ($request->filled('city')) {
            $query->where('city', $request->city);
        } elseif ($request->filled('state')) {
            $query->where('state', $request->state);
        } elseif ($request->filled('country')) {
            $query->where('country', $request->country);
        }

        // === 5. Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙÙ„Ø§ØªØ± ===
        if ($request->filled('category_id')) {
            $ids = \Cache::remember("cat_{$request->category_id}", 3600, fn() => 
                HelperService::findAllCategoryIds(collect([Category::find($request->category_id)]->filter()))
            );
            $query->whereIn('category_id', $ids);
        }

        if ($request->filled('category_slug')) {
            $ids = \Cache::remember("slug_{$request->category_slug}", 3600, fn() => 
                HelperService::findAllCategoryIds(Category::where('slug', $request->category_slug)->get())
            );
            $query->whereIn('category_id', $ids);
        }

        if ($request->min_price || $request->max_price) {
            $query->whereBetween('price', [$request->min_price ?? 0, $request->max_price ?? 999999999]);
        }

        if ($request->filled('user_id')) $query->where('user_id', $request->user_id);
        if ($request->filled('slug')) $query->where('slug', $request->slug);
        if ($request->filled('search') && strlen($request->search) >= 2) $query->search($request->search);

        if ($request->filled('posted_since')) {
            $date = now()->subYears(100);
            if ($request->posted_since == 'today') $date = now()->startOfDay();
            elseif ($request->posted_since == 'within-1-week') $date = now()->subDays(7);
            elseif ($request->posted_since == 'within-2-week') $date = now()->subDays(14);
            elseif ($request->posted_since == 'within-1-month') $date = now()->subMonthNoOverflow();
            elseif ($request->posted_since == 'within-3-month') $date = now()->subMonthsNoOverflow(3);
            $query->where('created_at', '>=', $date);
        }

        // === 6. Custom Fields ===
        if ($request->has('custom_fields') && is_array($request->custom_fields)) {
            foreach ($request->custom_fields as $fieldId => $value) {
                $values = is_array($value) ? $value : [$value];
                $query->whereHas('item_custom_field_values', function($q) use ($fieldId, $values) {
                    $q->where('custom_field_id', $fieldId)->whereIn('value', $values);
                });
            }
        }

        // === 7. Sorting (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ø§Ù„Ø¶Ø¨Ø·) ===
        if ($request->sort_by == "new-to-old") {
            $query->orderBy('id', 'DESC');
        } elseif ($request->sort_by == "old-to-new") {
            $query->orderBy('id', 'ASC');
        } elseif ($request->sort_by == "price-high-to-low") {
            $query->orderBy('price', 'DESC');
        } elseif ($request->sort_by == "price-low-to-high") {
            $query->orderBy('price', 'ASC');
        } elseif ($request->sort_by == "popular_items") {
            $query->orderBy('clicks', 'DESC');
        } else {
            $query->orderBy('id', 'DESC');
        }

        // === 8. Auth & Status ===
        if (Auth::check()) {
            $query->with(['item_offers' => fn($q) => $q->where('buyer_id', Auth::id())]);
            $query->with(['user_reports' => fn($q) => $q->where('user_id', Auth::id())]);

            if (strpos($request->path(), 'my-items') !== false) {
                $query->where('user_id', Auth::id())->withTrashed();
            } else {
                $query->where('status', 'approved')->getNonExpiredItems();
            }
        } else {
            $query->where('status', 'approved')->getNonExpiredItems();
        }

        // === 9. Ø¬Ù„Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© ===
        $items = $query->paginate($request->limit ?? 15);

        return ResponseService::successResponse("Advertisement Fetched Successfully", new ItemCollection($items));

    } catch (\Throwable $e) {
        \Log::error("
getItem Fatal Error: " . $e->getMessage() . " in " . $e->getFile() . ":" . $e->getLine());
        return ResponseService::errorResponse("Something went wrong");
    }
}

public functiongetItemrr(Request $request)
{
    $validator = Validator::make($request->all(), [
        'limit'                 => 'nullable|integer',
        'id'                    => 'nullable|integer',
        'custom_fields'         => 'nullable',
        'category_id'           => 'nullable',
        'category_slug'         => 'nullable|string',
        'user_id'               => 'nullable',
        'min_price'             => 'nullable|numeric',
        'max_price'             => 'nullable|numeric',
        'sort_by'               => 'nullable|in:new-to-old,old-to-new,price-high-to-low,price-low-to-high,popular_items',
        'posted_since'          => 'nullable|in:all-time,today,within-1-week,within-2-week,within-1-month,within-3-month',
        'area_id'               => 'nullable',
        'city'                  => 'nullable|string',
        'state'                 => 'nullable|string',
        'country'               => 'nullable|string',
        'latitude'              => 'nullable|numeric',
        'longitude'             => 'nullable|numeric',
        'radius'                => 'nullable|numeric',
        'search'                => 'nullable|string',
        'featured_section_id'   => 'nullable',
        'featured_section_slug' => 'nullable|string',
        'status'                => 'nullable|string',
        'slug'                  => 'nullable|string',
    ]);

    if ($validator->fails()) {
        return ResponseService::validationError($validator->errors()->first());
    }

    try {
        // === 1. Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ù€ ID ===
        if ($request->filled('id')) {
            $query = Item::with([
                'user:id,name,email,mobile,profile,created_at,is_verified,show_personal_details,country_code',
                'category:id,name,image,is_job_category,price_optional',
                'item_custom_field_values.custom_field',
                'gallery_images:id,image,item_id',
                'area', 'featured_items', 'favourites',
            ])->withCount(['featured_items', 'job_applications'])->where('id', $request->id);

            if (Auth::check() && strpos($request->path(), 'my-items') !== false) {
                $query->where('user_id', Auth::id())->withTrashed();
            } else {
                $query->where('status', 'approved')->getNonExpiredItems();
            }

            $item = $query->first();
            if (!$item) return ResponseService::errorResponse("No item Found");
            return ResponseService::successResponse("Advertisement Fetched Successfully", new ItemCollection(collect([$item])));
        }

        // === 2. Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ===
        $query = Item::with([
            'user:id,name,email,mobile,profile,created_at,is_verified,show_personal_details,country_code',
            'category:id,name,image,is_job_category,price_optional',
            'item_custom_field_values.custom_field',
            'gallery_images:id,image,item_id',
            'area', 'featured_items', 'favourites',
        ])->withCount(['featured_items', 'job_applications'])->select('items.*');

        // === 3. Radius ===
        if ($request->latitude && $request->longitude && $request->radius) {
            $lat = $request->latitude;
            $lon = $request->longitude;
            $radius = $request->radius;
            $query->selectRaw("items.*, (6371 * acos(cos(radians($lat)) * cos(radians(latitude)) * cos(radians(longitude) - radians($lon)) + sin(radians($lat)) * sin(radians(latitude)))) AS distance")
                  ->havingRaw("distance <= ?", [$radius])
                  ->orderBy('distance');
        }

        // === 4. Location fallback ===
        if ($request->filled('area_id')) {
            $query->where('area_id', $request->area_id);
        } elseif ($request->filled('city')) {
            $query->where('city', $request->city);
        } elseif ($request->filled('state')) {
            $query->where('state', $request->state);
        } elseif ($request->filled('country')) {
            $query->where('country', $request->country);
        }

        // === 5. Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙÙ„Ø§ØªØ± ===
        if ($request->filled('category_id')) {
            $ids = \Cache::remember("cat_{$request->category_id}", 3600, fn() => 
                HelperService::findAllCategoryIds(collect([Category::find($request->category_id)]->filter()))
            );
            $query->whereIn('category_id', $ids);
        }

        if ($request->filled('category_slug')) {
            $ids = \Cache::remember("slug_{$request->category_slug}", 3600, fn() => 
                HelperService::findAllCategoryIds(Category::where('slug', $request->category_slug)->get())
            );
            $query->whereIn('category_id', $ids);
        }

        if ($request->min_price || $request->max_price) {
            $query->whereBetween('price', [$request->min_price ?? 0, $request->max_price ?? 999999999]);
        }

        if ($request->filled('user_id')) $query->where('user_id', $request->user_id);
        if ($request->filled('slug')) $query->where('slug', $request->slug);
        if ($request->filled('search') && strlen($request->search) >= 2) $query->search($request->search);

        if ($request->filled('posted_since')) {
            $date = now()->subYears(100);
            if ($request->posted_since == 'today') $date = now()->startOfDay();
            elseif ($request->posted_since == 'within-1-week') $date = now()->subDays(7);
            elseif ($request->posted_since == 'within-2-week') $date = now()->subDays(14);
            elseif ($request->posted_since == 'within-1-month') $date = now()->subMonthNoOverflow();
            elseif ($request->posted_since == 'within-3-month') $date = now()->subMonthsNoOverflow(3);
            $query->where('created_at', '>=', $date);
        }

        // === 6. Custom Fields ===
        if ($request->has('custom_fields') && is_array($request->custom_fields)) {
            foreach ($request->custom_fields as $fieldId => $value) {
                $values = is_array($value) ? $value : [$value];
                $query->whereHas('item_custom_field_values', function($q) use ($fieldId, $values) {
                    $q->where('custom_field_id', $fieldId)->whereIn('value', $values);
                });
            }
        }

        // === 7. Sorting (Ù†ÙØ³ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ø¨Ø§Ù„Ø¶Ø¨Ø·) ===
        if ($request->sort_by == "new-to-old") {
            $query->orderBy('id', 'DESC');
        } elseif ($request->sort_by == "old-to-new") {
            $query->orderBy('id', 'ASC');
        } elseif ($request->sort_by == "price-high-to-low") {
            $query->orderBy('price', 'DESC');
        } elseif ($request->sort_by == "price-low-to-high") {
            $query->orderBy('price', 'ASC');
        } elseif ($request->sort_by == "popular_items") {
            $query->orderBy('clicks', 'DESC');
        } else {
            $query->orderBy('id', 'DESC');
        }

        // === 8. Auth & Status ===
        if (Auth::check()) {
            $query->with(['item_offers' => fn($q) => $q->where('buyer_id', Auth::id())]);
            $query->with(['user_reports' => fn($q) => $q->where('user_id', Auth::id())]);

            if (strpos($request->path(), 'my-items') !== false) {
                $query->where('user_id', Auth::id())->withTrashed();
            } else {
                $query->where('status', 'approved')->getNonExpiredItems();
            }
        } else {
            $query->where('status', 'approved')->getNonExpiredItems();
        }

        // === 9. Ø¬Ù„Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© ===
        $items = $query->paginate($request->limit ?? 15);

        return ResponseService::successResponse("Advertisement Fetched Successfully", new ItemCollection($items));

    } catch (\Throwable $e) {
        \Log::error("getItem Fatal Error: " . $e->getMessage() . " in " . $e->getFile() . ":" . $e->getLine());
        return ResponseService::errorResponse("Something went wrong");
    }
}


public function getItemgg(Request $request)
    {
        // === 0. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Validation) ===
        $validator = Validator::make($request->all(), [
            'limit'                 => 'nullable|integer',
            'id'                    => 'nullable|integer',
            'custom_fields'         => 'nullable|array', // ØªÙ… ØªØºÙŠÙŠØ±Ù‡Ø§ Ø¥Ù„Ù‰ array
            'category_id'           => 'nullable|integer',
            'category_slug'         => 'nullable|string',
            'user_id'               => 'nullable|integer',
            'min_price'             => 'nullable|numeric',
            'max_price'             => 'nullable|numeric',
            'sort_by'               => 'nullable|in:new-to-old,old-to-new,price-high-to-low,price-low-to-high,popular_items',
            'posted_since'          => 'nullable|in:all-time,today,within-1-week,within-2-week,within-1-month,within-3-month',
            'area_id'               => 'nullable|integer',
            'city'                  => 'nullable|string',
            'state'                 => 'nullable|string',
            'country'               => 'nullable|string',
            'latitude'              => 'nullable|numeric',
            'longitude'             => 'nullable|numeric',
            'radius'                => 'nullable|numeric',
            'search'                => 'nullable|string|min:2', // ØªÙ… Ø¥Ø¶Ø§ÙØ© min:2
            'featured_section_id'   => 'nullable|integer',
            'featured_section_slug' => 'nullable|string',
            'status'                => 'nullable|string',
            'slug'                  => 'nullable|string',
        ]);

        if ($validator->fails()) {
            return ResponseService::validationError($validator->errors()->first());
        }

        try {
            // === 1. Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ù€ ID (ID Search Case) ===
            if ($request->filled('id')) {
                $query = Item::with([
                    'user:id,name,email,mobile,profile,created_at,is_verified,show_personal_details,country_code',
                    'category:id,name,image,is_job_category,price_optional',
                    'item_custom_field_values.custom_field',
                    'gallery_images:id,image,item_id',
                    'area', 'featured_items', 'favourites',
                ])->withCount(['featured_items', 'job_applications'])->where('id', $request->id);

                if (Auth::check() && strpos($request->path(), 'my-items') !== false) {
                    $query->where('user_id', Auth::id())->withTrashed();
                } else {
                    $query->where('status', 'approved')->getNonExpiredItems();
                }

                $item = $query->first();
                // Ø§Ø³ØªØ®Ø¯Ù… ItemResource Ù‡Ù†Ø§ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Collection Ù„Ù†ØªÙŠØ¬Ø© Ù…ÙØ±Ø¯Ø©
                if (!$item) return ResponseService::errorResponse("No item Found");
                return ResponseService::successResponse("Advertisement Fetched Successfully", new \App\Http\Resources\ItemResource($item));
            }

            // === 2. Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ (Initial Query) ===
            $query = Item::with([
                'user:id,name,email,mobile,profile,created_at,is_verified,show_personal_details,country_code',
                'category:id,name,image,is_job_category,price_optional',
                'item_custom_field_values.custom_field',
                'gallery_images:id,image,item_id',
                'area', 'featured_items', 'favourites',
            ])->withCount(['featured_items', 'job_applications'])->select('items.*');

            // === 3. ØªØ­Ø³ÙŠÙ† Radius Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Bounding Box ===
            if ($request->latitude && $request->longitude && $request->radius) {
                $lat = (float) $request->latitude;
                $lon = (float) $request->longitude;
                $radius = (float) $request->radius; // Ø¨Ø§Ù„Ù€ KM

                // === ØªØ·Ø¨ÙŠÙ‚ Bounding Box (ØªØ³Ø±ÙŠØ¹ ÙƒØ¨ÙŠØ±) ===
                // 1 Ø¯Ø±Ø¬Ø© Ø¹Ø±Ø¶ = ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ 111 ÙƒÙ…. 
                $lat_degree = 111.045; 
                $lon_degree = $lat_degree * cos(deg2rad($lat)); 
                
                $min_lat = $lat - ($radius / $lat_degree);
                $max_lat = $lat + ($radius / $lat_degree);
                $min_lon = $lon - ($radius / $lon_degree);
                $max_lon = $lon + ($radius / $lon_degree);

                // ØªØ¶ÙŠÙŠÙ‚ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù‚Ø¨Ù„ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ø¹Ù‚Ø¯
                $query->whereBetween('latitude', [$min_lat, $max_lat])
                      ->whereBetween('longitude', [$min_lon, $max_lon]);

                // Ø«Ù… ØªØ·Ø¨ÙŠÙ‚ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ø¯Ù‚ÙŠÙ‚
                $query->selectRaw("items.*, (6371 * acos(cos(radians(?)) * cos(radians(latitude)) * cos(radians(longitude) - radians(?)) + sin(radians(?)) * sin(radians(latitude)))) AS distance", [$lat, $lon, $lat])
                      ->havingRaw("distance <= ?", [$radius])
                      ->orderBy('distance');
            }

            // === 4. Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¨Ø¯ÙŠÙ„ (Location fallback) ===
            if ($request->filled('area_id')) {
                $query->where('area_id', $request->area_id);
            } elseif ($request->filled('city')) {
                $query->where('city', $request->city);
            } elseif ($request->filled('state')) {
                $query->where('state', $request->state);
            } elseif ($request->filled('country')) {
                $query->where('country', $request->country);
            }

            // === 5. Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙÙ„Ø§ØªØ± ===
            // ØªØ­Ø³ÙŠÙ† (Ø§Ø³ØªØ®Ø¯Ø§Ù… Caching Ù„Ù€ Category IDs)
            if ($request->filled('category_id')) {
                $ids = Cache::remember("cat_{$request->category_id}", 3600, fn() =>
                    HelperService::findAllCategoryIds(collect([Category::find($request->category_id)]->filter()))
                );
                $query->whereIn('category_id', $ids);
            }

            if ($request->filled('category_slug')) {
                $ids = Cache::remember("slug_{$request->category_slug}", 3600, fn() =>
                    HelperService::findAllCategoryIds(Category::where('slug', $request->category_slug)->get())
                );
                $query->whereIn('category_id', $ids);
            }

            if ($request->min_price || $request->max_price) {
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ®Ø¯Ø§Ù… 0 ÙƒÙ‚ÙŠÙ…Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ø¯Ù†Ù‰ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡
                $min = $request->min_price ?? 0;
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù‚ÙŠÙ…Ø© ÙƒØ¨ÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹ ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰ Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯Ù‡
                $max = $request->max_price ?? 999999999; 
                $query->whereBetween('price', [$min, $max]);
            }

            if ($request->filled('user_id')) $query->where('user_id', $request->user_id);
            if ($request->filled('slug')) $query->where('slug', $request->slug);
            if ($request->filled('search') && strlen($request->search) >= 2) {
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø¯Ø§Ù„Ø© search ÙÙŠ Ø§Ù„Ù…ÙˆØ¯ÙŠÙ„ (Scope) ØªØ³ØªØ®Ø¯Ù… Full-Text Indexes Ù„ØªØ­Ù‚ÙŠÙ‚ Ø£ÙØ¶Ù„ Ø£Ø¯Ø§Ø¡
                $query->search($request->search);
            }

            if ($request->filled('posted_since')) {
                $date = now()->subYears(100);
                if ($request->posted_since == 'today') $date = now()->startOfDay();
                elseif ($request->posted_since == 'within-1-week') $date = now()->subDays(7);
                elseif ($request->posted_since == 'within-2-week') $date = now()->subDays(14);
                elseif ($request->posted_since == 'within-1-month') $date = now()->subMonthNoOverflow();
                elseif ($request->posted_since == 'within-3-month') $date = now()->subMonthsNoOverflow(3);
                $query->where('created_at', '>=', $date);
            }

            // === 6. Custom Fields ===
            if ($request->has('custom_fields') && is_array($request->custom_fields)) {
                foreach ($request->custom_fields as $fieldId => $value) {
                    if (!empty($value)) {
                        $values = is_array($value) ? $value : [$value];
                        $query->whereHas('item_custom_field_values', function($q) use ($fieldId, $values) {
                            $q->where('custom_field_id', $fieldId)->whereIn('value', $values);
                        });
                    }
                }
            }

            // === 7. Sorting ===
            if ($request->sort_by == "new-to-old") {
                $query->orderBy('id', 'DESC');
            } elseif ($request->sort_by == "old-to-new") {
                $query->orderBy('id', 'ASC');
            } elseif ($request->sort_by == "price-high-to-low") {
                $query->orderBy('price', 'DESC');
            } elseif ($request->sort_by == "price-low-to-high") {
                $query->orderBy('price', 'ASC');
            } elseif ($request->sort_by == "popular_items") {
                $query->orderBy('clicks', 'DESC');
            } else {
                $query->orderBy('id', 'DESC');
            }

            // === 8. Auth & Status ===
            if (Auth::check()) {
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ø´Ø±Ø·ÙŠØ© Ù„Ù„Ù€ Auth
                $query->with(['item_offers' => fn($q) => $q->where('buyer_id', Auth::id())]);
                $query->with(['user_reports' => fn($q) => $q->where('user_id', Auth::id())]);

                if (strpos($request->path(), 'my-items') !== false) {
                    // Ø±Ø¤ÙŠØ© ÙƒÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª (Ø§Ù„Ù…Ø­Ø°ÙˆÙØ©) Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                    $query->where('user_id', Auth::id())->withTrashed();
                } else {
                    // Ø±Ø¤ÙŠØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© ÙˆØºÙŠØ± Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©
                    $query->where('status', 'approved')->getNonExpiredItems();
                }
            } else {
                // Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ØºÙŠØ± Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ†: Ø±Ø¤ÙŠØ© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø© ÙˆØºÙŠØ± Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ© ÙÙ‚Ø·
                $query->where('status', 'approved')->getNonExpiredItems();
            }

            // === 9. Ø¬Ù„Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© ÙˆØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±Ù‚ÙŠÙ… (Pagination) ===
            $items = $query->paginate($request->limit ?? 15);

            return ResponseService::successResponse("Advertisement Fetched Successfully", new ItemCollection($items));

        } catch (\Throwable $e) {
            \Log::error("getItem Fatal Error: " . $e->getMessage() . " in " . $e->getFile() . ":" . $e->getLine());
            return ResponseService::errorResponse("Something went wrong");
        }
    }

public function getItem(Request $request)
{
    // === 0. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Validation) ===
    $validator = Validator::make($request->all(), [
        'limit'               => 'nullable|integer',
        'id'                  => 'nullable|integer',
        'custom_fields'       => 'nullable',
        'category_id'         => 'nullable',
        'category_slug'       => 'nullable|string',
        'user_id'             => 'nullable',
        'min_price'           => 'nullable|numeric',
        'max_price'           => 'nullable|numeric',
        'sort_by'             => 'nullable|in:new-to-old,old-to-new,price-high-to-low,price-low-to-high,popular_items',
        'posted_since'        => 'nullable|in:all-time,today,within-1-week,within-2-week,within-1-month,within-3-month',
        'area_id'             => 'nullable',
        'city'                => 'nullable|string',
        'state'               => 'nullable|string',
        'country'             => 'nullable|string',
        'latitude'            => 'nullable|numeric',
        'longitude'           => 'nullable|numeric',
        'radius'              => 'nullable|numeric',
        'search'              => 'nullable|string',
        'featured_section_id' => 'nullable',
        'featured_section_slug' => 'nullable|string',
        'status'              => 'nullable|string',
        'slug'                => 'nullable|string',
    ]);

    if ($validator->fails()) {
        return ResponseService::validationError($validator->errors()->first());
    }

    try {
        // -----------------------------------------------------------------
        // 1. Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ù€ ID (Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø°Ø§Øª Ø§Ù„ØµÙ„Ø©)
        // -----------------------------------------------------------------
        if ($request->filled('id')) {
            $item = Item::with([
                'user:id,name,email,mobile,profile,created_at,is_verified,show_personal_details,country_code',
                'category:id,name,image,is_job_category,price_optional',
                'item_custom_field_values.custom_field',
                'gallery_images:id,image,item_id',
                'area', 'featured_items', 'favourites',
            ])->withCount(['featured_items', 'job_applications'])
              ->where('id', $request->id);

            // ØªØ·Ø¨ÙŠÙ‚ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…/Ø§Ù„Ù…Ø³Ø§Ø±
            if (Auth::check() && strpos($request->path(), 'my-items') !== false) {
                $item->where('user_id', Auth::id())->withTrashed();
            } else {
                $item->where('status', 'approved')->getNonExpiredItems();
            }

            $item = $item->first();

            if (!$item) return ResponseService::errorResponse("No item Found");
            
            // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø°Ø§Øª Ø§Ù„ØµÙ„Ø© (Ù„Ø¥Ø¸Ù‡Ø§Ø±Ù‡Ø§ ÙÙŠ ØµÙØ­Ø© Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†) ---
            $relatedQuery = Item::query()
                ->where('id', '!=', $item->id) 
                ->where('status', 'approved')
                ->getNonExpiredItems() 
                ->where(function ($q) use ($item) {
                    $q->where('category_id', $item->category_id);
                    if ($item->city) $q->orWhere('city', $item->city);
                    if ($item->state) $q->orWhere('state', $item->state);
                })
                ->orderBy('created_at', 'DESC')
                ->orderBy('clicks', 'DESC')
                ->limit(10)
                ->get();
            
            $item->related_items = $relatedQuery; 
            // ----------------------------------------------------------
            
            // Ù†Ø³ØªØ®Ø¯Ù… ItemResource Ø¹Ù†Ø¯ Ø¬Ù„Ø¨ Ø¹Ù†ØµØ± ÙˆØ§Ø­Ø¯
            return ResponseService::successResponse("Advertisement Fetched Successfully", new ItemResource($item));
        }

        // -----------------------------------------------------------------
        // 2. Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ÙˆØ§Ù„Ù€ Eager Loading
        // -----------------------------------------------------------------
        $query = Item::with([
            'user:id,name,email,mobile,profile,created_at,is_verified,show_personal_details,country_code',
            'category:id,name,image,is_job_category,price_optional',
            'item_custom_field_values.custom_field',
            'gallery_images:id,image,item_id',
            'area', 'featured_items', 'favourites',
        ])->withCount(['featured_items', 'job_applications'])->select('items.*');

        // -----------------------------------------------------------------
        // 3. ØªØ­Ø³ÙŠÙ† Radius (Bounding Box + Haversine)
        // -----------------------------------------------------------------
        if ($request->latitude && $request->longitude && $request->radius) {
            $lat = (float) $request->latitude;
            $lon = (float) $request->longitude;
            $radius = (float) $request->radius;
            
            // Bounding Box Calculation (Ù„ØªØ¶ÙŠÙŠÙ‚ Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¨Ø­Ø« Ù‚Ø¨Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¹Ù‚Ø¯)
            $lat_degree = 111.045; 
            $lon_degree = $lat_degree * cos(deg2rad($lat)); 
            
            $min_lat = $lat - ($radius / $lat_degree);
            $max_lat = $lat + ($radius / $lat_degree);
            $min_lon = $lon - ($radius / $lon_degree);
            $max_lon = $lon + ($radius / $lon_degree);

            $query->whereBetween('latitude', [$min_lat, $max_lat])
                  ->whereBetween('longitude', [$min_lon, $max_lon]);

            // Haversine Formula (ÙŠØªÙ… ØªØ·Ø¨ÙŠÙ‚Ù‡Ø§ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø£Ù‚Ù„ Ù…Ù† Ø§Ù„Ù†ØªØ§Ø¦Ø¬)
            $haversine = "(6371 * acos(cos(radians(?)) * cos(radians(latitude)) * cos(radians(longitude) - radians(?)) + sin(radians(?)) * sin(radians(latitude))))";

            $query->selectRaw("items.*, {$haversine} AS distance", [$lat, $lon, $lat])
                  ->having('distance', '<=', $radius)
                  ->orderBy('distance');
        }

        // -----------------------------------------------------------------
        // 4. Location fallback (Ù…Ø¯Ù…Ø¬)
        // -----------------------------------------------------------------
        if ($request->filled('area_id')) {
            $query->where('area_id', $request->area_id);
        } elseif ($request->filled('city')) {
            $query->where('city', $request->city);
        } elseif ($request->filled('state')) {
            $query->where('state', $request->state);
        } elseif ($request->filled('country')) {
            $query->where('country', $request->country);
        }

        // -----------------------------------------------------------------
        // 5. Ø§Ù„ÙÙ„Ø§ØªØ± (Ù…Ø¹ ØªØ­Ø³ÙŠÙ† Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„ÙØ¦Ø§Øª)
        // -----------------------------------------------------------------
        if ($request->filled('category_id')) {
            // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ø´ Ù„ØªØ­Ø³ÙŠÙ† Ø£Ø¯Ø§Ø¡ Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©
            $ids = Cache::remember("cat_{$request->category_id}", 3600, fn() =>
                HelperService::findAllCategoryIds(Category::where('id', $request->category_id)->with('children')->get())
            );
            $query->whereIn('category_id', $ids);
        }

        if ($request->filled('category_slug')) {
            $ids = Cache::remember("slug_{$request->category_slug}", 3600, fn() =>
                HelperService::findAllCategoryIds(Category::where('slug', $request->category_slug)->with('children')->get())
            );
            $query->whereIn('category_id', $ids);
        }

        if ($request->min_price || $request->max_price) {
            $query->whereBetween('price', [$request->min_price ?? 0, $request->max_price ?? 999999999]);
        }

        if ($request->filled('user_id')) $query->where('user_id', $request->user_id);
        if ($request->filled('slug')) $query->where('slug', $request->slug);
        if ($request->filled('search') && strlen($request->search) >= 2) $query->search($request->search);

        if ($request->filled('posted_since')) {
            $date = match($request->posted_since) {
                'today' => now()->startOfDay(),
                'within-1-week' => now()->subDays(7),
                'within-2-week' => now()->subDays(14),
                'within-1-month' => now()->subMonthNoOverflow(),
                'within-3-month' => now()->subMonthsNoOverflow(3),
                default => now()->subYears(100),
            };
            $query->where('created_at', '>=', $date);
        }

        // -----------------------------------------------------------------
        // 6. Custom Fields (ØªØ­Ø³ÙŠÙ† whereIn Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† LIKE Ø¥Ø°Ø§ Ø£Ù…ÙƒÙ†)
        // -----------------------------------------------------------------
        if ($request->has('custom_fields') && is_array($request->custom_fields)) {
            foreach ($request->custom_fields as $fieldId => $value) {
                $values = is_array($value) ? $value : [$value];
                $query->whereHas('item_custom_field_values', function($q) use ($fieldId, $values) {
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… whereIn Ø£ÙƒØ«Ø± ÙƒÙØ§Ø¡Ø© Ù…Ù† LIKE ÙÙŠ Ù…Ø¹Ø¸Ù… Ø§Ù„Ø­Ø§Ù„Ø§Øª
                    $q->where('custom_field_id', $fieldId)->whereIn('value', $values); 
                });
            }
        }

        // -----------------------------------------------------------------
        // 7. Sorting (ØªÙ… Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„ÙŠÙ‡ ÙƒÙ…Ø§ Ù‡Ùˆ)
        // -----------------------------------------------------------------
        if ($request->sort_by == "new-to-old") {
            $query->orderBy('id', 'DESC');
        } elseif ($request->sort_by == "old-to-new") {
            $query->orderBy('id', 'ASC');
        } elseif ($request->sort_by == "price-high-to-low") {
            $query->orderBy('price', 'DESC');
        } elseif ($request->sort_by == "price-low-to-high") {
            $query->orderBy('price', 'ASC');
        } elseif ($request->sort_by == "popular_items") {
            $query->orderBy('clicks', 'DESC');
        } else {
            $query->orderBy('id', 'DESC');
        }

        // -----------------------------------------------------------------
        // 8. Auth & Status (ØªÙ… Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„ÙŠÙ‡ ÙƒÙ…Ø§ Ù‡Ùˆ)
        // -----------------------------------------------------------------
        if (Auth::check()) {
            $query->with(['item_offers' => fn($q) => $q->where('buyer_id', Auth::id())]);
            $query->with(['user_reports' => fn($q) => $q->where('user_id', Auth::id())]);

            if (strpos($request->path(), 'my-items') !== false) {
                $query->where('user_id', Auth::id())->withTrashed();
            } else {
                $query->where('status', 'approved')->getNonExpiredItems();
            }
        } else {
            $query->where('status', 'approved')->getNonExpiredItems();
        }

        // -----------------------------------------------------------------
        // 9. Ø¬Ù„Ø¨ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© (Ø§Ù„ØªØµÙØ­)
        // -----------------------------------------------------------------
        $items = $query->paginate($request->limit ?? 15);

        // Ù†Ø³ØªØ®Ø¯Ù… ItemCollection Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø´ÙƒÙ„ Ø§Ù„Ø¯Ø§ØªØ§ ÙƒÙ…Ø§ Ø·Ù„Ø¨Øª
        return ResponseService::successResponse("Advertisement Fetched Successfully", new ItemCollection($items));


    } catch (\Throwable $e) {
        \Log::error("getItem Fatal Error: " . $e->getMessage() . " in " . $e->getFile() . ":" . $e->getLine());
        return ResponseService::errorResponse("Something went wrong");
    }
}

  public function getItemoldold(Request $request) {
    $validator = Validator::make($request->all(), [
        'limit'         => 'nullable|integer',
        'offset'        => 'nullable|integer',
        'id'            => 'nullable',
        'custom_fields' => 'nullable',
        'category_id'   => 'nullable',
        'user_id'       => 'nullable',
        'min_price'     => 'nullable',
        'max_price'     => 'nullable',
        'sort_by'       => 'nullable|in:new-to-old,old-to-new,price-high-to-low,price-low-to-high,popular_items',
        'posted_since'  => 'nullable|in:all-time,today,within-1-week,within-2-week,within-1-month,within-3-month'
    ]);

    if ($validator->fails()) {
        ResponseService::validationError($validator->errors()->first());
    }

    try {
        // -------------------------
        // Closure: ÙŠØ¨Ù†ÙŠ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ Ù…Ø¹ ØªØ­ÙƒÙ‘Ù… Ø¨Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ÙŠØ©
        // $locationLevel: 'area' | 'city' | 'state' | 'country' | null
        // -------------------------
          $start = microtime(true); // â¬…ï¸ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ù‚ÙŠØ§Ø³
    \DB::connection()->enableQueryLog(); // â¬…ï¸ ØªÙØ¹ÙŠÙ„ Ù„ÙˆØ¬ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù…Ø§Øª (Ù…Ø¤Ù‚ØªÙ‹Ø§ ÙÙ‚Ø·)

           $buildQuery = function ($locationLevel = null) use ($request) {
            $q = Item::with([
                   'user:id,name,email,mobile,profile,created_at,is_verified,show_personal_details,country_code',
                   'category:id,name,image,is_job_category,price_optional',

                     // âœ… Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„ØªÙŠ ÙƒØ§Ù†Øª Ø¨Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                   'item_custom_field_values.custom_field',
                   'gallery_images:id,image,item_id',
                   'area',
                   'featured_items',
                   'favourites',
                ])
                ->withCount('featured_items')
                ->withCount('job_applications')
                ->select('items.*');

            // ID
            $q->when($request->id, function ($sql) use ($request) {
                $sql->where('id', $request->id);
            });

            // category filters
            $q->when($request->category_id, function ($sql) use ($request) {
                $category = Category::where('id', $request->category_id)->with('children')->get();
                $categoryIDS = HelperService::findAllCategoryIds($category);
                return $sql->whereIn('category_id', $categoryIDS);
            });

            $q->when($request->category_slug, function ($sql) use ($request) {
                $category = Category::where('slug', $request->category_slug)->with('children')->get();
                $categoryIDS = HelperService::findAllCategoryIds($category);
                return $sql->whereIn('category_id', $categoryIDS);
            });

            // price range
            $q->when((isset($request->min_price) || isset($request->max_price)), function ($sql) use ($request) {
                $min_price = $request->min_price ?? 0;
                $max_price = $request->max_price ?? Item::max('price');
                return $sql->whereBetween('price', [$min_price, $max_price]);
            });

            // posted_since
            $q->when($request->posted_since, function ($sql) use ($request) {
                return match ($request->posted_since) {
                    "today" => $sql->whereDate('created_at', '>=', now()),
                    "within-1-week" => $sql->whereDate('created_at', '>=', now()->subDays(7)),
                    "within-2-week" => $sql->whereDate('created_at', '>=', now()->subDays(14)),
                    "within-1-month" => $sql->whereDate('created_at', '>=', now()->subMonths()),
                    "within-3-month" => $sql->whereDate('created_at', '>=', now()->subMonths(3)),
                    default => $sql
                };
            });

            // -------------------------
            // Location filter: Ù†Ø·Ø¨Ù‚ ÙÙ‚Ø· Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø­Ø¯Ø¯ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ù†Ø§Ø¡
            // -------------------------
            if ($locationLevel === 'area' && $request->filled('area_id')) {
                $q->where('area_id', $request->area_id);
            } elseif ($locationLevel === 'city' && $request->filled('city')) {
                $q->where('city', $request->city);
            } elseif ($locationLevel === 'state' && $request->filled('state')) {
                $q->where('state', $request->state);
            } elseif ($locationLevel === 'country' && $request->filled('country')) {
               //    'item_custom_field_values.custom_field',
                //   'gallery_images:id,image,item_id',
                //   'area',
                //   'featured_items',
                //   'favourites',
              //  ])
              //  ->withCount('featured_items')
              //  ->withCount('job_applications')
              //  ->select('items.*');
                 $q->where('country', $request->country);
}
            // ID
            $q->when($request->id, function ($sql) use ($request) {
                $sql->where('id', $request->id);
            });

            // category filters
            $q->when($request->category_id, function ($sql) use ($request) {
                $category = Category::where('id', $request->category_id)->with('children')->get();
                $categoryIDS = HelperService::findAllCategoryIds($category);
                return $sql->whereIn('category_id', $categoryIDS);
            });

            $q->when($request->category_slug, function ($sql) use ($request) {
                $category = Category::where('slug', $request->category_slug)->with('children')->get();
                $categoryIDS = HelperService::findAllCategoryIds($category);
                return $sql->whereIn('category_id', $categoryIDS);
           // });$q->where('country', $request->country);
            });
            // Note: if $locationLevel is null, no location condition is applied.

            // other possible filters
            if ($request->filled('user_id')) {
                $q->where('user_id', $request->user_id);
            }

            if ($request->filled('slug')) {
                $q->where('slug', $request->slug);
            }

            // radius/haversine
            $q->when($request->latitude && $request->longitude && $request->radius, function ($sql) use ($request) {
                $latitude = $request->latitude;
                $longitude = $request->longitude;
                $radius = $request->radius;

                $haversine = "(6371 * acos(cos(radians($latitude))
                                * cos(radians(latitude))
                                * cos(radians(longitude) - radians($longitude))
                                + sin(radians($latitude))
                                * sin(radians(latitude))))";

                $sql->select('items.*')
                    ->selectRaw("{$haversine} AS distance")
                    ->where('latitude', '!=', 0)
                    ->where('longitude', '!=', 0)
                    ->having('distance', '<', $radius)
                    ->orderBy('distance', 'asc');
            });

            return $q;
        };

        // -------------------------
        // Helper: function to apply sorting & status & featured-section & custom_fields & auth scoping
        // (Ù†Ø·Ø¨Ù‚ Ù‡Ø°Ù‡ Ø§Ù„Ø¨Ù„ÙˆÙƒ Ø¹Ù„Ù‰ Ø£ÙŠ Query ÙŠÙØ¨Ù†Ù‰ Ø¨ÙˆØ§Ø³Ø·Ø© $buildQuery)
        // -------------------------
        $applyCommonModifiers = function ($sql) use ($request) {
            // sort_by
            if ($request->sort_by == "new-to-old") {
                $sql->orderBy('id', 'DESC');
            } elseif ($request->sort_by == "old-to-new") {
                $sql->orderBy('id', 'ASC');
            } elseif ($request->sort_by == "price-high-to-low") {
                $sql->orderBy('price', 'DESC');
            } elseif ($request->sort_by == "price-low-to-high") {
                $sql->orderBy('price', 'ASC');
            } elseif ($request->sort_by == "popular_items") {
                $sql->orderBy('clicks', 'DESC');
            } else {
                $sql->orderBy('id', 'DESC');
            }

            // Status handling (same logic as original)
            if (!empty($request->status)) {
                if (in_array($request->status, array('review', 'approved', 'rejected', 'sold out', 'soft rejected', 'permanent rejected'))) {
                    $sql->where('status', $request->status)->getNonExpiredItems()->whereNull('deleted_at');
                } elseif ($request->status == 'inactive') {
                    $sql->onlyTrashed()->getNonExpiredItems();
                } elseif ($request->status == 'featured') {
                    $sql->where('status', 'approved')->has('featured_items')->getNonExpiredItems();
                } elseif ($request->status == 'expired') {
                    $sql->whereNotNull('expiry_date')
                          ->where('expiry_date', '<', Carbon::now())->whereNull('deleted_at');
                }
            }

            // featured section handling (copied from original)
            if (!empty($request->featured_section_id) || !empty($request->featured_section_slug)) {
                if (!empty($request->featured_section_id)) {
                    $featuredSection = FeatureSection::findOrFail($request->featured_section_id);
                } else {
                    $featuredSection = FeatureSection::where('slug', $request->featured_section_slug)->firstOrFail();
                }
                $sql = match ($featuredSection->filter) {
                    "price_criteria" => $sql->whereBetween('price', [$featuredSection->min_price, $featuredSection->max_price]),
                    "most_viewed" => $sql->reorder()->orderBy('clicks', 'DESC'),
                    "category_criteria" => (static function () use ($featuredSection, $sql) {
                        $category = Category::whereIn('id', explode(',', $featuredSection->value))->with('children')->get();
                        $categoryIDS = HelperService::findAllCategoryIds($category);
                        return $sql->whereIn('category_id', $categoryIDS);
                    })(),
                    "most_liked" => $sql->reorder()->withCount('favourites')->orderBy('favourites_count', 'DESC'),
                };
            }

            return $sql;
        };

        // -------------------------
        // Build search and custom_fields parts (these need to be applied to each built query)
        // -------------------------
        $searchTerm = $request->search ?? null;
        $customFieldsInput = $request->all()['custom_fields'] ?? null;

        // Note: We'll apply search and custom_fields inside the loop on each built query
        // because they require joins/whereHas on the specific instance.

        // -------------------------
        // Decide initial location level for fallback order
        // -------------------------
        $initialLevel = null;
        if ($request->filled('area_id')) {
            $initialLevel = 'area';
        } elseif ($request->filled('city')) {
            $initialLevel = 'city';
        } elseif ($request->filled('state')) {
            $initialLevel = 'state';
        } elseif ($request->filled('country')) {
            $initialLevel = 'country';
        } else {
            $initialLevel = null;
        }

        // If request includes specific 'id', keep original behavior (no fallback)
        if (!empty($request->id)) {
            // Build base query with no special location level (original behavior)
            $sql = $buildQuery(null);

            // apply search
            if (!empty($searchTerm)) {
                $sql->search($searchTerm);
            }

            // apply custom_fields joins if present (exact same logic as original)
            if (!empty($customFieldsInput)) {
                $customFields = $customFieldsInput;
                foreach ($customFields as $customFieldId => $value) {
                    if (is_array($value)) {
                        foreach ($value as $arrayValue) {
                            $sql->join('item_custom_field_values as cf' . $customFieldId, function ($join) use ($customFieldId) {
                                    $join->on('items.id', '=', 'cf' . $customFieldId . '.item_id');
                                })
                                ->where('cf' . $customFieldId . '.custom_field_id', $customFieldId)
                                ->where('cf' . $customFieldId . '.value', 'LIKE', '%' . trim($arrayValue) . '%');
                        }
                    } else {
                        $sql->join('item_custom_field_values as cf' . $customFieldId, function ($join) use ($customFieldId) {
                                $join->on('items.id', '=', 'cf' . $customFieldId . '.item_id');
                            })
                            ->where('cf' . $customFieldId . '.custom_field_id', $customFieldId)
                            ->where('cf' . $customFieldId . '.value', 'LIKE', '%' . trim($value) . '%');
                    }
                }
                $sql->whereHas('item_custom_field_values', function ($query) use ($customFields) {
                    $query->whereIn('custom_field_id', array_keys($customFields));
                }, '=', count($customFields));
            }

            // apply common modifiers
            $sql = $applyCommonModifiers($sql);

            // auth / status scoping (copied original logic)
            if (Auth::check()) {
                $sql->with(['item_offers' => function ($q) {
                    $q->where('buyer_id', Auth::user()->id);
                }, 'user_reports' => function ($q) {
                    $q->where('user_id', Auth::user()->id);
                }]);

                $currentURI = explode('?', $request->getRequestUri(), 2);
                if ($currentURI[0] == "/api/my-items") {
                    $sql->where(['user_id' => Auth::user()->id])->withTrashed();
                } else {
                    $sql->where('status', 'approved')->has('user')->onlyNonBlockedUsers()->getNonExpiredItems();
                }
            } else {
                $sql->where('status', 'approved')->getNonExpiredItems();
            }

            // Execute for id case
            $result = $sql->get();
            if (count($result) == 0) {
                ResponseService::errorResponse("No item Found");
            }

            // return as original
           $executionTime = microtime(true) - $start;
Log::info('getItem total time (SINGLE ID)', [
    'seconds' => $executionTime,
    'url' => request()->fullUrl(),
]);
Log::info('getItem queries (SINGLE ID)', DB::getQueryLog());
            return ResponseService::successResponse("Advertisement Fetched Successfully", new ItemCollection($result));
        }

        // -------------------------
        // Fallback loop: try levels in order: initialLevel -> escalate -> ... -> null (no location)
        // order example: ['area','city','state','country',null]
        // -------------------------
        $levelsOrder = [];
        if ($initialLevel === 'area') {
            $levelsOrder = ['area', 'city', 'state', 'country', null];
        } elseif ($initialLevel === 'city') {
            $levelsOrder = ['city', 'state', 'country', null];
        } elseif ($initialLevel === 'state') {
            $levelsOrder = ['state', 'country', null];
        } elseif ($initialLevel === 'country') {
            $levelsOrder = ['country', null];
        } else {
            $levelsOrder = [null];
        }

        $result = null;
        $attemptDetails = [];

        foreach ($levelsOrder as $level) {
            // build
            $sqlAttempt = $buildQuery($level);

            // apply search if present
            if (!empty($searchTerm)) {
                $sqlAttempt->search($searchTerm);
            }

            // apply custom_fields joins if present (same as original)
            if (!empty($customFieldsInput)) {
                $customFields = $customFieldsInput;
                foreach ($customFields as $customFieldId => $value) {
                    if (is_array($value)) {
                        foreach ($value as $arrayValue) {
                            $sqlAttempt->join('item_custom_field_values as cf' . $customFieldId, function ($join) use ($customFieldId) {
                                    $join->on('items.id', '=', 'cf' . $customFieldId . '.item_id');
                                })
                                ->where('cf' . $customFieldId . '.custom_field_id', $customFieldId)
                                ->where('cf' . $customFieldId . '.value', 'LIKE', '%' . trim($arrayValue) . '%');
                        }
                    } else {
                        $sqlAttempt->join('item_custom_field_values as cf' . $customFieldId, function ($join) use ($customFieldId) {
                                $join->on('items.id', '=', 'cf' . $customFieldId . '.item_id');
                            })
                            ->where('cf' . $customFieldId . '.custom_field_id', $customFieldId)
                            ->where('cf' . $customFieldId . '.value', 'LIKE', '%' . trim($value) . '%');
                    }
                }
                $sqlAttempt->whereHas('item_custom_field_values', function ($query) use ($customFields) {
                    $query->whereIn('custom_field_id', array_keys($customFields));
                }, '=', count($customFields));
            }

            // apply common modifiers (sorting, featured-section etc.)
            $sqlAttempt = $applyCommonModifiers($sqlAttempt);

            // auth / status scoping (same as original)
            if (Auth::check()) {
                $sqlAttempt->with(['item_offers' => function ($q) {
                    $q->where('buyer_id', Auth::user()->id);
                }, 'user_reports' => function ($q) {
                    $q->where('user_id', Auth::user()->id);
                }]);

                $currentURI = explode('?', $request->getRequestUri(), 2);
                if ($currentURI[0] == "/api/my-items") {
                    $sqlAttempt->where(['user_id' => Auth::user()->id])->withTrashed();
                } else {
                    $sqlAttempt->where('status', 'approved')->has('user')->onlyNonBlockedUsers()->getNonExpiredItems();
                }
            } else {
                $sqlAttempt->where('status', 'approved')->getNonExpiredItems();
            }

            // execute: paginate or limit
            if (!empty($request->limit)) {
                $pageResult = $sqlAttempt->paginate($request->limit);
            } else {
                $pageResult = $sqlAttempt->paginate();
            }

            // log attempt
            $attemptDetails[] = [
                'level' => $level,
                'total' => $pageResult instanceof \Illuminate\Pagination\LengthAwarePaginator ? $pageResult->total() : (is_countable($pageResult) ? count($pageResult) : 0)
            ];
            \Log::info('getItem: location fallback attempt', end($attemptDetails));

            // if results found, keep and break
            if ($pageResult instanceof \Illuminate\Pagination\LengthAwarePaginator ? $pageResult->total() > 0 : (is_countable($pageResult) ? count($pageResult) > 0 : false)) {
                $result = $pageResult;
                break;
            }

            // otherwise continue to next level
        }

        // if still null or empty, ensure we return empty paginator from last attempt or original behavior
        if (is_null($result)) {
            // final attempt with no location filter (in case levelsOrder didn't include null)
            $sqlFinal = $buildQuery(null);

            if (!empty($searchTerm)) {
                $sqlFinal->search($searchTerm);
            }
            if (!empty($customFieldsInput)) {
                $customFields = $customFieldsInput;
                foreach ($customFields as $customFieldId => $value) {
                    if (is_array($value)) {
                        foreach ($value as $arrayValue) {
                            $sqlFinal->join('item_custom_field_values as cf' . $customFieldId, function ($join) use ($customFieldId) {
                                    $join->on('items.id', '=', 'cf' . $customFieldId . '.item_id');
                                })
                                ->where('cf' . $customFieldId . '.custom_field_id', $customFieldId)
                                ->where('cf' . $customFieldId . '.value', 'LIKE', '%' . trim($arrayValue) . '%');
                        }
                    } else {
                        $sqlFinal->join('item_custom_field_values as cf' . $customFieldId, function ($join) use ($customFieldId) {
                                $join->on('items.id', '=', 'cf' . $customFieldId . '.item_id');
                            })
                            ->where('cf' . $customFieldId . '.custom_field_id', $customFieldId)
                            ->where('cf' . $customFieldId . '.value', 'LIKE', '%' . trim($value) . '%');
                    }
                }
                $sqlFinal->whereHas('item_custom_field_values', function ($query) use ($customFields) {
                    $query->whereIn('custom_field_id', array_keys($customFields));
                }, '=', count($customFields));
            }

            $sqlFinal = $applyCommonModifiers($sqlFinal);

            if (Auth::check()) {
                $sqlFinal->with(['item_offers' => function ($q) {
                    $q->where('buyer_id', Auth::user()->id);
                }, 'user_reports' => function ($q) {
                    $q->where('user_id', Auth::user()->id);
                }]);

                $currentURI = explode('?', $request->getRequestUri(), 2);
                if ($currentURI[0] == "/api/my-items") {
                    $sqlFinal->where(['user_id' => Auth::user()->id])->withTrashed();
                } else {
                    $sqlFinal->where('status', 'approved')->has('user')->onlyNonBlockedUsers()->getNonExpiredItems();
                }
            } else {
                $sqlFinal->where('status', 'approved')->getNonExpiredItems();
            }

            if (!empty($request->limit)) {
                $result = $sqlFinal->paginate($request->limit);
            } else {
                $result = $sqlFinal->paginate();
            }
        }

        // log summary of attempts
        \Log::info('getItem: fallback summary', [
            'attempts' => $attemptDetails,
            'final_total' => $result instanceof \Illuminate\Pagination\LengthAwarePaginator ? $result->total() : (is_countable($result) ? count($result) : 0)
        ]);

           // Ù‚ÙŠØ§Ø³ Ù‚Ø¨Ù„ Response
$beforeResponse = microtime(true) - $start;
Log::info('getItem BEFORE ResponseService', [
    'seconds' => $beforeResponse,
    'queries_count' => count(DB::getQueryLog()),
]);
        // final response (same as original)
             // â¬‡ï¸â¬‡ï¸â¬‡ï¸ Ø£Ø¶Ù Ù‡Ù†Ø§ â¬‡ï¸â¬‡ï¸â¬‡ï¸
// Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©
Log::info('Step 1: Creating ItemCollection');
$collection = new ItemCollection($result);
Log::info('Step 2: ItemCollection created successfully');

Log::info('Step 3: Calling ResponseService');
$response = ResponseService::successResponse("Advertisement Fetched Successfully", $collection);
Log::info('Step 4: ResponseService returned successfully');        
//$response = ResponseService::successResponse("Advertisement Fetched Successfully", new ItemCollection($result));
        // Ù‚ÙŠØ§Ø³ Ø¨Ø¹Ø¯ Response
$afterResponse = microtime(true) - $start;
Log::info('getItem AFTER ResponseService', [
    'seconds' => $afterResponse,
    'difference' => $afterResponse - $beforeResponse,
]);

return $response;


    } catch (Throwable $th) {
   $executionTime = microtime(true) - $start;
    Log::error('getItem total time (ERROR)', [
        'seconds' => $executionTime,
        'url' => request()->fullUrl(),
        'error' => $th->getMessage()
    ]);
    Log::error('getItem queries (ERROR)', DB::getQueryLog());    

    ResponseService::logErrorResponse($th, "API Controller -> getItem");
        ResponseService::errorResponse();
    }
}

public function getItemoo(Request $request) 
{
    // === 0. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØµØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Validation) ===
    $validator = Validator::make($request->all(), [
        'limit' => 'nullable|integer',
        'offset' => 'nullable|integer',
        'id' => 'nullable|integer',
        'custom_fields' => 'nullable|array',
        'category_id' => 'nullable|integer',
        'category_slug' => 'nullable|string',
        'user_id' => 'nullable|integer',
        'min_price' => 'nullable|numeric',
        'max_price' => 'nullable|numeric',
        'sort_by' => 'nullable|in:new-to-old,old-to-new,price-high-to-low,price-low-to-high,popular_items',
        'posted_since' => 'nullable|in:all-time,today,within-1-week,within-2-week,within-1-month,within-3-month',
        'area_id' => 'nullable|integer',
        'city' => 'nullable|string',
        'state' => 'nullable|string',
        'country' => 'nullable|string',
        'latitude' => 'nullable|numeric',
        'longitude' => 'nullable|numeric',
        'radius' => 'nullable|numeric',
        'search' => 'nullable|string',
        'featured_section_id' => 'nullable|integer',
        'featured_section_slug' => 'nullable|string',
        'status' => 'nullable|string',
        'slug' => 'nullable|string',
    ]);
    
    if ($validator->fails()) {
        return ResponseService::validationError($validator->errors()->first());
    }

    $start = microtime(true);
    // Ù†ÙØ¹Ù„ Log Ù…Ø¤Ù‚ØªØ§Ù‹ Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù€ TTFB
    DB::connection()->enableQueryLog();

    try {
        // -----------------------------------------------------
        // 1. Closure: Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø§Ø³ØªØ¹Ù„Ø§Ù… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ ÙˆØ§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ÙŠØ©
        // -----------------------------------------------------
        $buildQuery = function ($locationLevel = null) use ($request) {
            $q = Item::with([
                'user:id,name,email,mobile,profile,created_at,is_verified,show_personal_details,country_code',
                'category:id,name,image,is_job_category,price_optional',
                'item_custom_field_values.custom_field',
                'gallery_images:id,image,item_id',
                'area',
                'featured_items',
                'favourites',
            ])
            ->withCount('featured_items')
            ->withCount('job_applications')
            ->select('items.*');

            // ID
            $q->when($request->id, fn($sql) => $sql->where('id', $request->id));

            // Category Filters (Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ø´)
            if ($request->filled('category_id')) {
                $ids = Cache::remember("cat_{$request->category_id}", 3600, fn() =>
                    HelperService::findAllCategoryIds(Category::where('id', $request->category_id)->with('children')->get())
                );
                $q->whereIn('category_id', $ids);
            }
            if ($request->filled('category_slug')) {
                $ids = Cache::remember("slug_{$request->category_slug}", 3600, fn() =>
                    HelperService::findAllCategoryIds(Category::where('slug', $request->category_slug)->with('children')->get())
                );
                $q->whereIn('category_id', $ids);
            }

            // Price Range (Ù…Ù†Ø¹ Ø§Ø³ØªØ¹Ù„Ø§Ù… MAX)
            $q->when((isset($request->min_price) || isset($request->max_price)), function ($sql) use ($request) {
                $min_price = $request->min_price ?? 0;
                $max_price = $request->max_price ?? 999999999; 
                return $sql->whereBetween('price', [$min_price, $max_price]);
            });

            // Posted Since
            $q->when($request->posted_since, function ($sql) use ($request) {
                return match ($request->posted_since) {
                    "today" => $sql->whereDate('created_at', '>=', now()->startOfDay()),
                    "within-1-week" => $sql->whereDate('created_at', '>=', now()->subDays(7)),
                    "within-2-week" => $sql->whereDate('created_at', '>=', now()->subDays(14)),
                    "within-1-month" => $sql->whereDate('created_at', '>=', now()->subMonths()),
                    "within-3-month" => $sql->whereDate('created_at', '>=', now()->subMonths(3)),
                    default => $sql
                };
            });
            
            // Location Filter (Ø­Ø³Ø¨ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨)
            if ($locationLevel === 'area' && $request->filled('area_id')) {
                $q->where('area_id', $request->area_id);
            } elseif ($locationLevel === 'city' && $request->filled('city')) {
                $q->where('city', $request->city);
            } elseif ($locationLevel === 'state' && $request->filled('state')) {
                $q->where('state', $request->state);
            } elseif ($locationLevel === 'country' && $request->filled('country')) {
                $q->where('country', $request->country);
            }

            // Other Filters
            $q->when($request->filled('user_id'), fn($sql) => $sql->where('user_id', $request->user_id));
            $q->when($request->filled('slug'), fn($sql) => $sql->where('slug', $request->slug));

            // Radius/Haversine (Ø§Ù„ØªØ­Ø³ÙŠÙ† Ø¹Ø¨Ø± Bounding Box)
            $q->when($request->latitude && $request->longitude && $request->radius, function ($sql) use ($request) {
                $lat = (float) $request->latitude;
                $lon = (float) $request->longitude;
                $radius = (float) $request->radius; // KM

                // Bounding Box Calculation 
                $lat_degree = 111.045; 
                $lon_degree = $lat_degree * cos(deg2rad($lat)); 
                
                $min_lat = $lat - ($radius / $lat_degree);
                $max_lat = $lat + ($radius / $lat_degree);
                $min_lon = $lon - ($radius / $lon_degree);
                $max_lon = $lon + ($radius / $lon_degree);

                // Apply bounding box
                $sql->whereBetween('latitude', [$min_lat, $max_lat])
                    ->whereBetween('longitude', [$min_lon, $max_lon]);

                // Haversine Formula (ØªØ·Ø¨Ù‚ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù…ÙØµØºØ±Ø©)
                $haversine = "(6371 * acos(cos(radians(?)) * cos(radians(latitude)) * cos(radians(longitude) - radians(?)) + sin(radians(?)) * sin(radians(latitude))))";

                $sql->select('items.*')
                    // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ selectRaw Ù…Ø¹ Ø§Ù„ØªØ³Ø§Ø¤Ù„Ø§Øª Ù„ØªØ­Ø³ÙŠÙ† Ø§Ù„Ø£Ù…Ø§Ù†
                    ->selectRaw("{$haversine} AS distance", [$lat, $lon, $lat]) 
                    ->where('latitude', '!=', 0)
                    ->where('longitude', '!=', 0)
                    ->having('distance', '<', $radius)
                    ->orderBy('distance', 'asc');
            });

            return $q;
        };

        // --------------------------------------------------------------------
        // 2. Closure: ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø¹Ø¯Ù‘Ù„Ø§Øª Ø§Ù„Ù…Ø´ØªØ±ÙƒØ© (Ø§Ù„ØªØ±ØªÙŠØ¨ØŒ Ø§Ù„Ø­Ø§Ù„Ø©ØŒ Custom Fields)
        // --------------------------------------------------------------------
        $applyCommonModifiers = function ($sql, $request) {
            // Sort By
            if ($request->sort_by == "new-to-old") {
                $sql->orderBy('id', 'DESC');
            } elseif ($request->sort_by == "old-to-new") {
                $sql->orderBy('id', 'ASC');
            } elseif ($request->sort_by == "price-high-to-low") {
                $sql->orderBy('price', 'DESC');
            } elseif ($request->sort_by == "price-low-to-high") {
                $sql->orderBy('price', 'ASC');
            } elseif ($request->sort_by == "popular_items") {
                $sql->orderBy('clicks', 'DESC');
            } else {
                $sql->orderBy('id', 'DESC');
            }
            
            // Status handling
            if (!empty($request->status)) {
                if (in_array($request->status, ['review', 'approved', 'rejected', 'sold out', 'soft rejected', 'permanent rejected'])) {
                    $sql->where('status', $request->status)->getNonExpiredItems()->whereNull('deleted_at');
                } elseif ($request->status == 'inactive') {
                    $sql->onlyTrashed()->getNonExpiredItems();
                } elseif ($request->status == 'featured') {
                    $sql->where('status', 'approved')->has('featured_items')->getNonExpiredItems();
                } elseif ($request->status == 'expired') {
                    $sql->whereNotNull('expiry_date')
                          ->where('expiry_date', '<', Carbon::now())->whereNull('deleted_at');
                }
            }
            
            // Featured Section handling
            if (!empty($request->featured_section_id) || !empty($request->featured_section_slug)) {
                if (!empty($request->featured_section_id)) {
                    $featuredSection = FeatureSection::findOrFail($request->featured_section_id);
                } else {
                    $featuredSection = FeatureSection::where('slug', $request->featured_section_slug)->firstOrFail();
                }
                $sql = match ($featuredSection->filter) {
                    "price_criteria" => $sql->whereBetween('price', [$featuredSection->min_price, $featuredSection->max_price]),
                    "most_viewed" => $sql->reorder()->orderBy('clicks', 'DESC'),
                    "category_criteria" => (static function () use ($featuredSection, $sql) {
                        $category = Category::whereIn('id', explode(',', $featuredSection->value))->with('children')->get();
                        $categoryIDS = HelperService::findAllCategoryIds($category);
                        return $sql->whereIn('category_id', $categoryIDS);
                    })(),
                    "most_liked" => $sql->reorder()->withCount('favourites')->orderBy('favourites_count', 'DESC'),
                };
            }
            
            // Custom Fields (ØªØ­Ø³ÙŠÙ† Ø§Ø³ØªØ®Ø¯Ø§Ù… whereHas)
            $customFieldsInput = $request->all()['custom_fields'] ?? null;
            if (!empty($customFieldsInput)) {
                $customFields = $customFieldsInput;
                foreach ($customFields as $fieldId => $value) {
                    if (!empty($value)) {
                        $values = is_array($value) ? $value : [$value];
                        
                        $sql->whereHas('item_custom_field_values', function($q) use ($fieldId, $values) {
                            $q->where('custom_field_id', $fieldId)
                              ->where(function($qq) use ($values) {
                                  foreach ($values as $val) {
                                      // Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ø²Ø¦ÙŠ (LIKE)
                                      $qq->orWhere('value', 'LIKE', '%' . trim($val) . '%');
                                  }
                              });
                        });
                    }
                }
            }
            
            // Search Term
            $searchTerm = $request->search ?? null;
            if (!empty($searchTerm)) {
                $sql->search($searchTerm);
            }
            
            // Auth / Status Scoping
            if (Auth::check()) {
                $sql->with(['item_offers' => fn($q) => $q->where('buyer_id', Auth::user()->id)]);
                $sql->with(['user_reports' => fn($q) => $q->where('user_id', Auth::user()->id)]);
                
                $currentURI = explode('?', $request->getRequestUri(), 2);
                if ($currentURI[0] == "/api/my-items") {
                    $sql->where('user_id', Auth::user()->id)->withTrashed();
                } else {
                    $sql->where('status', 'approved')->has('user')->onlyNonBlockedUsers()->getNonExpiredItems();
                }
            } else {
                $sql->where('status', 'approved')->getNonExpiredItems();
            }

            return $sql;
        };

        // -----------------------------------------------------
        // 3. Ø­Ø§Ù„Ø© Ø¬Ù„Ø¨ Ø¥Ø¹Ù„Ø§Ù† ÙØ±Ø¯ÙŠ (ID Case) Ù…Ø¹ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø°Ø§Øª ØµÙ„Ø©
        // -----------------------------------------------------
        if ($request->filled('id')) {
            $sql = $buildQuery(null);
            $sql = $applyCommonModifiers($sql, $request);
            $item = $sql->first(); // Ù†Ø³ØªØ®Ø¯Ù… first Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† get

            if (!$item) {
                // ... logging here ...
                return ResponseService::errorResponse("No item Found");
            }
            
            // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø°Ø§Øª Ø§Ù„ØµÙ„Ø© (Related Items Logic)
            $relatedQuery = Item::query()
                ->where('id', '!=', $item->id) 
                ->where('status', 'approved')
                ->getNonExpiredItems() 
                ->where('category_id', $item->category_id) // Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
                ->orWhere(fn ($q) => $q->where('city', $item->city)->where('state', $item->state)) // Ø£Ùˆ Ø§Ù„Ù…ÙˆÙ‚Ø¹
                ->orderBy('created_at', 'DESC')
                ->limit(10)
                ->get();
            
            // Ø¥Ù„Ø­Ø§Ù‚ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø°Ø§Øª Ø§Ù„ØµÙ„Ø©
            $item->related_items = $relatedQuery;
            
            // Logging
            $executionTime = microtime(true) - $start;
            Log::info('getItem total time (SINGLE ID)', ['seconds' => $executionTime, 'url' => request()->fullUrl(), 'queries' => DB::getQueryLog()]);

            // ÙŠØ¬Ø¨ Ø§Ø³ØªØ®Ø¯Ø§Ù… ItemResource Ù„Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¥Ø¹Ù„Ø§Ù† Ø§Ù„ÙØ±Ø¯ÙŠ (Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ø´ÙƒÙ„)
            return ResponseService::successResponse("Advertisement Fetched Successfully", new \App\Http\Resources\ItemResource($item));
        }

        // -----------------------------------------------------
        // 4. Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø§Ù„Ù…ÙˆÙ‚Ø¹ÙŠ (Location Fallback Loop)
        // -----------------------------------------------------

        $initialLevel = null;
        if ($request->filled('area_id')) {
            $initialLevel = 'area';
        } elseif ($request->filled('city')) {
            $initialLevel = 'city';
        } elseif ($request->filled('state')) {
            $initialLevel = 'state';
        } elseif ($request->filled('country')) {
            $initialLevel = 'country';
        }

        $levelsOrder = match($initialLevel) {
            'area' => ['area', 'city', 'state', 'country', null],
            'city' => ['city', 'state', 'country', null],
            'state' => ['state', 'country', null],
            'country' => ['country', null],
            default => [null],
        };

        $result = null;
        $pageResult = null;
        $attemptDetails = [];

        foreach ($levelsOrder as $level) {
            $sqlAttempt = $buildQuery($level);
            $sqlAttempt = $applyCommonModifiers($sqlAttempt, $request);
            
            // Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± SELECT ÙÙŠ Ø­Ø§Ù„ Ø§Ø³ØªØ®Ø¯Ø§Ù… Haversine
            if ($request->latitude && $request->longitude && $request->radius) {
                // Ù†Ø¶Ù…Ù† DISTINCT Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù†Ø§ØªØ¬ Ø¹Ù† Ø§Ù„Ù€ JOIN ÙÙŠ custom_fields 
                // ÙˆÙ†Ø¯Ø±Ø¬ 'distance' ÙÙŠ Ø§Ù„Ù€ SELECT
                $sqlAttempt->distinct()->select(DB::raw('items.*, distance')); 
            } else {
                 $sqlAttempt->distinct()->select('items.*');
            }


            // ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØ±Ù‚ÙŠÙ… (Pagination)
            $limit = $request->limit ?? 15;
            $pageResult = $sqlAttempt->paginate($limit);
            
            $total = $pageResult instanceof \Illuminate\Pagination\LengthAwarePaginator ? $pageResult->total() : (is_countable($pageResult) ? count($pageResult) : 0);

            $attemptDetails[] = ['level' => $level, 'total' => $total];
            Log::info('getItem: location fallback attempt', end($attemptDetails));
            
            if ($total > 0) {
                $result = $pageResult;
                break;
            }
        }

        // 5. Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©
        if (is_null($result)) {
            // Ù†Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø± Ù†ØªÙŠØ¬Ø© ØªØ±Ù‚ÙŠÙ… (PageResult) Ø­ØªÙ‰ Ù„Ùˆ ÙƒØ§Ù†Øª ÙØ§Ø±ØºØ©
            $result = $pageResult;
        }

        $beforeResponse = microtime(true) - $start;
        Log::info('getItem BEFORE ResponseService', ['seconds' => $beforeResponse, 'queries_count' => count(DB::getQueryLog()), 'attempts' => $attemptDetails]);

        // Ù†Ø³ØªØ®Ø¯Ù… ItemCollection Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø´ÙƒÙ„ Ø§Ù„Ø¯Ø§ØªØ§ (Ø­Ø§Ù„Ø© Ø§Ù„ØªØµÙØ­)
        $response = ResponseService::successResponse("Advertisement Fetched Successfully", new ItemCollection($result));
        
        $afterResponse = microtime(true) - $start;
        Log::info('getItem AFTER ResponseService', ['seconds' => $afterResponse, 'difference' => $afterResponse - $beforeResponse]);
        
        return $response;

    } catch (\Throwable $th) {
        $executionTime = microtime(true) - $start;
        Log::error('getItem total time (ERROR)', ['seconds' => $executionTime, 'url' => request()->fullUrl(), 'error' => $th->getMessage()]);
        Log::error('getItem queries (ERROR)', DB::getQueryLog());
        ResponseService::logErrorResponse($th, "API Controller -> getItem");
        return ResponseService::errorResponse("Something went wrong");
    } finally {
        // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù€ Query Log ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ©
        DB::connection()->disableQueryLog();
    }
}


 public function updateItem(Request $request) {
        $validator = Validator::make($request->all(), [
            'id'                   => 'required',
            'name'                 => 'nullable',
            'slug'                 => 'regex:/^[a-z0-9-]+$/',
            'price'                => 'nullable',
            'description'          => 'nullable',
            'latitude'             => 'nullable',
            'longitude'            => 'nullable',
            'address'              => 'nullable',
            'contact'              => 'nullable',
            'image'                => 'nullable|mimes:jpeg,jpg,png|max:7168',
            'custom_fields'        => 'nullable',
            'custom_field_files'   => 'nullable|array',
            'custom_field_files.*' => 'nullable|mimes:jpeg,png,jpg,pdf,doc|max:7168',
            'gallery_images'       => 'nullable|array',
        ]);
        if ($validator->fails()) {
            ResponseService::validationError($validator->errors()->first());
        }

        DB::beginTransaction();

        try {

            $item = Item::owner()->findOrFail($request->id);
            $auto_approve_item = Setting::where('name', "auto_approve_edited_item")->value('value') ?? 0;
            if($auto_approve_item == 1){
                $status = "approved";
            }else{
                $status = "review";
            }

            $slug = $request->input('slug', $item->slug);
            $uniqueSlug = HelperService::generateUniqueSlug(new Item(), $slug,$request->id);

            $data = $request->all();
            $data['slug'] = $uniqueSlug;
            $data['status'] = $status;
            if ($request->hasFile('image')) {
                $data['image'] = FileService::compressAndReplace($request->file('image'), $this->uploadFolder, $item->getRawOriginal('image'));
            }

            $item->update($data);

            //Update Custom Field values for item
            if ($request->custom_fields) {
                $itemCustomFieldValues = [];
                foreach (json_decode($request->custom_fields, true, 512, JSON_THROW_ON_ERROR) as $key => $custom_field) {
                    $itemCustomFieldValues[] = [
                        'item_id'         => $item->id,
                        'custom_field_id' => $key,
                        'value'           => json_encode($custom_field, JSON_THROW_ON_ERROR),
                        'updated_at'      => time()
                    ];
                }

                if (count($itemCustomFieldValues) > 0) {
                    ItemCustomFieldValue::upsert($itemCustomFieldValues, ['item_id', 'custom_field_id'], ['value', 'updated_at']);
                }
            }

            //Add new gallery images
            if ($request->hasFile('gallery_images')) {
                $galleryImages = [];
                foreach ($request->file('gallery_images') as $file) {
                    $galleryImages[] = [
                        'image'      => FileService::compressAndUpload($file, $this->uploadFolder),
                        'item_id'    => $item->id,
                        'created_at' => time(),
                        'updated_at' => time(),
                    ];
                }
                if (count($galleryImages) > 0) {
                    ItemImages::insert($galleryImages);
                }
            }

            if ($request->custom_field_files) {
                $itemCustomFieldValues = [];
                foreach ($request->custom_field_files as $key => $file) {
                    $value = ItemCustomFieldValue::where(['item_id' => $item->id, 'custom_field_id' => $key])->first();
                    if (!empty($value)) {
                        $file = FileService::replace($file, 'custom_fields_files', $value->getRawOriginal('value'));
                    } else {
                        $file = '';
                    }
                    $itemCustomFieldValues[] = [
                        'item_id'         => $item->id,
                        'custom_field_id' => $key,
                        'value'           => $file,
                        'updated_at'      => time()
                    ];
                }

                if (count($itemCustomFieldValues) > 0) {
                    ItemCustomFieldValue::upsert($itemCustomFieldValues, ['item_id', 'custom_field_id'], ['value', 'updated_at']);
                }
            }

            //Delete gallery images
            if (!empty($request->delete_item_image_id)) {
                $item_ids = explode(',', $request->delete_item_image_id);
                foreach (ItemImages::whereIn('id', $item_ids)->get() as $itemImage) {
                    FileService::delete($itemImage->getRawOriginal('image'));
                    $itemImage->delete();
                }
            }

            $result = Item::with('user:id,name,email,mobile,profile,country_code', 'category:id,name,image,is_job_category,price_optional', 'gallery_images:id,image,item_id', 'featured_items', 'favourites', 'item_custom_field_values.custom_field', 'area')->where('id', $item->id)->get();
            /*
             * Collection does not support first OR find method's result as of now. It's a part of R&D
             * So currently using this shortcut method
            */
            $result = new ItemCollection($result);


            DB::commit();
            ResponseService::successResponse("Advertisement Fetched Successfully", $result);
        } catch (Throwable $th) {
            DB::rollBack();
            ResponseService::logErrorResponse($th, "API Controller -> updateItem");
            ResponseService::errorResponse();
        }
    }



public function deleteItem(Request $request) {
        try {
            $validator = Validator::make($request->all(), [
                'id' => 'required',
            ]);
            if ($validator->fails()) {
                ResponseService::errorResponse($validator->errors()->first());
            }
            $item = Item::owner()->with('gallery_images')->withTrashed()->findOrFail($request->id);
            FileService::delete($item->getRawOriginal('image'));

            if (count($item->gallery_images) > 0) {
                foreach ($item->gallery_images as $key => $value) {
                    FileService::delete($value->getRawOriginal('image'));
                }
            }

            $item->forceDelete();
            ResponseService::successResponse("Advertisement Deleted Successfully");
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> deleteItem");
            ResponseService::errorResponse();
        }
    }
public function updateItemStatus(Request $request) {
        $validator = Validator::make($request->all(), [
            'item_id' => 'required|integer',
            'status'  => 'required|in:sold out,inactive,active,resubmitted',
            // 'sold_to' => 'required_if:status,==,sold out|integer'
            'sold_to' => 'nullable|integer'
        ]);

        if ($validator->fails()) {
            ResponseService::validationError($validator->errors()->first());
        }
        try {
            $item = Item::owner()->whereNotIn('status', ['review', 'permanent rejected'])->withTrashed()->findOrFail($request->item_id);
            if ($item->status == 'permanent rejected' && $request->status == 'resubmitted') {
                ResponseService::errorResponse("This Advertisement is permanently rejected and cannot be resubmitted");
            }
            if ($request->status == "inactive") {
                $item->delete();
            } else if ($request->status == "active") {
                $item->restore();
                $item->update(['status' => 'review']);
            } else if ($request->status == "sold out") {
                $item->update([
                    'status'  => 'sold out',
                    'sold_to' => $request->sold_to
                ]);
            } else {
                $item->update(['status' => $request->status]);
            }
            ResponseService::successResponse('Advertisement Status Updated Successfully');
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, 'ItemController -> updateItemStatus');
            ResponseService::errorResponse('Something Went Wrong');
        }
    }
 public function getItemBuyerList(Request $request) {
        $validator = Validator::make($request->all(), [
            'item_id' => 'required|integer'
        ]);

        if ($validator->fails()) {
            ResponseService::validationError($validator->errors()->first());
        }
        try {
            $buyer_ids = ItemOffer::where('item_id', $request->item_id)->select('buyer_id')->pluck('buyer_id');
            $users = User::select(['id', 'name', 'profile'])->whereIn('id', $buyer_ids)->get();
            ResponseService::successResponse('Buyer List fetched Successfully', $users);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, 'ItemController -> updateItemStatus');
            ResponseService::errorResponse('Something Went Wrong');
        }
    }
    public function getSubCategories(Request $request) {
        $validator = Validator::make($request->all(), [
            'category_id' => 'nullable|integer'
        ]);

        if ($validator->fails()) {
            ResponseService::validationError($validator->errors()->first());
        }
        try {
            $sql = Category::withCount(['subcategories' => function ($q) {
                $q->where('status', 1);
            }])->with('translations')->where(['status' => 1])->orderBy('sequence', 'ASC')
                ->with(['subcategories'          => function ($query) {
                    $query->where('status', 1)->orderBy('sequence', 'ASC')->with('translations')->withCount(['approved_items', 'subcategories' => function ($q) {
                        $q->where('status', 1);
                    }]); // Order subcategories by 'sequence'
                },
                 'subcategories.subcategories' => function ($query) {
                    $query->where('status', 1)->orderBy('sequence', 'ASC')->with('translations')->withCount(['approved_items', 'subcategories' => function ($q) {
                        $q->where('status', 1);
                    }]);
                },
                'subcategories.subcategories.subcategories' => function ($query) {
                    $query->where('status', 1)->orderBy('sequence', 'ASC')->with('translations')->withCount(['approved_items', 'subcategories' => function ($q) {
                        $q->where('status', 1);
                    }]);
                },'subcategories.subcategories.subcategories.subcategories' => function ($query) {
                    $query->where('status', 1)->orderBy('sequence', 'ASC')->with('translations')->withCount(['approved_items', 'subcategories' => function ($q) {
                        $q->where('status', 1);
                    }]);
                },'subcategories.subcategories.subcategories.subcategories.subcategories' => function ($query) {
                    $query->where('status', 1)->orderBy('sequence', 'ASC')->with('translations')->withCount(['approved_items', 'subcategories' => function ($q) {
                        $q->where('status', 1);
                    }]);
                }
            ]);
            if (!empty($request->category_id)) {
                $sql = $sql->where('parent_category_id', $request->category_id);
            } else if (!empty($request->slug)) {
                $parentCategory = Category::where('slug', $request->slug)->firstOrFail();
                $sql = $sql->where('parent_category_id', $parentCategory->id);
            } else {
                $sql = $sql->whereNull('parent_category_id');
            }

            $sql = $sql->paginate();
            $sql->map(function ($category) {
                $category->all_items_count = $category->all_items_count;
                return $category;
            });
            ResponseService::successResponse(null, $sql, ['self_category' => $parentCategory ?? null]);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, 'API Controller -> getCategories');
            ResponseService::errorResponse();
        }
    }

    public function getParentCategoryTree(Request $request) {
        $validator = Validator::make($request->all(), [
            'child_category_id' => 'nullable|integer',
            'tree'              => 'nullable|boolean',
            'slug'              => 'nullable|string'
        ]);

        if ($validator->fails()) {
            ResponseService::validationError($validator->errors()->first());
        }
        try {
            $sql = Category::when($request->child_category_id, function ($sql) use ($request) {
                $sql->where('id', $request->child_category_id);
            })
                ->when($request->slug, function ($sql) use ($request) {
                    $sql->where('slug', $request->slug);
                })
                ->firstOrFail()
                ->ancestorsAndSelf()->breadthFirst()->get();
            if ($request->tree) {
                $sql = $sql->toTree();
            }
            ResponseService::successResponse(null, $sql);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, 'API Controller -> getCategories');
            ResponseService::errorResponse();
        }
    }

 public function getNotificationList() {
        try {
            $notifications = Notifications::whereRaw("FIND_IN_SET(" . Auth::user()->id . ",user_id)")->orWhere('send_to', 'all')->orderBy('id', 'DESC')->paginate();
            ResponseService::successResponse(__('Notification fetched successfully'), $notifications);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, 'API Controller -> getNotificationList');
            ResponseService::errorResponse();
        }
    }

     public function getLanguages(Request $request) {
        try {
            $validator = Validator::make($request->all(), [
                'language_code' => 'required',
                'type'          => 'nullable|in:app,web'
            ]);

            if ($validator->fails()) {
                return ResponseService::validationError($validator->errors()->first());
            }
            $language = Language::where('code', $request->language_code)->firstOrFail();
            if ($request->type == "web") {
                $json_file_path = base_path('resources/lang/' . $request->language_code . '_web.json');
            } else {
                $json_file_path = base_path('resources/lang/' . $request->language_code . '_app.json');
            }

            if (!is_file($json_file_path)) {
                return ResponseService::errorResponse(__('Language file not found'));
            }

            $json_string = file_get_contents($json_file_path);
            $json_data = json_decode($json_string, false, 512, JSON_THROW_ON_ERROR);

            if ($json_data == null) {
                return ResponseService::errorResponse(__('Invalid JSON format in the language file'));
            }
            $language->file_name = $json_data;

            return ResponseService::successResponse(__('Data Fetched Successfully'), $language);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> getLanguages");
            return ResponseService::errorResponse();
        }
    }



    public function appPaymentStatus(Request $request) {
        try {
            $paypalInfo = $request->all();
            if (!empty($paypalInfo) && isset($_GET['st']) && strtolower($_GET['st']) == "completed") {
                ResponseService::successResponse(__('Your Package will be activated within 10 Minutes'), $paypalInfo['txn_id']);
            } elseif (!empty($paypalInfo) && isset($_GET['st']) && strtolower($_GET['st']) == "authorized") {
                ResponseService::successResponse(__('Your Transaction is Completed. Ads wil be credited to your account within 30 minutes.'), $paypalInfo);
            } else {
                ResponseService::errorResponse(__('Payment Cancelled / Declined'), (isset($_GET)) ? $paypalInfo : "");
            }
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> appPaymentStatus");
            ResponseService::errorResponse();
        }
    }

    public function getPaymentSettings() {
        try {
            $result = PaymentConfiguration::select(['currency_code', 'payment_method', 'api_key', 'status'])->where('status', 1)->get();
            $response = [];
            foreach ($result as $payment) {
                $response[$payment->payment_method] = $payment->toArray();
            }
            $settings = Setting::whereIn('name', [
                'account_holder_name',
                'bank_name',
                'account_number',
                'ifsc_swift_code',
                'bank_transfer_status'
            ])->get();

            $bankDetails = [];
            foreach ($settings as $row) {
                $key = ($row->name === 'bank_transfer_status') ? 'status' : $row->name;
                $bankDetails[$key] = $row->value;
            }
            $response['bankTransfer'] = $bankDetails;
            ResponseService::successResponse(__('Data Fetched Successfully'), $response);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> getPaymentSettings");
            ResponseService::errorResponse();
        }
    }
public function getCustomFields(Request $request) {
    try {
        $customFields = CustomField::whereHas('custom_field_category', function ($q) use ($request) {
            $q->whereIn('category_id', explode(',', $request->input('category_ids')));
        })->where('status', 1)->get();

        // âœ… Ù…Ù†Ø¹ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ± Ù„Ù„ÙØ±ÙˆÙ†Øª
        $customFields->transform(function ($field) {
            $field->image = null;
            return $field;
        });

        ResponseService::successResponse("Data Fetched successfully", $customFields);
    } catch (Throwable $th) {
        ResponseService::logErrorResponse($th, "API Controller -> getCustomFields");
        ResponseService::errorResponse();
    }
}
 public function makeFeaturedItem(Request $request) {
        $validator = Validator::make($request->all(), [
            'item_id' => 'required|integer',
        ]);
        if ($validator->fails()) {
            ResponseService::validationError($validator->errors()->first());
        }
        try {
            DB::commit();
            $user = Auth::user();
            Item::where('status', 'approved')->findOrFail($request->item_id);
            $user_package = UserPurchasedPackage::onlyActive()
                ->where(['user_id' => $user->id])
                ->with('package')
                ->whereHas('package', function ($q) {
                    $q->where(['type' => 'advertisement']);
                })
                ->first();

            if (!$user_package) {
                return ResponseService::errorResponse('You need to purchase a Featured Ad plan first.');
            }
            $featuredItems = FeaturedItems::where(['item_id' => $request->item_id, 'package_id' => $user_package->package_id])->first();
            if (!empty($featuredItems)) {
                ResponseService::errorResponse("Advertisement is already featured");
            }

            ++$user_package->used_limit;
            $user_package->save();

            FeaturedItems::create([
                'item_id'                   => $request->item_id,
                'package_id'                => $user_package->package_id,
                'user_purchased_package_id' => $user_package->id,
                'start_date'                => date('Y-m-d'),
                'end_date'                  => $user_package->end_date
            ]);

            DB::commit();
            ResponseService::successResponse("Featured Advertisement Created Successfully");
        } catch (Throwable $th) {
            DB::rollBack();
            ResponseService::logErrorResponse($th, "API Controller -> createAdvertisement");
            ResponseService::errorResponse();
        }
    }
public function manageFavourite(Request $request) {
        try {
            $validator = Validator::make($request->all(), [
                'item_id' => 'required',
            ]);
            if ($validator->fails()) {
                ResponseService::validationError($validator->errors()->first());
            }
            $favouriteItem = Favourite::where('user_id', Auth::user()->id)->where('item_id', $request->item_id)->first();
            if (empty($favouriteItem)) {
                $favouriteItem = new Favourite();
                $favouriteItem->user_id = Auth::user()->id;
                $favouriteItem->item_id = $request->item_id;
                $favouriteItem->save();
                ResponseService::successResponse("Advertisement added to Favourite");
            } else {
                $favouriteItem->delete();
                ResponseService::successResponse("Advertisement remove from Favourite");
            }
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> manageFavourite");
            ResponseService::errorResponse();
        }
    }

 public function makeFeaturedItem2(Request $request) {
        $validator = Validator::make($request->all(), [
            'item_id' => 'required|integer',
        ]);
        if ($validator->fails()) {
            ResponseService::validationError($validator->errors()->first());
        }
        try {
            DB::commit();
            $user = Auth::user();
            Item::where('status', 'approved')->findOrFail($request->item_id);
            $user_package = UserPurchasedPackage::onlyActive()
                ->where(['user_id' => $user->id])
                ->with('package')
                ->whereHas('package', function ($q) {
                    $q->where(['type' => 'advertisement']);
                })
                ->first();

            if (!$user_package) {
                return ResponseService::errorResponse('You need to purchase a Featured Ad plan first.');
            }
            $featuredItems = FeaturedItems::where(['item_id' => $request->item_id, 'package_id' => $user_package->package_id])->first();
            if (!empty($featuredItems)) {
                ResponseService::errorResponse("Advertisement is already featured");
            }

            ++$user_package->used_limit;
            $user_package->save();

            FeaturedItems::create([
                'item_id'                   => $request->item_id,
                'package_id'                => $user_package->package_id,
                'user_purchased_package_id' => $user_package->id,
                'start_date'                => date('Y-m-d'),
                'end_date'                  => $user_package->end_date
            ]);

            DB::commit();
            ResponseService::successResponse("Featured Advertisement Created Successfully");
        } catch (Throwable $th) {
            DB::rollBack();
            ResponseService::logErrorResponse($th, "API Controller -> createAdvertisement");
            ResponseService::errorResponse();
        }
    }
public function manageFavourite2(Request $request) {
        try {
            $validator = Validator::make($request->all(), [
                'item_id' => 'required',
            ]);
            if ($validator->fails()) {
                ResponseService::validationError($validator->errors()->first());
            }
            $favouriteItem = Favourite::where('user_id', Auth::user()->id)->where('item_id', $request->item_id)->first();
            if (empty($favouriteItem)) {
                $favouriteItem = new Favourite();
                $favouriteItem->user_id = Auth::user()->id;
                $favouriteItem->item_id = $request->item_id;
                $favouriteItem->save();
                ResponseService::successResponse("Advertisement added to Favourite");
            } else {
                $favouriteItem->delete();
                ResponseService::successResponse("Advertisement remove from Favourite");
            }
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> manageFavourite");
            ResponseService::errorResponse();
        }
    }
    public function getFavouriteItem(Request $request) {
        try {
            $validator = Validator::make($request->all(), [
                'page' => 'nullable|integer',
                'limit' => 'nullable|integer',
            ]);
            if ($validator->fails()) {
                ResponseService::validationError($validator->errors()->first());
            }
            $favouriteItemIDS = Favourite::where('user_id', Auth::user()->id)->select('item_id')->pluck('item_id');
            $items = Item::whereIn('id', $favouriteItemIDS)
                ->with('user:id,name,email,mobile,profile,country_code', 'category:id,name,image', 'gallery_images:id,image,item_id', 'featured_items', 'favourites', 'item_custom_field_values.custom_field')->where('status','approved')->onlyNonBlockedUsers()->getNonExpiredItems()->paginate();

            ResponseService::successResponse(__('Data Fetched Successfully'), new ItemCollection($items));
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> getFavouriteItem");
            ResponseService::errorResponse();
        }
    }

public function getSlider() {
    try {
        $rows = Slider::with(['model' => function (MorphTo $morphTo) {
            $morphTo->constrain([
                Category::class => function ($query) {
                    $query->withCount('subcategories')
                          ->with('translations');  // Ø¬Ù„Ø¨ Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª Ù…Ø¹ Ø§Ù„Ù€ category
                },
                Item::class => function ($query) {
                    // Ø¥Ø°Ø§ Ù…Ø§ ØªØ­ØªØ§Ø¬ Ø´ÙŠ Ø®Ø§Øµ Ù…Ù† Ø§Ù„Ù€ Item Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±Øº
                }
            ]);
        }])
        ->where(function ($query) {
            $query->whereNull('model_type')
                  ->orWhere(function ($query) {
                      $query->whereHasMorph('model', [Category::class, Item::class], function ($subQuery) {
                          $subQuery->whereNotNull('id');
                      });
                  });
        })
        ->get();

        ResponseService::successResponse(null, $rows);
    } catch (Throwable $th) {
        ResponseService::logErrorResponse($th, "API Controller -> getSlider");
        ResponseService::errorResponse();
    }
}



    public function getReportReasons(Request $request) {
        try {
            $report_reason = new ReportReason();
            if (!empty($request->id)) {
                $id = $request->id;
                $report_reason->where('id', '=', $id);
            }
            $result = $report_reason->paginate();
            $total = $report_reason->count();
            ResponseService::successResponse("Data Fetched Successfully", $result, ['total' => $total]);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> getReportReasons");
            ResponseService::errorResponse();
        }
    }


    public function addReports(Request $request) {
        try {
            $validator = Validator::make($request->all(), [
                'item_id'          => 'required',
                'report_reason_id' => 'required_without:other_message',
                'other_message'    => 'required_without:report_reason_id'
            ]);
            if ($validator->fails()) {
                ResponseService::validationError($validator->errors()->first());
            }
            $user = Auth::user();
            $report_count = UserReports::where('item_id', $request->item_id)->where('user_id', $user->id)->first();
            if ($report_count) {
                ResponseService::errorResponse(__('Already Reported'));
            }
            UserReports::create([
                ...$request->all(),
                'user_id'       => $user->id,
                'other_message' => $request->other_message ?? '',
            ]);
            ResponseService::successResponse(__('Report Submitted Successfully'));
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> addReports");
            ResponseService::errorResponse();
        }
    }

    public function setItemTotalClick(Request $request) {
        try {

            $validator = Validator::make($request->all(), [
                'item_id' => 'required',
            ]);

            if ($validator->fails()) {
                ResponseService::validationError($validator->errors()->first());
            }
            Item::findOrFail($request->item_id)->increment('clicks');
            ResponseService::successResponse(null, 'Update Successfully');
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> setItemTotalClick");
            ResponseService::errorResponse();
        }
    }

    public function getFeaturedSection(Request $request) {
        try {
            $featureSection = FeatureSection::orderBy('sequence', 'ASC');

            if (isset($request->slug)) {
                $featureSection->where('slug', $request->slug);
            }
            $featureSection = $featureSection->get();
            $tempRow = array();
            $rows = array();

            foreach ($featureSection as $row) {
                 $items = Item::where('status', 'approved')->take(5)->with('user:id,name,email,mobile,profile,is_verified,show_personal_details,country_code', 'category:id,name,image,is_job_category,price_optional', 'gallery_images:id,image,item_id', 'featured_items', 'favourites', 'item_custom_field_values.custom_field')->has('user')->getNonExpiredItems();

                if (isset($request->city)) {
                    $items = $items->where('city', $request->city);
                }

                if (isset($request->state)) {
                    $items = $items->where('state', $request->state);
                }

                if (isset($request->country)) {
                    $items = $items->where('country', $request->country);
                }

                if (isset($request->area_id)) {
                    $items = $items->where('area_id', $request->area_id);
                }
                if(isset($request->latitude) &&  isset($request->longitude) && isset($request->radius)){
                    $latitude = $request->latitude;
                    $longitude = $request->longitude;
                    $radius = $request->radius;

                    // Calculate distance using Haversine formula
                    $haversine = "(6371 * acos(cos(radians($latitude))
                                    * cos(radians(latitude))
                                    * cos(radians(longitude)
                                    - radians($longitude))
                                    + sin(radians($latitude))
                                    * sin(radians(latitude))))";

                    $items= $items->select('items.*')
                        ->selectRaw("{$haversine} AS distance")
                        ->where('latitude', '!=', 0)
                        ->where('longitude', '!=', 0)
                        ->having('distance', '<', $radius)
                        ->orderBy('distance', 'asc');
                }
                $items = match ($row->filter) {
                    "price_criteria" => $items->whereBetween('price', [$row->min_price, $row->max_price]),
                    "most_viewed" => $items->orderBy('clicks', 'DESC'),
                    "category_criteria" => (static function () use ($row, $items) {
                        $category = Category::whereIn('id', explode(',', $row->value))->with('children')->get();
                        $categoryIDS = HelperService::findAllCategoryIds($category);
                        return $items->whereIn('category_id', $categoryIDS)->orderBy('id', 'DESC');
                    })(),
                    "most_liked" => $items->withCount('favourites')->orderBy('favourites_count', 'DESC'),
                };
                if (Auth::check()) {
                    $items->with(['item_offers' => function ($q) {
                        $q->where('buyer_id', Auth::user()->id);
                    }, 'user_reports'           => function ($q) {
                        $q->where('user_id', Auth::user()->id);
                    }]);
                }
                $items = $items->get();
//                $tempRow[$row->id]['section_id'] = $row->id;
//                $tempRow[$row->id]['title'] = $row->title;
//                $tempRow[$row->id]['style'] = $row->style;

                $tempRow[$row->id] = $row;
                $tempRow[$row->id]['total_data'] = count($items);
                if (count($items) > 0) {
                    $tempRow[$row->id]['section_data'] = new ItemCollection($items);
                } else {
                    $tempRow[$row->id]['section_data'] = [];
                }

                $rows[] = $tempRow[$row->id];
            }
            ResponseService::successResponse(__('Data Fetched Successfully'), $rows);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> getFeaturedSection");
            ResponseService::errorResponse();
        }
    }

    public function getPaymentIntent(Request $request) {
        $validator = Validator::make($request->all(), [
            'package_id'     => 'required',
            'payment_method' => 'required|in:Stripe,Razorpay,Paystack,PhonePe,FlutterWave,bankTransfer',
            'platform_type'  => 'required_if:payment_method,==,Paystack|string'
        ]);
        if ($validator->fails()) {
            ResponseService::validationError($validator->errors()->first());
        }
        try {
            DB::beginTransaction();

            if ($request->payment_method !== 'bankTransfer') {
                $paymentConfigurations = PaymentConfiguration::where(['status' => 1, 'payment_method' => $request->payment_method])->first();
                if (empty($paymentConfigurations)) {
                    ResponseService::errorResponse(__('Payment is not Enabled'));
                }
            }else {
                $bankTransferEnabled = Setting::where('name', 'bank_transfer_status')->value('value');
                if ($bankTransferEnabled != 1) {
                    ResponseService::errorResponse(__('Bank Transfer is not enabled.'));
                }
            }

            $package = Package::whereNot('final_price', 0)->findOrFail($request->package_id);

            $purchasedPackage = UserPurchasedPackage::onlyActive()->where(['user_id' => Auth::user()->id, 'package_id' => $request->package_id])->first();
            if (!empty($purchasedPackage)) {
                ResponseService::errorResponse(__('You already have purchased this package'));
            }
            if ($request->payment_method === 'bankTransfer') {
                $existingTransaction = PaymentTransaction::where('user_id', Auth::user()->id)
                    ->where('payment_gateway', 'BankTransfer')
                    ->where('order_id', $package->id)
                    ->whereIn('payment_status',['pending','under review'])
                    ->exists();

                if ($existingTransaction) {
                    return ResponseService::errorResponse(__('A bank transfer transaction for this package already exists.'));
                }
            }
            $orderId = ($request->payment_method === 'bankTransfer') ? uniqid() . '-' . 'p' . '-' . $package->id : null;

            //Add Payment Data to Payment Transactions Table
            $paymentTransactionData = PaymentTransaction::create([
                'user_id'         => Auth::user()->id,
                'amount'          => $package->final_price,
                'payment_gateway' => ucfirst($request->payment_method),
                'payment_status'  => 'Pending',
                'order_id'        => $orderId
            ]);

            if ($request->payment_method === 'bankTransfer') {
                DB::commit();
                ResponseService::successResponse(__('Bank transfer initiated. Please complete the transfer and update the transaction.'), [
                    "payment_transaction_id" => $paymentTransactionData->id,
                    "payment_transaction"    => $paymentTransactionData
                ]);
            }

            $paymentIntent = PaymentService::create($request->payment_method)->createAndFormatPaymentIntent(round($package->final_price, 2), [
                'payment_transaction_id' => $paymentTransactionData->id,
                'package_id'             => $package->id,
                'user_id'                => Auth::user()->id,
                'email'                  => Auth::user()->email,
                'platform_type'          => $request->platform_type
            ]);
            $paymentTransactionData->update(['order_id' => $paymentIntent['id']]);

            $paymentTransactionData = PaymentTransaction::findOrFail($paymentTransactionData->id);
            // Custom Array to Show as response
            $paymentGatewayDetails = array(
                ...$paymentIntent,
                'payment_transaction_id' => $paymentTransactionData->id,
            );

            DB::commit();
            ResponseService::successResponse("", ["payment_intent" => $paymentGatewayDetails, "payment_transaction" => $paymentTransactionData]);
        } catch (Throwable $e) {
            DB::rollBack();
            ResponseService::logErrorResponse($e);
            ResponseService::errorResponse();
        }
    }

    public function getPaymentTransactions(Request $request) {
        $validator = Validator::make($request->all(), [
            'latest_only' => 'nullable|boolean',
            'page'       =>'nullable'
        ]);

        if ($validator->fails()) {
            ResponseService::validationError($validator->errors()->first());
        }
        try {
            $paymentTransactions = PaymentTransaction::where('user_id', Auth::user()->id)->orderBy('id', 'DESC');
            if ($request->latest_only) {
                $paymentTransactions->where('created_at', '>', Carbon::now()->subMinutes(30)->toDateTimeString());
            }
            $paymentTransactions = $paymentTransactions->paginate();

            $paymentTransactions->getCollection()->transform(function ($data) {
                if ($data->payment_status == "pending") {
                    try {
                        $paymentIntent = PaymentService::create($data->payment_gateway)->retrievePaymentIntent($data->order_id);
                    } catch (Throwable) {
//                        PaymentTransaction::find($data->id)->update(['payment_status' => "failed"]);
                    }

                    if (!empty($paymentIntent) && $paymentIntent['status'] != "pending") {
                        PaymentTransaction::find($data->id)->update(['payment_status' => $paymentIntent['status'] ?? "failed"]);
                    }
                }
                $data->payment_reciept = $data->payment_reciept;
                return $data;
            });

            ResponseService::successResponse(__('Payment Transactions Fetched'), $paymentTransactions);
        } catch (Throwable $e) {
            ResponseService::logErrorResponse($e);
            ResponseService::errorResponse();
        }
    }

    public function createItemOffer(Request $request) {

        $validator = Validator::make($request->all(), [
            'item_id' => 'required|integer',
            'amount'  => 'nullable|numeric',
        ]);
        if ($validator->fails()) {
            ResponseService::validationError($validator->errors()->first());
        }
        try {
            $item = Item::approved()->notOwner()->findOrFail($request->item_id);
            $itemOffer = ItemOffer::updateOrCreate([
                'item_id'   => $request->item_id,
                'buyer_id'  => Auth::user()->id,
                'seller_id' => $item->user_id,
            ], ['amount' => $request->amount,]);

            $itemOffer = $itemOffer->load('seller:id,name,profile', 'buyer:id,name,profile', 'item:id,name,description,price,image');

            $fcmMsg = [
                'user_id'           => $itemOffer->buyer->id,
                'user_name'         => $itemOffer->buyer->name,
                'user_profile'      => $itemOffer->buyer->profile,
                'user_type'         => 'Buyer',
                'item_id'           => $itemOffer->item->id,
                'item_name'         => $itemOffer->item->name,
                'item_image'        => $itemOffer->item->image,
                'item_price'        => $itemOffer->item->price,
                'item_offer_id'     => $itemOffer->id,
                'item_offer_amount' => $itemOffer->amount,
                // 'type'              => $notificationPayload['message_type'],
                // 'message_type_temp' => $notificationPayload['message_type']
            ];
            /* message_type is reserved keyword in FCM so removed here*/
unset($fcmMsg['message_type']);

if ($request->has('amount') && $request->amount != 0) {
    $user_token = UserFcmToken::where('user_id', $item->user->id)->pluck('fcm_token')->toArray();
    
    $title = [
        'en' => 'New Offer',
        'ar' => 'Ø¹Ø±Ø¶ Ø¬Ø¯ÙŠØ¯'
    ];

    $message = [
        'en' => 'A new offer is created by buyer',
        'ar' => 'ÙŠÙˆØ¬Ø¯ Ø¹Ø±Ø¶ Ø¬Ø¯ÙŠØ¯ Ù…Ù† Ù‚Ø¨Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠ' 
    ];

    NotificationService::sendFcmNotification($user_token, $title, $message, "offer", $fcmMsg);


            }

            ResponseService::successResponse(__('Advertisement Offer Created Successfully'), $itemOffer,);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> createItemOffer");
            ResponseService::errorResponse();
        }
    }

    public function getChatList(Request $request) {
        $validator = Validator::make($request->all(), [
            'type' => 'required|in:seller,buyer'
        ]);
        if ($validator->fails()) {
            ResponseService::validationError($validator->errors()->first());
        }
        try {
            //List of Blocked Users by Auth Users
            $authUserBlockList = BlockUser::where('user_id', Auth::user()->id)->pluck('blocked_user_id');

            $otherUserBlockList = BlockUser::where('blocked_user_id', Auth::user()->id)->pluck('user_id');
            $itemOffer = ItemOffer::with(['seller:id,name,profile', 'buyer:id,name,profile', 'item:id,name,description,price,image,status,deleted_at,sold_to,category_id,min_salary,max_salary',
            'item.category:id,name,image,is_job_category,price_optional',
            'item.review' => function ($q) {
                $q->where('buyer_id', Auth::user()->id);
            }])->whereHas('buyer', function ($query) {
                $query->whereNull('deleted_at');
            })
                ->with(['chat' => function ($query) {
                    $query->latest('updated_at')->select('updated_at', 'item_offer_id','is_read','sender_id');
                }])->withCount([
                    'chat as unread_chat_count' => function ($query) {
                        $query->where('is_read', 0)
                             ->where('sender_id', '!=', Auth::user()->id);
                    }
                ])
                ->orderBy('id', 'DESC');
            if ($request->type == "seller") {
                $itemOffer = $itemOffer->where('seller_id', Auth::user()->id);
            } elseif ($request->type == "buyer") {
                $itemOffer = $itemOffer->where('buyer_id', Auth::user()->id);
            }
            $itemOffer = $itemOffer->paginate();
            $totalUnreadChatCount = $itemOffer->sum('unread_chat_count');

            $itemOffer->getCollection()->transform(function ($value) use ($request, $authUserBlockList, $otherUserBlockList) {
                // Your code here
                if ($request->type == "seller") {
                    $userBlocked = $authUserBlockList->contains($value->buyer_id) || $otherUserBlockList->contains($value->seller_id);
                } elseif ($request->type == "buyer") {
                    $userBlocked = $authUserBlockList->contains($value->seller_id) || $otherUserBlockList->contains($value->buyer_id);
                }
                $value->item->is_purchased = 0;
                if ($value->item->sold_to == Auth::user()->id) {
                    $value->item->is_purchased = 1;
                }
                $tempReview = $value->item->review;

                unset($value->item->review);
                $value->item->review = $tempReview[0] ?? null;
                $value->user_blocked = $userBlocked ?? false;
                return $value;
            });

            $itemOffer->getCollection()->transform(function ($offer) {
               $offer['last_message_time'] = $offer->chat->isNotEmpty() ? $offer->chat->first()->updated_at : null;
               return $offer;
           });

            ResponseService::successResponse(__('Chat List Fetched Successfully'), $itemOffer,['total_unread_chat_count' => $totalUnreadChatCount]);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> getChatList");
            ResponseService::errorResponse();
        }
    }

    // public function sendMessage(Request $request) {
    //     $validator = Validator::make($request->all(), [
    //         'item_offer_id' => 'required|integer',
    //         'message'       => (!$request->file('file') && !$request->file('audio')) ? "required" : "nullable",
    //         'file'          => 'nullable|mimes:jpg,jpeg,png|max:7168',
    //         'audio'         => 'nullable|mimetypes:audio/mpeg,video/webm,audio/ogg,video/mp4,audio/x-wav,text/plain|max:7168',
    //     ]);
    //     if ($validator->fails()) {
    //         ResponseService::validationError($validator->errors()->first());
    //     }
    //     try {
    //         DB::beginTransaction();
    //         $user = Auth::user();
    //         //List of users that Auth user has blocked
    //         $authUserBlockList = BlockUser::where('user_id', $user->id)->get();

    //         //List of Other users that have blocked the Auth user
    //         $otherUserBlockList = BlockUser::where('blocked_user_id', $user->id)->get();

    //         $itemOffer = ItemOffer::with('item')->findOrFail($request->item_offer_id);
    //         if ($itemOffer->seller_id == $user->id) {
    //             //If Auth user is seller then check if buyer has blocked the user
    //             $blockStatus = $authUserBlockList->filter(function ($data) use ($itemOffer) {
    //                 return $data->user_id == $itemOffer->seller_id && $data->blocked_user_id == $itemOffer->buyer_id;
    //             });
    //             if (count($blockStatus) !== 0) {
    //                 ResponseService::errorResponse(__('You Cannot send message because You have blocked this user'));
    //             }

    //             $blockStatus = $otherUserBlockList->filter(function ($data) use ($itemOffer) {
    //                 return $data->user_id == $itemOffer->buyer_id && $data->blocked_user_id == $itemOffer->seller_id;
    //             });
    //             if (count($blockStatus) !== 0) {
    //                 ResponseService::errorResponse(__('You Cannot send message because other user has blocked you.'));
    //             }
    //         } else {
    //             //If Auth user is seller then check if buyer has blocked the user
    //             $blockStatus = $authUserBlockList->filter(function ($data) use ($itemOffer) {
    //                 return $data->user_id == $itemOffer->buyer_id && $data->blocked_user_id == $itemOffer->seller_id;
    //             });
    //             if (count($blockStatus) !== 0) {
    //                 ResponseService::errorResponse(__('You Cannot send message because You have blocked this user'));
    //             }

    //             $blockStatus = $otherUserBlockList->filter(function ($data) use ($itemOffer) {
    //                 return $data->user_id == $itemOffer->seller_id && $data->blocked_user_id == $itemOffer->buyer_id;
    //             });
    //             if (count($blockStatus) !== 0) {
    //                 ResponseService::errorResponse(__('You Cannot send message because other user has blocked you.'));
    //             }
    //         }
    //         $chat = Chat::create([
    //             'sender_id'     => Auth::user()->id,
    //             'item_offer_id' => $request->item_offer_id,
    //             'message'       => $request->message,
    //             'file'          => $request->hasFile('file') ? FileService::compressAndUpload($request->file('file'), 'chat') : '',
    //             'audio'         => $request->hasFile('audio') ? FileService::compressAndUpload($request->file('audio'), 'chat') : '',
    //             'is_read'       => 0
    //         ]);

    //         if ($itemOffer->seller_id == $user->id) {
    //             $receiver_id = $itemOffer->buyer_id;
    //             $userType = "Seller";
    //         } else {
    //             $receiver_id = $itemOffer->seller_id;
    //             $userType = "Buyer";
    //         }
    //         $notificationPayload = $chat->toArray();

    //         $unreadMessagesCount = Chat::where('item_offer_id', $itemOffer->id)
    //         ->where('is_read', 0)
    //         ->count();

    //         $fcmMsg = [
    //             ...$notificationPayload,
    //             'user_id'           => $user->id,
    //             'user_name'         => $user->name,
    //             'user_profile'      => $user->profile,
    //             'user_type'         => $userType,
    //             'item_id'           => $itemOffer->item->id,
    //             'item_name'         => $itemOffer->item->name,
    //             'item_image'        => $itemOffer->item->image,
    //             'item_price'        => $itemOffer->item->price,
    //             'item_offer_id'     => $itemOffer->id,
    //             'item_offer_amount' => $itemOffer->amount,
    //             'type'              => $notificationPayload['message_type'],
    //             'message_type_temp' => $notificationPayload['message_type'],
    //             'unread_count'      => $unreadMessagesCount
    //         ];
    //         /* message_type is reserved keyword in FCM so removed here*/
    //         unset($fcmMsg['message_type']);
    //         $receiverFCMTokens = UserFcmToken::where('user_id', $receiver_id)->pluck('fcm_token')->toArray();
    //         $notification = NotificationService::
//sendFcmNotification($receiverFCMTokens, 'Message', $request->message, "chat", $fcmMsg);

    //         DB::commit();
    //         ResponseService::successResponse(__('Message Fetched Successfully'), $chat, ['debug' => $notification]);
    //     } catch (Throwable $th) {
    //         DB::rollBack();
    //         ResponseService::logErrorResponse($th, "API Controller -> sendMessage");
    //         ResponseService::errorResponse();
    //     }
    // }



    public function sendMessage(Request $request) {
        \Log::info("sendMessage called with data: " . json_encode($request->all()));
        $validator = Validator::make($request->all(), [
            'item_offer_id' => 'required|integer',
            // 'sender_id' => 'required|integer|exists:users,id',
            'message'       => (!$request->file('file') && !$request->file('audio')) ? "required" : "nullable",
            'file'          => 'nullable|mimes:jpg,jpeg,png|max:7168',
            'audio'         => 'nullable|mimetypes:audio/mpeg,video/webm,audio/ogg,video/mp4,audio/x-wav,text/plain|max:7168',
        ]);
        if ($validator->fails()) {
            return ResponseService::validationError($validator->errors()->first());
        }

//         // $user = User::find($request->sender_id);

//        
//        $user = Auth::user();
//       if (!$user) {
//     return ResponseService::unauthorizedResponse();
// }

//         \Log::info("User found: " . $user->id . " - " . $user->name);
        
        try {
            DB::beginTransaction();
            $user = Auth::user();
        //    $user = User::find($request->sender_id);
            //List of users that Auth user has blocked
            $authUserBlockList = BlockUser::where('user_id', $user->id)->get();

            //List of Other users that have blocked the Auth user
            $otherUserBlockList = BlockUser::where('blocked_user_id', $user->id)->get();

            $itemOffer = ItemOffer::with('item')->findOrFail($request->item_offer_id);
            if ($itemOffer->seller_id == $user->id) {
                //If Auth user is seller then check if buyer has blocked the user
                $blockStatus = $authUserBlockList->filter(function ($data) use ($itemOffer) {
                    return $data->user_id == $itemOffer->seller_id && $data->blocked_user_id == $itemOffer->buyer_id;
                });
                if (count($blockStatus) !== 0) {
                  return ResponseService::errorResponse(__('You Cannot send message because You have blocked this user'));
                }

                $blockStatus = $otherUserBlockList->filter(function ($data) use ($itemOffer) {
                    return $data->user_id == $itemOffer->buyer_id && $data->blocked_user_id == $itemOffer->seller_id;
                });
                if (count($blockStatus) !== 0) {
                  return   ResponseService::errorResponse(__('You Cannot send message because other user has blocked you.'));
                }
            } else {
                //If Auth user is buyer then check if seller has blocked the user
                $blockStatus = $authUserBlockList->filter(function ($data) use ($itemOffer) {
                    return $data->user_id == $itemOffer->buyer_id && $data->blocked_user_id == $itemOffer->seller_id;
                });
                if (count($blockStatus) !== 0) {
                  return  ResponseService::errorResponse(__('You Cannot send message because You have blocked this user'));
                }
     

                $blockStatus = $otherUserBlockList->filter(function ($data) use ($itemOffer) {
                    return $data->user_id == $itemOffer->seller_id && $data->blocked_user_id == $itemOffer->buyer_id;
                });
                if (count($blockStatus) !== 0) {
                 return  ResponseService::errorResponse(__('You Cannot send message because other user has blocked you.'));
                }
            }
            $chat = Chat::create([
                'sender_id'     => Auth::user()->id,
                // 'sender_id'     =>  $user->id,
                'item_offer_id' => $request->item_offer_id,
                'message'       => $request->message,
                'file'          => $request->hasFile('file') ? FileService::compressAndUpload($request->file('file'), 'chat') : '',
                'audio'         => $request->hasFile('audio') ? FileService::compressAndUpload($request->file('audio'), 'chat') : '',
                'is_read'       => 0
            ]); 
        
         event(new MessageSent($chat)); 
// \Log::info("Broadcast event fired for chat ID: " . $chat->id);
// \Log::info("Broadcast event fired for chat ID: " . $chat->id);
// \Log::info("Event should broadcast to: private-chat." . $request->item_offer_id);
            if ($itemOffer->seller_id == $user->id) {
                $receiver_id = $itemOffer->buyer_id;
                $userType = "Seller";
            } else {
                $receiver_id = $itemOffer->seller_id;
                $userType = "Buyer";
            }
            $notificationPayload = $chat->toArray();

            $unreadMessagesCount = Chat::where('item_offer_id', $itemOffer->id)
            ->where('is_read', 0)
            ->count();

            $fcmMsg = [
                ...$notificationPayload,
                'user_id'           => $user->id,
                'user_name'         => $user->name,
                'user_profile'      => $user->profile,
                'user_type'         => $userType,
                'item_id'           => $itemOffer->item->id,
                'item_name'         => $itemOffer->item->name,
                'item_image'        => $itemOffer->item->image,
                'item_price'        => $itemOffer->item->price,
                'item_offer_id'     => $itemOffer->id,
                'item_offer_amount' => $itemOffer->amount,
                'type'              => $notificationPayload['message_type'],
                'message_type_temp' => $notificationPayload['message_type'],
                'unread_count'      => $unreadMessagesCount
            ];
            /* message_type is reserved keyword in FCM so removed here*/
            unset($fcmMsg['message_type']);
            $receiverFCMTokens = UserFcmToken::where('user_id', $receiver_id)->pluck('fcm_token')->toArray();
        //    $notificationBody = $request->message;

          // if (!$notificationBody) {
           //if ($request->hasFile('audio')) {
           // $notificationBody = __('ðŸŽµ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©');
           //} elseif ($request->hasFile('file')) {
            //$notificationBody = __('ðŸ“Ž Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯');
         //  } else {
           // $notificationBody = __('Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©');
            //}
            //} else {
             // ÙÙŠ Ø­Ø§Ù„Ø© Ø¹Ù†Ø¯Ù†Ø§ Ù†Øµ + Ù…Ù„Ù
         //  if ($request->hasFile('file') && $request->hasFile('audio')) {
           // $notificationBody = "ðŸ“ŽðŸŽµ " . $request->message;
            //} elseif ($request->hasFile('file')) {
            //$notificationBody = "  ðŸ“Ž " . $request->message;
           // } elseif ($request->hasFile('audio')) {
           // $notificationBody = "ðŸŽµ " . $request->message;
            // }
             //}
           // $notification = NotificationService::sendFcmNotification($receiverFCMTokens, 'Message', $notificationBody, "chat", $fcmMsg);

           // DB::commit();
           // return ResponseService::successResponse(__('Message Fetched Successfully'), $chat, ['debug' => $notification]);
       
/* message_type is reserved keyword in FCM so removed here */
unset($fcmMsg['message_type']);

$receiverFCMTokens = UserFcmToken::where('user_id', $receiver_id)->pluck('fcm_token')->toArray();

// Ø¨Ù†Ø§Ø¡ Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø­Ø³Ø¨ ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ù„ÙØ§Øª Ø£Ùˆ Ø§Ù„Ù†Øµ
$notificationBody = $request->message;

if (!$notificationBody) {
    if ($request->hasFile('audio')) {
        $notificationBody = [
            'en' => 'ðŸŽµ New voice message',
            'ar' => 'ðŸŽµ Ø±Ø³Ø§Ù„Ø© ØµÙˆØªÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©'
        ];
    } elseif ($request->hasFile('file')) {
        $notificationBody = [
            'en' => 'ðŸ“Ž New file',
            'ar' => 'ðŸ“Ž Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯'
        ];
    } else {
        $notificationBody = [
            'en' => 'New message',
            'ar' => 'Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø©'
        ];
    }
} else {
    // ÙÙŠ Ø­Ø§Ù„Ø© ÙˆØ¬ÙˆØ¯ Ù†Øµ + Ù…Ù„Ù
    if ($request->hasFile('file') && $request->hasFile('audio')) {
        $notificationBody = [
            'en' => "ðŸ“ŽðŸŽµ " . $request->message,
            'ar' => "ðŸ“ŽðŸŽµ " . $request->message
        ];
    } elseif ($request->hasFile('file')) {
        $notificationBody = [
            'en' => "ðŸ“Ž " . $request->message,
            'ar' => "ðŸ“Ž " . $request->message
        ];
    } elseif ($request->hasFile('audio')) {
        $notificationBody = [
            'en' => "ðŸŽµ " . $request->message,
            'ar' => "ðŸŽµ " . $request->message
        ];
    } else {
        $notificationBody = [
            'en' => $request->message,
            'ar' => $request->message // ÙŠÙ…ÙƒÙ†Ùƒ ØªØ±Ø¬Ù…Ø© Ø§Ù„Ù†Øµ Ù‡Ù†Ø§ Ø¥Ù† Ø£Ø±Ø¯Øª
        ];
    }
}

$notification = NotificationService::sendFcmNotification(
    $receiverFCMTokens,
    ['en' => 'Message', 'ar' => 'Ø±Ø³Ø§Ù„Ø©'], // Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù„ØºØ§Øª
    $notificationBody, // Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…ØªØ¹Ø¯Ø¯Ø© Ø§Ù„Ù„ØºØ§Øª
    "chat",
    $fcmMsg
);

DB::commit();
return ResponseService::successResponse(__('Message Fetched Successfully'), $chat, ['debug' => $notification]);


 } catch (Throwable $th) {
            DB::rollBack();
            ResponseService::logErrorResponse($th, "API Controller -> sendMessage");
            ResponseService::errorResponse();
        }
    }


    public function getChatMessages(Request $request) {
        $validator = Validator::make($request->all(), [
            'item_offer_id' => 'required',
        ]);
        if ($validator->fails()) {
            ResponseService::validationError($validator->errors()->first());
        }
        try {
            $itemOffer = ItemOffer::owner()->findOrFail($request->item_offer_id);
            $chat = Chat::where('item_offer_id', $itemOffer->id)->orderBy('created_at', 'DESC')->paginate();
            $authUserId = auth::user()->id;
            Chat::where('item_offer_id', $itemOffer->id)
                ->where('sender_id', '!=', $authUserId)
                ->whereIn('id', $chat->pluck('id'))
                ->update(['is_read' => '1']);
            ResponseService::successResponse(__('Messages Fetched Successfully'), $chat);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> getChatMessages");
            ResponseService::errorResponse();
        }
    }


public function deleteUser(Request $request) {
    try {
        $user = User::findOrFail(Auth::user()->id);

        // ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨
        $user->is_verified = 0;      // Ø§Ù„Ø­Ø³Ø§Ø¨ ØºÙŠØ± Ù…ÙØ¹Ù„ / Ù…Ø¹Ø·Ù„
        $user->deleted_at = now();   // ØªØ³Ø¬ÙŠÙ„ ÙˆÙ‚Øª Ø§Ù„ØªØ¹Ø·ÙŠÙ„
        $user->save();

        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
        DB::table('items')
            ->where('user_id', $user->id)
            ->update(['status' => 'soft rejected']); // ØªØ¨Ù‚Ù‰ Ù…Ø±Ø¦ÙŠØ© ÙÙŠ Admin Panel

        // ØªÙˆÙ„ÙŠØ¯ OTP
        $otp = rand(100000, 999999);
        cache()->put('otp_user_' . $user->id, $otp, now()->addMinutes(10));
        // Mail::to($user->email)->send(new OtpMail($otp)); // Ø¥Ø±Ø³Ø§Ù„ OTP Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª

        ResponseService::successResponse(
            'User Deactivated Successfully. OTP sent for reactivation.',
            ['otp_sent' => true]
        );

    } catch (Throwable $th) {
        ResponseService::logErrorResponse($th, "API Controller -> deleteUser");
        ResponseService::errorResponse();
    }
}


    public function inAppPurchase(Request $request) {
        $validator = Validator::make($request->all(), [
            'purchase_token' => 'required',
            'payment_method' => 'required|in:google,apple',
            'package_id'     => 'required|integer'
        ]);

        if ($validator->fails()) {
            ResponseService::validationError($validator->errors()->first());
        }

        try {
            $package = Package::findOrFail($request->package_id);
            $purchasedPackage = UserPurchasedPackage::where(['user_id' => Auth::user()->id, 'package_id' => $request->package_id])->first();
            if (!empty($purchasedPackage)) {
                ResponseService::errorResponse(__('You already have purchased this package'));
            }

            PaymentTransaction::create([
                'user_id'         => Auth::user()->id,
                'amount'          => $package->final_price,
                'payment_gateway' => $request->payment_method,
                'order_id'        => $request->purchase_token,
                'payment_status'  => 'success',
            ]);

            UserPurchasedPackage::create([
                'user_id'     => Auth::user()->id,
                'package_id'  => $request->package_id,
                'start_date'  => Carbon::now(),
                'total_limit' => $package->item_limit == "unlimited" ? null : $package->item_limit,
                'end_date'    => $package->duration == "unlimited" ? null : Carbon::now()->addDays($package->duration)
            ]);
            ResponseService::successResponse(__('Package Purchased Successfully'));
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> inAppPurchase");
            ResponseService::errorResponse();
        }
    }

    public function blockUser(Request $request) {
        $validator = Validator::make($request->all(), [
            'blocked_user_id' => 'required|integer',
        ]);
        if ($validator->fails()) {
            ResponseService::validationError($validator->errors()->first());
        }
        try {
            BlockUser::create([
                'user_id'         => Auth::user()->id,
                'blocked_user_id' => $request->blocked_user_id,
            ]);
            ResponseService::successResponse(__('User Blocked Successfully'));
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> blockUser");
            ResponseService::errorResponse();
        }
    }

    public function unblockUser(Request $request) {
        $validator = Validator::make($request->all(), [
            'blocked_user_id' => 'required|integer',
        ]);
        if ($validator->fails()) {
            ResponseService::validationError($validator->errors()->first());
        }
        try {
            BlockUser::where([
                'user_id'         => Auth::user()->id,
                'blocked_user_id' => $request->blocked_user_id,
            ])->delete();
            ResponseService::successResponse(__('User Unblocked Successfully'));
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> unblockUser");
            ResponseService::errorResponse();
        }
    }

    public function getBlockedUsers() {
        try {
            $blockedUsers = BlockUser::where('user_id', Auth::user()->id)->pluck('blocked_user_id');
            $users = User::whereIn('id', $blockedUsers)->select(['id', 'name', 'profile'])->get();
            ResponseService::successResponse(__('User Unblocked Successfully'), $users);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> unblockUser");
            ResponseService::errorResponse();
        }
    }

    public function getTips() {
        try {
            $tips = Tip::select(['id', 'description'])->orderBy('sequence', 'ASC')->with('translations')->get();
            ResponseService::successResponse(__('Tips Fetched Successfully'), $tips);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> getTips");
            ResponseService::errorResponse();
        }
    }

    public function getBlog(Request $request) {
        try {
            $validator = Validator::make($request->all(), [
                'category_id' => 'nullable|integer|exists:categories,id',
                'blog_id'     => 'nullable|integer|exists:blogs,id',
                'sort_by'     => 'nullable|in:new-to-old,old-to-new,popular',
            ]);

            if ($validator->fails()) {
                ResponseService::validationError($validator->errors()->first());
            }
            $blogs = Blog::when(!empty($request->id), static function ($q) use ($request) {
                $q->where('id', $request->id);
                Blog::where('id', $request->id)->increment('views');
            })
                ->when(!empty($request->slug), function ($q) use ($request) {
                    $q->where('slug', $request->slug);
                    Blog::where('slug', $request->slug)->increment('views');
                })
                ->when(!empty($request->sort_by), function ($q) use ($request) {
                    if ($request->sort_by === 'new-to-old') {
                        $q->orderByDesc('created_at');
                    } elseif ($request->sort_by === 'old-to-new') {
                        $q->orderBy('created_at');
                    } else if ($request->sort_by === 'popular') {
                        $q->orderByDesc('views');
                    }
                })
                ->when(!empty($request->tag), function ($q) use ($request) {
                    $q->where('tags', 'like', "%" . $request->tag . "%");
                })->paginate();

            $otherBlogs = [];
            if (!empty($request->id) || !empty($request->slug)) {
                $otherBlogs = Blog::orderByDesc('id')->limit(3)->get();
            }
            // Return success response with the fetched blogs
            ResponseService::successResponse(__('Blogs fetched successfully'), $blogs, ['other_blogs' => $otherBlogs]);
        } catch (Throwable $th) {
            // Log and handle exceptions
            ResponseService::logErrorResponse($th, 'API Controller -> getBlog');
            ResponseService::errorResponse(__('Failed to fetch blogs'));
        }
    }

   public function getCountries(Request $request)
{
    try {
    $searchQuery = $request->search ?? '';
    
    // âœ… Ø§Ø³ØªØ®Ø¯Ù… app()->getLocale() Ø¨Ø¹Ø¯ Ù…Ø§ Ø§Ù„Ù€ middleware Ø¶Ø¨Ø·Ù‡Ø§
    $lang = app()->getLocale();

    $orderBy = $lang === 'ar'
        ? \DB::raw('COALESCE(name_ar, name_en)')
        : 'name_en';
    
    $countries = Country::withCount('states')
        ->when($searchQuery, function ($q) use ($searchQuery) {
            $q->search($searchQuery);
        })
        ->orderBy($orderBy, 'ASC')
        ->paginate();

    return ResponseService::successResponse(__('Countries Fetched Successfully'), $countries);
    
} catch (Throwable $th) {
    ResponseService::logErrorResponse($th, "API Controller -> getCountries");
    return ResponseService::errorResponse(__('Failed to fetch countries'));
}
}


    public function getStates(Request $request) {
    $validator = Validator::make($request->all(), [
        'country_id' => 'nullable|integer',
        'search'     => 'nullable|string',
        'per_page'   => 'nullable|integer',
        'page'       => 'nullable|integer',
    ]);

    if ($validator->fails()) {
        return ResponseService::validationError($validator->errors()->first());
    }

    try {
        $searchQuery = $request->search ?? '';
        $countryId = $request->country_id ?? null;
        $perPage = $request->per_page ?? 15;

        // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù„ØºØ© Ø§Ù„ØªÙŠ Ø¶Ø¨Ø·Ù‡Ø§ Ø§Ù„Ù€ middleware (app()->getLocale())
        $lang = app()->getLocale() ?? 'en';

        // ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©: Ø¥Ø°Ø§ Ø¹Ø±Ø¨ÙŠ Ù†Ø±ØªØ¨ Ø¹Ù„Ù‰ COALESCE(name_ar,name_en,name)
        $orderBy = $lang === 'ar'
            ? \DB::raw('COALESCE(states.name_ar, states.name_en, states.name)')
            : \DB::raw('COALESCE(states.name_en, states.name)');

        $statesQuery = State::withCount('cities')
            ->when($searchQuery, function ($q) use ($searchQuery) {
                $q->search($searchQuery);
            });

        if ($countryId) {
            $statesQuery->where('country_id', $countryId);
        }

        // Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù‡Ù†Ø§Ùƒ Ø­Ø§Ø¬Ø© Ù„Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ø³Ù… Ø§Ù„Ø¨Ù„Ø¯ (Ù…Ø«Ø§Ù„: ?sort=country_name)
        // ÙŠÙ…ÙƒÙ†Ùƒ Ù‚Ø±Ø§Ø¡Ø© Ù…ØªØºÙŠØ±Ø§Øª sortColumn Ùˆ sortOrder Ù…Ù† request Ø¥Ø°Ø§ ØªØ·Ù„Ø¨ Ø§Ù„Ø£Ù…Ø± - Ù‡Ù†Ø§ Ù†Ø£Ø®Ø° Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ name
        $states = $statesQuery
            ->orderBy($orderBy, 'ASC')
            ->paginate($perPage);

        // ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¯Ø§Ø®Ù„ paginator Ù„ØªØ¶Ù…Ù† Ø£Ù† Ø§Ù„Ø­Ù‚Ù„ 'name' ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ
        if ($lang === 'ar') {
            $states->setCollection(
                $states->getCollection()->transform(function ($state) {
                    if (!empty($state->name_ar)) {
                        // Ù†Ø¶Ø¨Ø· Ø§Ù„Ø®Ø§ØµÙŠØ© name Ù„Ù„Ø¹Ø±Ø¶ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
                        $state->name = $state->name_ar;
                    } else {
                        $state->name = $state->name_en ?? $state->name;
                    }
                    return $state;
                })
            );
        } else {
            // Ø¥Ù† Ø£Ø±Ø¯Øª Ø¶Ø¨Ø· ØµØ±ÙŠØ­ Ù„Ù„Ù€ English fallback
            $states->setCollection(
                $states->getCollection()->transform(function ($state) {
                    $state->name = $state->name_en ?? $state->name;
                    return $state;
                })
            );
        }

        return ResponseService::successResponse(__('States Fetched Successfully'), $states);
    } catch (Throwable $th) {
        ResponseService::logErrorResponse($th, "API Controller->getStates");
        return ResponseService::errorResponse(__('Failed to fetch states'));
    }
}


    //public function getCities(Request $request)
//{
    //try {
        //$validator = Validator::make($request->all(), [
            //'state_id' => 'nullable|integer',
            //'search'   => 'nullable|string',
            //'per_page' => 'nullable|integer',
            //'page'     => 'nullable|integer',
        //]);

        //if ($validator->fails()) {
            //return ResponseService::validationError($validator->errors()->first());
        //}

        //$searchQuery = trim($request->search ?? '');
        //$stateId = $request->state_id ?? null;
        //$perPage = $request->per_page ?? 15;

        // âœ… Ø§Ù„Ù„ØºØ© ØªÙ… Ø¶Ø¨Ø·Ù‡Ø§ Ù…Ø³Ø¨Ù‚Ù‹Ø§ Ø¹Ø¨Ø± Ø§Ù„Ù€ middleware
        //$lang = app()->getLocale() ?? 'en';

        // âœ… ØªØ±ØªÙŠØ¨ Ù…Ø­Ù„ÙŠ Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©
        //$orderBy = $lang === 'ar'
            //? \DB::raw('COALESCE(cities.name_ar, cities.name_en, cities.name)')
            //: \DB::raw('COALESCE(cities.name_en, cities.name)');

        //\Log::info('CITIES DEBUG STEP 1', ['lang' => $lang, 'search' => $searchQuery]);
         // âœ… Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…ØªØ¹Ø¯Ø¯ Ø§Ù„Ù„ØºØ§Øª
        //$citiesQuery = City::withCount('areas')
            //->when($searchQuery, function ($q) use ($searchQuery, $lang) {
                //$q->where(function ($query) use ($searchQuery, $lang) {
                    // Ù†Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù…ÙŠÙ† Ù…Ø¹Ù‹Ø§ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„ØªØ·Ø§Ø¨Ù‚ ÙÙŠ Ø£ÙŠ Ù„ØºØ©
                    //$query->where('cities.name', 'LIKE', "%{$searchQuery}%")
                          //->orWhere('cities.name_en', 'LIKE', "%{$searchQuery}%")
                          //->orWhere('cities.name_ar', 'LIKE', "%{$searchQuery}%");

                    // Ù†Ø¶ÙŠÙ Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø£ÙŠØ¶Ù‹Ø§
                    //$query->orWhereHas('state', function ($sub) use ($searchQuery) {
                        //$sub->where('states.name', 'LIKE', "%{$searchQuery}%")
                            //->orWhere('states.name_en', 'LIKE', "%{$searchQuery}%")
                            //->orWhere('states.name_ar', 'LIKE', "%{$searchQuery}%");
                    //});
                    //$query->orWhereHas('country', function ($sub) use ($searchQuery) {
                        //$sub->where('countries.name', 'LIKE', "%{$searchQuery}%")
                            //->orWhere('countries.name_en', 'LIKE', "%{$searchQuery}%")
                            //->orWhere('countries.name_ar', 'LIKE', "%{$searchQuery}%");
                    //});
                //});
            //});

        //if ($stateId) {
            //$citiesQuery->where('state_id', $stateId);
        //}

        //$cities = $citiesQuery
            //->orderBy($orderBy, 'ASC')
            //->paginate($perPage);
//if ($cities->count() > 0) {
    //\Log::info('CITIES DEBUG STEP 2', [
        //'first_city' => [
            //'id' => $cities->first()->id,
            //'name' => $cities->first()->name,
            //'name_en' => $cities->first()->name_en ?? null,
            //'name_ar' => $cities->first()->name_ar ?? null,
        //]
    //]);
//}

        // âœ… Ù†Ø¨Ø¯Ù‘Ù„ Ø§Ù„Ø§Ø³Ù… Ø¨Ø­Ø³Ø¨ Ø§Ù„Ù„ØºØ©
        //$cities->setCollection(
            //$cities->getCollection()->transform(function ($city) use ($lang) {
                //if ($lang === 'ar') {
              //$city->name = $city->name_ar ?: ($city->name_en ?? $city->name);
                //} else {
                   // $city->name = $city->name_en ?? $city->name;
               // }

                // âœ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠØ© ÙŠØ¯ÙˆÙŠÙ‹Ø§ (A)
                //if (method_exists($city, 'makeHidden')) {
                 //   $city->makeHidden(['name_en', 'name_ar']);
                //}
         //\Log::info('CITIES DEBUG STEP 3', [
    //'lang' => $lang,
    //'city_id' => $city->id,
    //'final_name' => $city->name,
//]);

                //return $city;
            //})
        //);

        //return ResponseService::successResponse(__('Cities Fetched Successfully'), $cities);
    //} catch (Throwable $th) {
       // ResponseService::logErrorResponse($th, "API Controller->getCities");
       // return ResponseService::errorResponse(__('Failed to fetch cities'));
    //}
//}

     public function getCities(Request $request) {
        try {
            $validator = Validator::make($request->all(), [
                'state_id' => 'nullable|integer',
                'search'   => 'nullable|string'
            ]);

            if ($validator->fails()) {
                ResponseService::validationError($validator->errors()->first());
            }
            $searchQuery = $request->search ?? '';
            $citiesQuery = City::withCount('areas')
                ->where('name', 'LIKE', "%{$searchQuery}%")
                ->orderBy('name', 'ASC');

            if (isset($request->state_id)) {
                $citiesQuery->where('state_id', $request->state_id);
            }

            $cities = $citiesQuery->paginate();

            ResponseService::successResponse(__('Cities Fetched Successfully'), $cities);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller->getCities");
            ResponseService::errorResponse(__('Failed to fetch cities'));
        }
    }

    public function getAreas(Request $request) {
        $validator = Validator::make($request->all(), [
            'city_id' => 'nullable|integer',
            'search'  => 'nullable'
        ]);

        if ($validator->fails()) {
            ResponseService::validationError($validator->errors()->first());
        }
        try {
            $searchQuery = $request->search ?? '';
            $data = Area::search($searchQuery)->orderBy('name', 'ASC');
            if (isset($request->city_id)) {
                $data->where('city_id', $request->city_id);
            }

            $data = $data->paginate();
            ResponseService::successResponse(__('Area fetched Successfully'), $data);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, 'API Controller -> getAreas');
            ResponseService::errorResponse();
        }
    }

public function getFaqs(Request $request) {
    try {
        // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        $locale = $request->input('locale')       // Ù…Ù† body
                  ?? $request->query('locale')   // Ù…Ù† query string
                  ?? $request->header('Content-Language') // Ù…Ù† header
                  ?? 'EN'; // Ø§ÙØªØ±Ø§Ø¶ÙŠ

        // Ø¬Ù„Ø¨ Ø§Ù„Ù€ FAQs Ù…Ø¹ Ø§Ù„ØªØ±Ø¬Ù…Ø§Øª (Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯Ø©)
        $faqs = Faq::with(['translations' => function($query) use ($locale) {
            $query->where('locale', strtoupper($locale));
        }])->get()->map(function($faq) use ($locale) {
            // Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯ ØªØ±Ø¬Ù…Ø©ØŒ Ø§Ø³ØªØ®Ø¯Ù…Ù‡Ø§ØŒ ÙˆØ¥Ù„Ø§ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ
            $translation = $faq->translations->first();
            return [
                'id' => $faq->id,
                'question' => $translation->question ?? $faq->question,
                'answer' => $translation->answer ?? $faq->answer,
            ];
        });

        ResponseService::successResponse('Data Fetched successfully', $faqs);
    } catch (Throwable $th) {
        ResponseService::logErrorResponse($th, 'API Controller -> getFaqs');
        ResponseService::errorResponse('Failed to fetch Faqs');
    }
}



   public function getAllBlogTags() {
        try {
            $tagsArray = [];
            Blog::select('tags')->chunk(100, function ($blogs) use (&$tagsArray) {
                foreach ($blogs as $blog) {
                    foreach ($blog->tags as $tags) {
                        $tagsArray[] = $tags;
                    }
                }
            });
              $tagsArray = array_values(array_unique($tagsArray));
            ResponseService::successResponse("Blog Tags Successfully", $tagsArray);
        } catch (Throwable $th) {
            // Log and handle exceptions
            ResponseService::logErrorResponse($th, 'API Controller -> getAllBlogTags');
            ResponseService::errorResponse("Failed to fetch Tags");
        }
    }

public function storeContactUs(Request $request) {
        $validator = Validator::make($request->all(), [
            'name'    => 'required',
            'email'   => 'required|email',
            'subject' => 'required',
            'message' => 'required'
        ]);

        if ($validator->fails()) {
            ResponseService::validationError($validator->errors()->first());
        }
        try {
            ContactUs::create($request->all());
            ResponseService::successResponse("Contact Us Stored Successfully");

        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, 'API Controller -> storeContactUs');
            ResponseService::errorResponse();
        }
    }

    public function addItemReview(Request $request) {
        $validator = Validator::make($request->all(), [
            'review'  => 'nullable|string',
            'ratings' => 'required|numeric|between:0,5',
            'item_id' => 'required',
        ]);
        if ($validator->fails()) {
            ResponseService::validationError($validator->errors()->first());
        }
        try {
            $item = Item::with('user')->notOwner()->findOrFail($request->item_id);
            if ($item->sold_to !== Auth::id()) {
                ResponseService::errorResponse(__('You can only review items that you have purchased.'));
            }
            if ($item->status !== 'sold out') {
                ResponseService::errorResponse(__("The item must be marked as 'sold out' before you can review it."));
            }
            $existingReview = SellerRating::where('item_id', $request->item_id)->where('buyer_id', Auth::id())->first();
            if ($existingReview) {
                ResponseService::errorResponse(__('You have already reviewed this item.'));
            }
            $review = SellerRating::create([
                'item_id'   => $request->item_id,
                'buyer_id'  => Auth::user()->id,
                'seller_id' => $item->user_id,
                'ratings'   => $request->ratings,
                'review'    => $request->review ?? '',
            ]);

            ResponseService::successResponse(__('Your review has been submitted successfully.'), $review);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, 'API Controller -> storeContactUs');
            ResponseService::errorResponse();
        }
    }

    public function getSeller(Request $request) {
        $request->validate([
            'id' => 'required|integer'
        ]);

        try {
            // Fetch seller by ID
            $seller = User::findOrFail($request->id);

            // Fetch seller ratings
            $ratings = SellerRating::where('seller_id', $seller->id)->with('buyer:id,name,profile')->paginate(10);
            $averageRating = $ratings->avg('ratings');

            // Response structure
            $response = [
                'seller'  => [
                    ...$seller->toArray(),
                    'average_rating' => $averageRating,
                ],
                'ratings' => $ratings,
            ];

            // Send success response
            ResponseService::successResponse(__('Seller Details Fetched Successfully'), $response);

        } catch (Throwable $th) {
            // Log and handle error response
            ResponseService::logErrorResponse($th, "API Controller -> getSeller");
            ResponseService::errorResponse();
        }
    }


 public function renewItem(Request $request) {
        try {
            $validator = Validator::make($request->all(), [
                'item_id'    => 'required|exists:items,id',
                'package_id' => 'required|exists:packages,id',
            ]);

            if ($validator->fails()) {
                ResponseService::validationError($validator->errors()->first());
            }

            $user = Auth::user();
            $item = Item::findOrFail($request->item_id);
            $rawStatus = $item->getAttributes()['status'];
            $package = Package::where('id', $request->package_id)->firstOrFail();
            $userPackage = UserPurchasedPackage::onlyActive()->where([
                'user_id'    => $user->id,
                'package_id' => $package->id
            ])->first();

            if (!$userPackage) {
                ResponseService::errorResponse("You have not purchased this package");
            }

            $currentDate = Carbon::now();
            if (Carbon::parse($item->expiry_date)->gt($currentDate)) {
                ResponseService::errorResponse("Advertisement has not expired yet, so it cannot be renewed");
            }

            $expiryDays = (int)$package->duration;
            $newExpiryDate = $currentDate->copy()->addDays($expiryDays);
            if($package->duration == 'unlimited'){
                $item->expiry_date = null;
            }else{
                $item->expiry_date = $newExpiryDate;
            }
            $item->status = $rawStatus;
            $item->save();

            ++$userPackage->used_limit;
            $userPackage->save();
            ResponseService::successResponse("Advertisement renewed successfully", $item);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> renewItem");
            ResponseService::errorResponse();
        }
    }

    public function getMyReview(Request $request) {
        try {
            $ratings = SellerRating::where('seller_id', Auth::user()->id)->with('seller:id,name,profile', 'buyer:id,name,profile', 'item:id,name,price,image,description')->paginate(10);
            $averageRating = $ratings->avg('ratings');
            $response = [
                'average_rating' => $averageRating,
                'ratings'        => $ratings,
            ];

            ResponseService::successResponse(__('Seller Details Fetched Successfully'), $response);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> getSeller");
            ResponseService::errorResponse();
        }
    }

    public function addReviewReport(Request $request) {
        $validator = Validator::make($request->all(), [
            'report_reason'    => 'required|string',
            'seller_review_id' => 'required',
        ]);
        if ($validator->fails()) {
            ResponseService::validationError($validator->errors()->first());
        }
        try {
            $ratings = SellerRating::where('seller_id', Auth::user()->id)->findOrFail($request->seller_review_id);
            $ratings->update([
                'report_status' => 'reported',
                'report_reason' => $request->report_reason
            ]);

            ResponseService::successResponse(__('Your report has been submitted successfully.'), $ratings);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, 'API Controller -> addReviewReport');
            ResponseService::errorResponse();
        }
    }

public function getVerificationFields() {
    try {
        // Ø¬Ù„Ø¨ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
$fields = VerificationField::select('id', 'type', 'values', 'min_length','max_length','status', 'is_required','deleted_at')
            ->get()
            ->toArray();

        // Ø¥Ø¶Ø§ÙØ© Ø­Ù‚Ù„ name ÙØ§Ø±Øº Ù„ÙƒÙ„ Ø¹Ù†ØµØ± Ù„Ù„ÙØ±ÙˆÙ†Øª
        foreach ($fields as &$field) {
            $field['name'] = ''; // â† Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø³ ÙØ§Ø±Øº
        }

        // Ø¥Ø±Ø³Ø§Ù„ response
        return response()->json([
            'error' => false,
            'message' => __('Verification Field Fetched Successfully'),
            'data' => $fields,
            'code' => 200
        ]);

    } catch (Throwable $th) {
        DB::rollBack();
        ResponseService::logErrorResponse($th, "API Controller -> getVerificationFields");
        return response()->json([
            'error' => true,
            'message' => 'Something went wrong',
            'data' => [],
            'code' => 500
        ]);
    }
}
  public function sendVerificationRequest(Request $request) {
        try {

            $validator = Validator::make($request->all(), [
                'verification_field'         => 'sometimes|array',
                'verification_field.*'       => 'sometimes',
                'verification_field_files'   => 'nullable|array',
                'verification_field_files.*' => 'nullable|mimes:jpeg,png,jpg,pdf,doc|max:7168',
            ]);

            if ($validator->fails()) {
                ResponseService::validationError($validator->errors()->first());
            }
            DB::beginTransaction();

            $user = Auth::user();
            $verificationRequest = VerificationRequest::updateOrCreate([
                'user_id' => $user->id,
            ], ['status' => 'pending']);

            $user = auth()->user();
            if ($request->verification_field) {
                $itemCustomFieldValues = [];
                foreach ($request->verification_field as $id => $value) {
                    $itemCustomFieldValues[] = [
                        'user_id'                 => $user->id,
                        'verification_field_id'   => $id,
                        'verification_request_id' => $verificationRequest->id,
                        'value'                   => $value,
                        'created_at'              => now(),
                        'updated_at'              => now()
                    ];
                }
                if (count($itemCustomFieldValues) > 0) {
                    VerificationFieldValue::upsert($itemCustomFieldValues, ['user_id', 'verification_fields_id'], ['value', 'updated_at']);
                }
            }

            if ($request->verification_field_files) {
                $itemCustomFieldValues = [];
                foreach ($request->verification_field_files as $fieldId => $file) {
                    $itemCustomFieldValues[] = [
                        'user_id'                 => $user->id,
                        'verification_field_id'   => $fieldId,
                        'verification_request_id' => $verificationRequest->id,
                        'value'                   => !empty($file) ? FileService::upload($file, 'verification_field_files') : '',
                        'created_at'              => now(),
                        'updated_at'              => now()
                    ];
                }
                if (count($itemCustomFieldValues) > 0) {
                    VerificationFieldValue::upsert($itemCustomFieldValues, ['user_id', 'verification_field_id'], ['value', 'updated_at']);
                }
            }
            DB::commit();

            ResponseService::successResponse("Verification request submitted successfully.");
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> SendVerificationRequest");
            ResponseService::errorResponse();
        }
    }

 public function getVerificationRequest(Request $request) {
        try {
            $verificationRequest = VerificationRequest::with('verification_field_values')->owner()->first();

            if (empty($verificationRequest)) {
                ResponseService::errorResponse("No Request found");
            }
            $response = $verificationRequest->toArray();
            $response['verification_fields'] = [];

            foreach ($verificationRequest->verification_field_values as $key2 => $verificationFieldValue) {
                $tempRow = [];

                if ($verificationFieldValue->relationLoaded('verification_field')) {

                    if (!empty($verificationFieldValue->verification_field)) {

                        $tempRow = $verificationFieldValue->verification_field->toArray();

                        if ($verificationFieldValue->verification_field->type == "fileinput") {
                            if (!is_array($verificationFieldValue->value)) {
                                $tempRow['value'] = !empty($verificationFieldValue->value) ? [url(Storage::url($verificationFieldValue->value))] : [];
                            } else {
                                $tempRow['value'] = null;
                            }
                        } else {
                            $tempRow['value'] = $verificationFieldValue->value ?? [];
                        }

                        // $tempRow['verification_field_value'] = !empty($verificationFieldValue) ? $verificationFieldValue->toArray() : (object)[];
                        if (!empty($verificationFieldValue)) {
                            $tempRow['verification_field_value'] = $verificationFieldValue->toArray();

                            if ($verificationFieldValue->verification_field->type == "fileinput") {

                                $tempRow['verification_field_value'][]['value'] = !empty($verificationFieldValue->value) ? [url(Storage::url($verificationFieldValue->value))] : [];
                            } else {
                                $tempRow['verification_field_value']['value'] = $verificationFieldValue->value ?? [];
                            }
                        } else {
                            $tempRow['verification_field_value'] = (object)[];
                        }

                    }
                    unset($tempRow['verification_field_value']['verification_field']);
                    $response['verification_field'][] = $tempRow;

                }
            }
            ResponseService::successResponse("Verification request fetched successfully.", $response);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> SendVerificationRequest");
            ResponseService::errorResponse();
        }
    }
    public function seoSettings(Request $request) {
        try {
            $validator = Validator::make($request->all(), [
                'page' => 'nullable',
            ]);

            if ($validator->fails()) {
                ResponseService::validationError($validator->errors()->first());
            }
            $settings = new SeoSetting();
            if (!empty($request->page)) {
                $settings = $settings->where('page', $request->page);
            }

            $settings = $settings->get();
            ResponseService::successResponse(__('SEO settings fetched successfully.'), $settings);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> seoSettings");
            ResponseService::errorResponse();
        }
    }
    public function getCategories(Request $request) {
        $validator = Validator::make($request->all(), [
            'language_code' => 'nullable'
        ]);

        if ($validator->fails()) {
            ResponseService::validationError($validator->errors()->first());
        }
        try {
            $categories  = Category::all();
            $languageCode = $request->get('language_code', 'en');

            $translator = new GoogleTranslate($languageCode);
            $categoriesJson = $categories->toJson();
            $translatedJson = $translator->translate($categoriesJson);
            $translatedCategories = json_decode($translatedJson, true);

        return ResponseService::successResponse(null, $translatedCategories);
            ResponseService::successResponse(null, $sql);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, 'API Controller -> getCategories');
            ResponseService::errorResponse();
        }
    }
    public function bankTransferUpdate(Request $request) {
        try {
            $validator = Validator::make($request->all(), [
                'payment_transection_id' => 'required|integer',
                'payment_receipt' => 'required|file|mimes:jpg,jpeg,png|max:7048',
            ]);

            if ($validator->fails()) {
                return ResponseService::validationError($validator->errors()->first());
            }
            $transaction = PaymentTransaction::where('user_id', Auth::user()->id)->findOrFail($request->payment_transection_id);

            if (!$transaction) {
                return ResponseService::errorResponse(__('Transaction not found.'));
            }
            $receiptPath = !empty($request->file('payment_receipt'))
            ? FileService::upload($request->file('payment_receipt'),'bank-transfer')
            : '';
            $transaction->update([
                'payment_receipt' => $receiptPath,
                'payment_status' => 'under review',
            ]);

            return ResponseService::successResponse(__('Payment transaction updated successfully.'), $transaction);
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> bankTransferUpdate");
            return ResponseService::errorResponse();
        }
   }
///////////////////////////////////////////////////////////////////////////////////////////

public function getOtp(Request $request) {
    try {
        $validator = Validator::make($request->all(), [
            'number'        => 'required|string',
            'country_code'  => 'required|string', // Ø­Ù‚Ù„ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø±Ù…Ø²
            'name'          => 'nullable|string',
            'fcm_id'        => 'nullable|string',
            'platform_type' => 'nullable|in:android,ios'
        ]);

        if ($validator->fails()) {
            return ResponseService::validationError($validator->errors()->first());
        }

        $countryCode = $request->country_code;  // Ø±Ù…Ø² Ø§Ù„Ø¨Ù„Ø¯ Ù…Ù† Ø§Ù„ÙØ±Ø§Ù†Øª
        $localNumber = ltrim($request->number, '0'); // Ø¥Ø²Ø§Ù„Ø© ØµÙØ± Ø§Ù„Ø¨Ø¯Ø§ÙŠØ© Ø¥Ù† ÙˆØ¬Ø¯

        if (empty($localNumber)) {
            return ResponseService::errorResponse('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­');
        }

        DB::beginTransaction();

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯
        $user = User::firstOrCreate(
            ['mobile' => $localNumber],
            [
                'name'         => $request->input('name') ?? 'User'.rand(1000,9999),
                'is_verified'  => 0,
                'country_code' => $countryCode,
            ]
        );

        // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ± User Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯
        if (!$user->hasRole('User')) {
            $user->assignRole('User');
        }

        // ØªÙˆÙ„ÙŠØ¯ OTP Ø¬Ø¯ÙŠØ¯ ÙˆØªØ®Ø²ÙŠÙ†Ù‡
        $otp = str_pad(random_int(0, 999999), 6, '0', STR_PAD_LEFT);
        $user->otp = $otp;
        $user->otp_expires_at = now()->addMinutes(10);
        $user->save();

        // Ø¥Ø±Ø³Ø§Ù„ OTP Ø¹Ø¨Ø± WhatsApp
        $apiUrl = env('WHATSAPP_API_URL');
        $apiToken = env('WHATSAPP_API_TOKEN');

        $fullNumber = $countryCode . $localNumber; // Ø§Ù„Ø±Ù‚Ù… Ø§Ù„ÙƒØ§Ù…Ù„ Ù…Ø¹ ÙƒÙˆØ¯ Ø§Ù„Ø¨Ù„Ø¯

        $response = Http::withToken($apiToken)->post($apiUrl . '/send-otp', [
            'phone' => $fullNumber,
            'otp'   => $otp,
        ]);

        if (!$response->successful()) {
            \Log::error('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ OTP', [
                'status' => $response->status(),
                'body'   => $response->body(),
            ]);
            DB::rollBack();
            return ResponseService::errorResponse('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ OTP');
        }

        // Ø¥Ø¯Ø§Ø±Ø© FCM Token Ø¥Ø°Ø§ ÙˆØµÙ„
        if (!empty($request->fcm_id)) {
            UserFcmToken::updateOrCreate(
                ['fcm_token' => $request->fcm_id],
                [
                    'user_id'       => $user->id,
                    'platform_type' => $request->platform_type,
                    'created_at'    => now(),
                    'updated_at'    => now()
                ]
            );
        }

        DB::commit();
        return ResponseService::successResponse('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ', [
            'number'       => $user->mobile,
            'country_code' => $user->country_code
        ]);

    } catch (Throwable $th) {
        DB::rollBack();
        ResponseService::logErrorResponse($th, "OTP Controller -> getOtp");
        return ResponseService::errorResponse();
    }
}




public function getOtpnumber(Request $request) {
    try {
        $validator = Validator::make($request->all(), [
            'number'        => 'required|string',
            'name'          => 'nullable|string',
            'fcm_id'        => 'nullable|string',
            'platform_type' => 'nullable|in:android,ios'
        ]);

        if ($validator->fails()) {
            return ResponseService::validationError($validator->errors()->first());
        }

        // Ø¥Ø²Ø§Ù„Ø© Ø£ÙŠ + Ù…Ù† Ø§Ù„Ø±Ù‚Ù… Ù„ØªÙˆØ­ÙŠØ¯ Ø§Ù„ØµÙŠØºØ©
        $trimmedNumber = ltrim($request->number, '+');

        if (empty($trimmedNumber)) {
            return ResponseService::errorResponse('Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ØºÙŠØ± ØµØ­ÙŠØ­');
        }

        DB::beginTransaction();

        // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø¬Ø¯ÙŠØ¯
        $user = User::firstOrCreate(
            ['mobile' => $trimmedNumber], // Ø¨Ø¯ÙˆÙ† +
            [
                'name' => $request->input('name') ?? 'User'.rand(1000,9999),
                'is_verified' => 0
            ]
        );

        // âœ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯ÙˆØ± User Ø­ØªÙ‰ ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø£Ø¯Ù…Ù† Ø¨Ø§Ù†Ù„
        if (!$user->hasRole('User')) {
            $user->assignRole('User');
        }

        // ØªÙˆÙ„ÙŠØ¯ OTP Ø¬Ø¯ÙŠØ¯ ÙˆØªØ®Ø²ÙŠÙ†Ù‡
        $otp = str_pad(random_int(0, 999999), 6, '0', STR_PAD_LEFT);
        $user->otp = $otp;
        $user->otp_expires_at = now()->addMinutes(10);
        $user->save();

        // Ø¥Ø±Ø³Ø§Ù„ OTP Ø¹Ø¨Ø± WhatsApp
        $apiUrl = env('WHATSAPP_API_URL');
        $apiToken = env('WHATSAPP_API_TOKEN');

        $response = Http::withToken($apiToken)->post($apiUrl . '/send-otp', [
            'phone' => $trimmedNumber, // Ø¨Ø¯ÙˆÙ† +
            'otp'   => $otp,
        ]);

        if (!$response->successful()) {
            \Log::error('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ OTP', [
                'status' => $response->status(),
                'body'   => $response->body(),
            ]);
            DB::rollBack();
            return ResponseService::errorResponse('ÙØ´Ù„ Ø¥Ø±Ø³Ø§Ù„ OTP');
        }

        // Ø¥Ø¯Ø§Ø±Ø© FCM Token Ø¥Ø°Ø§ ÙˆØµÙ„
        if (!empty($request->fcm_id)) {
            UserFcmToken::updateOrCreate(
                ['fcm_token' => $request->fcm_id],
                [
                    'user_id'       => $user->id,
                    'platform_type' => $request->platform_type,
                    'created_at'    => now(),
                    'updated_at'    => now()
                ]
            );
        }

        DB::commit();
        return ResponseService::successResponse('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ù…Ø² Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ù„Ù‰ Ø±Ù‚Ù… Ù‡Ø§ØªÙÙƒ', [
            'number' => $user->mobile
        ]);

    } catch (Throwable $th) {
        DB::rollBack();
        ResponseService::logErrorResponse($th, "OTP Controller -> getOtp");
        return ResponseService::errorResponse();
    }
}




/////////////////////////////////////////////////
public function getOtpnumberold(Request $request)
{
    try {
        $validator = Validator::make($request->all(), [
            'number'        => 'required|string',
            'fcm_id'        => 'nullable|string',
            'platform_type' => 'nullable|in:android,ios',
        ]);
        if ($validator->fails()) {
            return ResponseService::validationError($validator->errors()->first());
        }

        $requestNumber = $request->number;
        $trimmedNumber = ltrim($requestNumber, '+');
        $toNumber = "+" . $trimmedNumber;

        if (empty($trimmedNumber)) {
            return ResponseService::errorResponse(__('the number is false'));
        }

        // OTP logic
        $existingOtp = NumberOtp::where('number', $toNumber)
            ->where('expire_at', '>', now())
            ->first();

        $otp = $existingOtp
            ? $existingOtp->otp
            : str_pad(random_int(0, 999999), 6, '0', STR_PAD_LEFT);

        $expireAt = now()->addMinutes(10);

        NumberOtp::updateOrCreate(
            ['number' => $toNumber],
            ['otp' => $otp, 'expire_at' => $expireAt]
        );

        DB::beginTransaction();

        // User handling
        $user = User::where('mobile', $toNumber)->withTrashed()->first();

        if ($user && $user->trashed()) {
            return ResponseService::errorResponse(
                __('Your account has been deactivated.'),
                null,
                config('constants.RESPONSE_CODE.DEACTIVATED_ACCOUNT')
            );
        }

        if (!$user) {
            $user = User::create([
                'mobile'  => $toNumber,
                'name'    => $request->name ?? 'User ' . substr($toNumber, -4),
                'profile' => null,
            ]);
            $user->assignRole('User');
        }

        Auth::login($user);
        $auth = User::find($user->id);

        SocialLogin::updateOrCreate([
            'type'    => 'phone',
            'user_id' => $user->id
        ], [
            'firebase_id' => $request->firebase_id ?? null,
        ]);

        // ðŸ”¥ ØªØ®Ø²ÙŠÙ† FCM Token Ø¥Ù† ÙˆÙØ¬Ø¯
        if (!empty($request->fcm_id)) {
            UserFcmToken::updateOrCreate(
                ['fcm_token' => $request->fcm_id],
                [
                    'user_id'       => $auth->id,
                    'platform_type' => $request->platform_type,
                    'created_at'    => Carbon::now(),
                    'updated_at'    => Carbon::now()
                ]
            );
        }

        // Generate API Token
        $token = $auth->createToken($auth->name ?? '')->plainTextToken;

        DB::commit();

        // Send OTP (optional)
        $apiUrl = env('WHATSAPP_API_URL');
        $apiToken = env('WHATSAPP_API_TOKEN');
        $response = Http::withToken($apiToken)->post($apiUrl . '/send-otp', [
            'phone' => $toNumber,
            'otp'   => $otp,
        ]);

        if (!$response->successful()) {
            \Log::error('fail OTP', [
                'status' => $response->status(),
                'body' => $response->body(),
            ]);
            return ResponseService::errorResponse(__('fail OTP ..whatsapp'));
        }

        return ResponseService::successResponse(__('User logged-in successfully'), $auth, ['token' => $token]);

    } catch (Throwable $th) {
        DB::rollBack();
        ResponseService::logErrorResponse($th, "OTP Controller -> getOtp");
        return ResponseService::errorResponse();
    }
}



/////////////////////////////////////////////////////////////////
public function getOtpnumberoldold(Request $request)
{
    try {
        $validator = Validator::make($request->all(), [
            'number' => 'required|string'
        ]);
        if ($validator->fails()) {
            return ResponseService::validationError($validator->errors()->first());
        }

        $requestNumber = $request->number;
        $trimmedNumber = ltrim($requestNumber, '+');
        $toNumber = "+" . $trimmedNumber;

        if (empty($trimmedNumber)) {
            return ResponseService::errorResponse('The number is false');
        }

        $existingOtp = NumberOtp::where('number', $toNumber)
            ->where('expire_at', '>', now())
            ->first();

        $otp = $existingOtp
            ? $existingOtp->otp
            : str_pad(random_int(0, 999999), 6, '0', STR_PAD_LEFT);

        $expireAt = now()->addMinutes(10);

        NumberOtp::updateOrCreate(
            ['number' => $toNumber],
            ['otp' => $otp, 'expire_at' => $expireAt]
        );

        // Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† env Ø¨Ø¯ÙˆÙ† Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù‚ØªØ¨Ø§Ø³
        $apiUrl = env('WHATSAPP_API_URL'); // Ù…Ø«Ø§Ù„: http://138.68.85.140:3000
        $apiToken = env('WHATSAPP_API_TOKEN');

        // Ø¥Ø±Ø³Ø§Ù„ OTP
        $response = Http::withToken($apiToken)
                        ->post(rtrim($apiUrl, '/') . '/send-otp', [
                            'phone' => $toNumber,
                            'otp' => $otp,
                        ]);

        if (!$response->successful()) {
            \Log::error('fail OTP', [
                'status' => $response->status(),
                'body' => $response->body(),
            ]);
            return ResponseService::errorResponse('Fail OTP ..whatsapp');
        }

        return ResponseService::successResponse('OTP sent successfully');

    } catch (Throwable $th) {
        ResponseService::logErrorResponse($th, "OTP Controller -> getOtp");
        return ResponseService::errorResponse();
    }
}

public function verifyOtp(Request $request)
{
    try {
        $validator = Validator::make($request->all(), [
            'identifier'    => 'required|string', // Ø¥ÙŠÙ…ÙŠÙ„ Ø£Ùˆ Ø±Ù‚Ù… Ù‡Ø§ØªÙ
            'otp'           => 'required|numeric|digits:6',
            'fcm_id'        => 'nullable|string',
            'platform_type' => 'nullable|in:android,ios',
        ]);

        if ($validator->fails()) {
            return ResponseService::validationError($validator->errors()->first());
        }

        $identifier = $request->input('identifier');
        $otpInput   = $request->input('otp');

        if (preg_match('/^\+?\d+$/', $identifier)) {
            // Ø§Ù„Ø±Ù‚Ù… Ù‡Ø§ØªÙ
            $trimmedNumber = ltrim($identifier, '+');
            $user = User::where('mobile', $trimmedNumber)->first();

            if (!$user || is_null($user->otp)) {
                return ResponseService::errorResponse('OTP not generated yet. Please request a new OTP.');
            }

            if (now()->isAfter($user->otp_expires_at)) {
                $user->otp = null;
                $user->otp_expires_at = null;
                $user->otp_attempts = 0;
                $user->save();
                return ResponseService::validationError('OTP has expired.');
            }

            if (($user->otp_attempts ?? 0) >= 3) {
                $user->otp = null;
                $user->otp_expires_at = null;
                $user->otp_attempts = 0;
                $user->save();
                return ResponseService::validationError('OTP expired after 3 failed attempts.');
            }

            if ($user->otp != $otpInput) {
                $user->otp_attempts = ($user->otp_attempts ?? 0) + 1;
                $user->save();
                return ResponseService::validationError('Invalid OTP.');
            }

            // OTP ØµØ­ÙŠØ­
            $user->otp = null;
            $user->otp_expires_at = null;
            $user->otp_attempts = 0;
            $user->is_verified = 1;
            $user->save();

        } else {
            // Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
            $user = User::where('email', $identifier)->first();

            if (!$user) {
                return ResponseService::errorResponse('User not found.');
            }

            if (is_null($user->otp)) {
                return ResponseService::errorResponse('OTP not generated yet. Please request a new OTP.');
            }

            if (now()->isAfter($user->otp_expires_at)) {
                $user->otp = null;
                $user->otp_expires_at = null;
                $user->otp_attempts = 0;
                $user->save();
                return ResponseService::validationError('OTP has expired.');
            }

            if (($user->otp_attempts ?? 0) >= 3) {
                $user->otp = null;
                $user->otp_expires_at = null;
                $user->otp_attempts = 0;
                $user->save();
                return ResponseService::validationError('OTP expired after 3 failed attempts.');
            }

            if ($user->otp != $otpInput) {
                $user->otp_attempts = ($user->otp_attempts ?? 0) + 1;
                $user->save();
                return ResponseService::validationError('Invalid OTP.');
            }

            $user->otp = null;
            $user->otp_expires_at = null;
            $user->otp_attempts = 0;
            $user->is_verified = 1;
            $user->save();
        }

        // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        Auth::login($user);
        $auth = User::find(Auth::id());
        $token = $auth->createToken($auth->name ?? '')->plainTextToken;

        // ØªØ®Ø²ÙŠÙ† FCM ID Ø¥Ø°Ø§ ÙˆØµÙ„
        if (!empty($request->fcm_id)) {
            UserFcmToken::updateOrCreate(
                ['fcm_token' => $request->fcm_id],
                [
                    'user_id'       => $auth->id,
                    'platform_type' => $request->platform_type,
                    'created_at'    => now(),
                    'updated_at'    => now()
                ]
            );
        }

        return ResponseService::successResponse(
            'User logged-in successfully',
            $auth,
            ['token' => $token]
        );

    } catch (Throwable $th) {
        ResponseService::logErrorResponse($th, "OTP Controller -> verifyOtp");
        return ResponseService::errorResponse();
    }
}


    public function applyJob(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'item_id'    => 'required',
            'full_name'  => 'required|string|max:255',
            'email'      => 'required|email|max:255',
            'mobile'     => 'required|string|max:20',
            'resume'     => 'nullable|file|mimes:pdf,doc,docx|max:7168',
        ]);

        if ($validator->fails()) {
            return ResponseService::validationError($validator->errors()->first());
        }

        try {
            $userId = Auth::id();
            $post = Item::approved()->notOwner()->findOrFail($request->item_id);
            $alreadyApplied = JobApplication::where('item_id', $request->item_id)
            ->where('user_id', $userId)
            ->exists();

            if ($alreadyApplied) {
                return ResponseService::validationError(__('You have already applied for this job.'));
            }
            $resumePath = null;
            if ($request->hasFile('resume')) {
                $resumePath = FileService::upload($request->resume, 'job_resume');
            }

            $application = JobApplication::create([
                'item_id'     => $post->id,
                'user_id'     => Auth::user()->id,
                'recruiter_id' => $post->user_id,
                'full_name'   => $request->full_name,
                'email'       => $request->email,
                'mobile'      => $request->mobile,
                'resume' => $resumePath
            ]);

            $user_token = UserFcmToken::where('user_id', $post->user_id)->pluck('fcm_token')->toArray();
if (!empty($user_token)) {
    $title = [
        'en' => 'New Job Application',
        'ar' => 'Ø§Ù„ØªÙ‚Ø¯Ù… Ù„ÙˆØ¸ÙŠÙØ©' 
    ];

    $message = [
        'en' => $request->full_name . ' applied for your job post: ' . $post->name,
        'ar' => $request->full_name . ' ØªÙ‚Ø¯Ù‘Ù… Ù„ÙˆØ¸ÙŠÙØªÙƒ: ' . $post->name
    ];

    NotificationService::sendFcmNotification(
        $user_token,
        $title,
        $message,
        'job-application',
        ['item_id' => $post->id]
    );
}

            return ResponseService::successResponse(__('Application submitted successfully.'), $application);

        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> applyJob");
            return ResponseService::errorResponse();
        }
    }


    public function recruiterApplications(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'item_id' => 'nullable|integer',
            'page' => 'nullable|integer'
        ]);

        if ($validator->fails()) {
            return ResponseService::validationError($validator->errors()->first());
        }
        try {
            $user = Auth::user();

            $applications = JobApplication::where('recruiter_id', $user->id)
            ->with('user:id,name,email', 'item:id,name');
            if (!empty($request->item_id)) {
                $applications->where('item_id', $request->item_id);
            }

            $applications = $applications->latest()->paginate();
            return ResponseService::successResponse(__('Recruiter applications fetched'), $applications);

        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> recruiterApplications");
            return ResponseService::errorResponse();
        }
    }
    public function myJobApplications(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'item_id' => 'nullable|integer',
            'page' => 'nullable|integer'
        ]);

        if ($validator->fails()) {
            return ResponseService::validationError($validator->errors()->first());
        }
        try {
            $user = Auth::user();

            $applications = JobApplication::where('user_id', $user->id);

            if (!empty($request->item_id)) {
                $applications->where('item_id', $request->item_id);
            }

            $applications = $applications->with([
                    'item:id,name,user_id',
                    'recruiter:id,name,email',
                ])
            ->latest()
            ->paginate();

            return ResponseService::successResponse(__('Your job applications fetched'), $applications);

        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> myJobApplications");
            return ResponseService::errorResponse();
        }
    }
        public function updateJobStatus(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'job_id' => 'required|exists:job_applications,id',
            'status' => 'required|in:accepted,rejected',
        ]);

        if ($validator->fails()) {
            return ResponseService::validationError($validator->errors()->first());
        }

        try {
            $user = Auth::user();
            $application = JobApplication::with('item')->findOrFail($request->job_id);

            if ($application->recruiter_id !== $user->id) {
                return ResponseService::errorResponse(__('Unauthorized to update this job status.'), 403);
            }

            $application->update(['status' => $request->status]);

            // Optional: Notify the applicant
            $user_token = UserFcmToken::where('user_id', $application->user_id)->pluck('fcm_token')->toArray();
if (!empty($user_token)) {
    $title = [
        'en' => 'Application ' . ucfirst($request->status),
        'ar' => 'Ø·Ù„Ø¨Ùƒ ' . ($request->status === 'approved' ? 'ØªÙ…Øª Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„ÙŠÙ‡' : ($request->status === 'rejected' ? 'ØªÙ… Ø±ÙØ¶Ù‡' : $request->status))
    ];

    $message = [
        'en' => "Your application for job post has been " . $request->status,
        'ar' => "ØªÙ… " . ($request->status === 'approved' ? 'Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø© Ø¹Ù„Ù‰' : ($request->status === 'rejected' ? 'Ø±ÙØ¶' : $request->status)) . " Ø·Ù„Ø¨Ùƒ Ù„Ù„ÙˆØ¸ÙŠÙØ©"
    ];

    NotificationService::sendFcmNotification(
        $user_token,
        $title,
        $message,
        'application-status',
        ['job_id' => $application->id]
    );
}

            return ResponseService::successResponse(__('Application status updated.'), $application);

        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> updateJobStatus");
            return ResponseService::errorResponse();
        }
    }

  public function getLocationFromCoordinates(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'lat'    => 'nullable|numeric',
            'lng'    => 'nullable|numeric',
            'lang'   => 'nullable|string',
            'search' => 'nullable|string',
        ]);

        if ($validator->fails()) {
            return ResponseService::validationError($validator->errors()->first());
        }

        try {
            $lat = $request->lat;
            $lng = $request->lng;
            $lang = $request->lang ?? 'en';
            $search = $request->search;
            $placeId = $request->place_id;
            $setting = Setting::where('name', 'map_provider')->first();
            $mapProvider = $setting ? $setting->value : 'free_api';
            // ðŸ” Handle search query
            if ($search) {
                if ($mapProvider === 'google_places') {
                    $apiKey = Setting::where('name', 'place_api_key')->first()['value'] ?? null;

                    if (!$apiKey) {
                        return ResponseService::errorResponse(__('Google Maps API key not set'));
                    }

                $response = Http::get("https://maps.googleapis.com/maps/api/place/autocomplete/json", [
                        'key'   => $apiKey,
                        'input' => $search,
                        'language' => $lang,
                    ]);

                    if ($response->successful()) {
                        return ResponseService::successResponse(__('Location fetched from Google API'), $response->json());
                    } else {
                        return ResponseService::errorResponse(__('Failed to fetch from Google Maps API'));
                    }

                } else {
                $areas = Area::where('name', 'like', "%{$search}%")
                            ->with(['city.state.country'])
                            ->limit(10)
                            ->get();

                        if ($areas->isNotEmpty()) {
                            return ResponseService::successResponse(__('Matching areas found'), $areas->map(function ($area) {
                                return [
                                    'area_id'    => $area->id,
                                    'area'       => $area->name,
                                    'city_id'    => optional($area->city)->id,
                                    'city'       => optional($area->city)->name,
                                    'state'      => optional($area->city->state)->name,
                                    'country'    => optional($area->city->state->country ?? null)->name,
                                    'latitude'   => $area->latitude,
                                    'longitude'  => $area->longitude,
                                ];
                            }));
                        }

                        // Fallback to City search
                        $cities = City::where('name', 'like', "%{$search}%")
                            ->orWhereHas('state', fn($q) => $q->where('name', 'like', "%{$search}%"))
                            ->orWhereHas('state.country', fn($q) => $q->where('name', 'like', "%{$search}%"))
                            ->with(['state.country'])
                            ->limit(10)
                            ->get();

                        if ($cities->isEmpty()) {
                            return ResponseService::errorResponse(__('No matching location found'));
                        }

                        return ResponseService::successResponse(__('Matching cities found'), $cities->map(function ($city) {
                            return [
                                'city_id'   => $city->id,
                                'city'      => $city->name,
                                'state'     => optional($city->state)->name,
                                'country'   => optional($city->state->country ?? null)->name,
                                'latitude'  => $city->latitude,
                                'longitude' => $city->longitude,
                            ];
                        }));

                }
            }

            if(!empty($lat) && !empty($lng)){
                if ($mapProvider === 'google_places') {
                    $apiKey = Setting::where('name', 'place_api_key')->first()['value'] ?? null;

                    if (!$apiKey) {
                        return ResponseService::errorResponse(__('Google Maps API key not set'));
                    }

                    $response = Http::get("https://maps.googleapis.com/maps/api/geocode/json", [
                        'latlng'   => "{$lat},{$lng}",
                        'key'      => $apiKey,
                        'language' => $lang
                    ]);

                    if ($response->successful()) {
                        return ResponseService::successResponse(__('Location fetched from Google API'), $response->json());
                    } else {
                        return ResponseService::errorResponse(__('Failed to fetch from Google Maps API'));
                    }

                } else {
                    $closestCity = City::whereNotNull('latitude')
                            ->whereNotNull('longitude')
                            ->selectRaw("id, name, latitude, longitude, state_id,
                                (6371 * acos(cos(radians(?))
                                                * cos(radians(latitude))
                                                * cos(radians(longitude) - radians(?))
                                                + sin(radians(?))
                                                * sin(radians(latitude)))) AS distance", [$lat, $lng, $lat])
                            ->with(['state.country'])
                            ->orderBy('distance', 'asc')
                            ->first();

                        if (!$closestCity) {
                            return ResponseService::errorResponse(__('No nearby city found'));
                        }

                    $closestArea = Area::where('city_id', $closestCity->id)
                        ->whereNotNull('latitude')
                        ->whereNotNull('longitude')
                        ->selectRaw("id, name, latitude, longitude, city_id,
                            (6371 * acos(cos(radians(?))
                                            * cos(radians(latitude))
                                            * cos(radians(longitude) - radians(?))
                                            + sin(radians(?))
                                            * sin(radians(latitude)))) AS distance", [$lat, $lng, $lat])
                        ->orderBy('distance', 'asc')
                        ->first();

                        return ResponseService::successResponse(__('Location fetched from local database'), [
                            'city_id'     => $closestCity->id,
                            'city'        => $closestCity->name,
                            'state'       => optional($closestCity->state)->name,
                            'country'     => optional($closestCity->state->country ?? null)->name,
                            'area_id'     => optional($closestArea)->id,
                            'area'        => optional($closestArea)->name,
                            'latitude'    => $closestCity->latitude,
                            'longitude'   => $closestCity->longitude,
                        ]);
                    }
                }
            if ($placeId) {
                    if ($mapProvider === 'google_places') {
                        $apiKey = Setting::where('name', 'place_api_key')->first()['value'] ?? null;

                        if (!$apiKey) {
                            return ResponseService::errorResponse(__('Google Maps API key not set'));
                        }

                        $url = "https://maps.googleapis.com/maps/api/geocode/json?place_id={$placeId}&key={$apiKey}&language={$lang}";
                        $response = Http::get($url);

                        if ($response->successful()) {
                            return ResponseService::successResponse(__('Location fetched from place_id'), $response->json());
                        } else {
                            return ResponseService::errorResponse(__('Failed to fetch from Google Maps API using place_id'));
                        }
                    } else {
                        return ResponseService::errorResponse(__('place_id is only supported with Google Maps provider'));
                    }
            }
        } catch (Throwable $th) {
            ResponseService::logErrorResponse($th, "API Controller -> getLocationFromCoordinates");
            return ResponseService::errorResponse(__('Failed to fetch location'));
        }
    }
}

