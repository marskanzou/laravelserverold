<?php

namespace App\Http\Controllers;

use App\Http\Controllers\Controller;
use App\Models\{User, Category, Item, ItemImages, ItemCustomFieldValue, Setting};
use App\Services\{FileService, HelperService};
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Validator;
use Illuminate\Support\Str;
use PhpOffice\PhpSpreadsheet\IOFactory;
use ZipArchive;
use Illuminate\Support\Facades\File;

class CsvUploadController extends Controller
{
    /**
     * عرض صفحة رفع الملف
     */
    public function index()
    {
        return view('csvupload.upload');
    }

   /**
     * رفع ملف Excel + ملف ZIP للصور (في مجلدات فرعية)
     */
    public function upload(Request $request)
    {
        $validator = Validator::make($request->all(), [
            'excel_file' => 'required|file|mimes:xlsx,csv,xls',
            'images_zip' => 'required|file|mimes:zip|max:51200', // حتى 50MB
            'selected_user_email' => 'required|email',
        ]);

        if ($validator->fails()) {
            return back()->withErrors($validator)->withInput();
        }

        $excel = $request->file('excel_file');
        $zipFile = $request->file('images_zip');
        $selectedEmail = $request->input('selected_user_email');

        $user = User::where('email', $selectedEmail)->first();
        if (!$user) {
            return back()->withErrors(['selected_user_email' => "User not found with email: {$selectedEmail}"]);
        }

        // مسار مؤقت لاستخراج الصور
        $extractPath = storage_path('app/public/tmp_images/' . uniqid('zip_', true));
        File::makeDirectory($extractPath, 0755, true);

        // فك ضغط ملف الصور
        $zip = new ZipArchive;
        if ($zip->open($zipFile->getRealPath()) === TRUE) {
            $zip->extractTo($extractPath);
            $zip->close();
        } else {
            return back()->withErrors(['images_zip' => 'فشل في فك ضغط ملف الصور.']);
        }

        try {
            $spreadsheet = IOFactory::load($excel->getRealPath());
            $rows = $spreadsheet->getActiveSheet()->toArray();

            if (empty($rows) || count($rows) < 2) {
                File::deleteDirectory($extractPath);
                return back()->withErrors(['excel_file' => 'Excel file is empty or missing data rows.']);
            }

            $header = array_map('trim', array_shift($rows));
            $success = 0;
            $fail = 0;
            $errors = [];

            DB::beginTransaction();

            foreach ($rows as $index => $row) {
                if (empty(array_filter($row))) continue;

                $data = array_combine($header, array_pad($row, count($header), null));

                try {
                    // تحقق من صحة البيانات الأساسية
                    $rowValidator = Validator::make($data, [
                        'name'        => 'required',
                        'category_id' => 'required|integer',
                        'description' => 'required',
                        'latitude'    => 'required',
                        'longitude'   => 'required',
                        'address'     => 'required',
                        'country'     => 'required',
                        'city'        => 'required',
                        'slug'        => 'nullable|regex:/^[a-z0-9-]+$/',
                    ]);

                    if ($rowValidator->fails()) {
                        $fail++;
                        $errors[$index + 2] = $rowValidator->errors()->first();
                        continue;
                    }

                    $category = Category::find($data['category_id']);
                    if (!$category) {
                        $fail++;
                        $errors[$index + 2] = "Category not found: {$data['category_id']}";
                        continue;
                    }

                    $isJobCategory   = (bool) $category->is_job_category;
                    $isPriceOptional = (bool) $category->price_optional;

                    // تحقق من السعر أو الراتب
if ($isJobCategory || $isPriceOptional) {
                        $priceValidator = Validator::make($data, [
                            'min_salary' => 'nullable|numeric|min:0',
                            'max_salary' => 'nullable|numeric|gte:min_salary',
                        ]);
                    } else {
                        $priceValidator = Validator::make($data, [
                            'price' => 'required|numeric|min:0',
                        ]);
                    }

                    if ($priceValidator->fails()) {
                        $fail++;
                        $errors[$index + 2] = $priceValidator->errors()->first();
                        continue;
                    }

                    // إعداد بيانات الإعلان
                    $status = Setting::where('name', 'auto_approve_item')->value('value') == 1 ? 'approved' : 'review';
                    $slug = $data['slug'] ?? Str::slug($data['name']);
                    $uniqueSlug = HelperService::generateUniqueSlug(new Item(), $slug);

                    $itemData = [
                        'name'        => $data['name'],
                        'category_id' => $data['category_id'],
                        'description' => $data['description'],
                        'latitude'    => $data['latitude'],
                        'longitude'   => $data['longitude'],
                        'address'     => $data['address'],
                        'country'     => $data['country'],
                        'state'       => $data['state'] ?? '',
                        'city'        => $data['city'],
                        'slug'        => $uniqueSlug,
                        'status'      => $status,
                        'active'      => 'deactive',
                        'user_id'     => $user->id,
                        'contact'     => $data['contact'] ?? null,
                        'show_only_to_premium' => $data['show_only_to_premium'] ?? 0,
                    ];

                    if ($isJobCategory || $isPriceOptional) {
                        $itemData['min_salary'] = $data['min_salary'] ?? null;
                        $itemData['max_salary'] = $data['max_salary'] ?? null;
                    } else {
                        $itemData['price'] = $data['price'] ?? null;
                    }

                    $item = Item::create($itemData);

                    // ✅ الصورة الرئيسية (image)
                    if (!empty($data['image'])) {
                        $mainPath = $extractPath . '/' . trim($data['image']);
                        if (file_exists($mainPath)) {
                            $item->update([
                                'image' => FileService::compressAndUpload(new \Illuminate\Http\File($mainPath), 'item_images')
                            ]);
                        }
                    }

                    // ✅ صور المعرض (gallery_images كـ نص مفصول بفواصل)
                    if (!empty($data['gallery_images'])) {
                        $paths = array_map('trim', explode(',', $data['gallery_images']));
                        $galleryImages = [];

                        foreach ($paths as $relativePath) {
                            if (!$relativePath) continue;
                            $fullPath = $extractPath . '/' . $relativePath;
                            if (file_exists($fullPath)) {
                                $galleryImages[] = [
                                    'image'      => FileService::compressAndUpload(new \Illuminate\Http\File($fullPath), 'item_images'),
                                    'item_id'    => $item->id,
                                    'created_at' => now(),
                                    'updated_at' => now(),
                                ];
                            }
                        }

                        if (!empty($galleryImages)) {
                            ItemImages::insert($galleryImages);
                        }
                    }

                    // ✅ الحقول المخصصة
if (!empty($data['custom_fields'])) {
                        $customFields = json_decode($data['custom_fields'], true);
                        $itemCustomFieldValues = [];

                        if (is_array($customFields)) {
                            foreach ($customFields as $key => $value) {
                                $itemCustomFieldValues[] = [
                                    'item_id'         => $item->id,
                                    'custom_field_id' => $key,
                                    'value'           => json_encode($value, JSON_THROW_ON_ERROR),
                                    'created_at'      => now(),
                                    'updated_at'      => now(),
                                ];
                            }
                        }

                        if (!empty($itemCustomFieldValues)) {
                            ItemCustomFieldValue::insert($itemCustomFieldValues);
                        }
                    }

                    $success++;
                } catch (\Throwable $th) {
                    $fail++;
                    $errors[$index + 2] = $th->getMessage();
                }
            }

            DB::commit();

            File::deleteDirectory($extractPath);

            return back()
                ->with('success', "Excel uploaded successfully. Success: {$success}, Failed: {$fail}")
                ->with('errors_list', $errors);

        } catch (\Throwable $th) {
            DB::rollBack();
            File::deleteDirectory($extractPath);
            return back()->withErrors(['excel_file' => 'Excel processing failed: ' . $th->getMessage()]);
        }
    }
}
